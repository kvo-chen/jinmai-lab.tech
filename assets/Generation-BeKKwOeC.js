import{u as ue,d as pe,r as m,l as B,t as i,g as xe,p as he,e as K,v as W,j as e,m as E,T as be,s as fe,f as ye}from"./index-DW-f9EnK.js";function je(){const{isDark:l}=ue(),q=pe(),[p,C]=m.useState(""),[J,T]=m.useState(!1),[k,v]=m.useState([]),[A,D]=m.useState(""),[ae,L]=m.useState(null),[b,O]=m.useState(""),[V,ie]=m.useState([]),[Y,Z]=m.useState(!1),[Q,ne]=m.useState("https://ark-project.tos-cn-beijing.ivolces.com/images/view.jpeg"),[X,oe]=m.useState(B.getCurrentModel().id),F=m.useRef(null),M=m.useRef(null),ee=m.useRef(null),[te,ce]=m.useState(null);m.useEffect(()=>{try{const t=new URLSearchParams(q.search),s=t.get("prompt")||"",r=t.get("image")||"",a=t.get("autostart")||"",c=t.get("saveToTutorialId")||"";if(s&&C(s),r&&(v([{script:s?`根据提示生成：${s}`:"教程封面生成视频",image:r,video:""}]),a&&setTimeout(()=>se(0),100)),c){const o=Number(c);Number.isNaN(o)||ce(o)}}catch{}},[q.search]);const se=async t=>{var a,c,o,n,g,x,_,f,y,R,z,$,S;const s=k[t];if(!s||!s.image)return;if(s.image.startsWith("data:")){i.error("首帧为本地数据，需使用可公网访问的图片URL");return}const r=`${p}  --resolution 720p  --duration 5 --camerafixed false`;v(u=>u.map((I,d)=>d===t?{...I,video:"生成中..."}:I));try{const u=await xe({model:"doubao-seedance-1-0-pro-250528",content:[{type:"text",text:r},{type:"image_url",image_url:{url:s.image}}]});if(!u.ok||!((a=u.data)!=null&&a.id)){const h=(u==null?void 0:u.error)||((o=(c=u==null?void 0:u.data)==null?void 0:c.error)==null?void 0:o.code)||"UNKNOWN",j=(u==null?void 0:u.error)==="CONFIG_MISSING"?"服务端未配置 DOUBAO_API_KEY，请在 .env.local 设置后重启":`创建视频任务失败：${h}`;i.error(j),v(w=>w.map((N,H)=>H===t?{...N,video:`视频生成失败：${h}`}:N));return}const I=u.data.id,d=await he(I,{intervalMs:1e4,timeoutMs:6e5});if(!d.ok){const h=(d==null?void 0:d.error)||((g=(n=d==null?void 0:d.data)==null?void 0:n.error)==null?void 0:g.code)||"UNKNOWN",j=(d==null?void 0:d.error)==="CONFIG_MISSING"?"服务端未配置 DOUBAO_API_KEY，请在 .env.local 设置后重启":`查询视频任务失败：${h}`;i.error(j),v(w=>w.map((N,H)=>H===t?{...N,video:`视频生成失败：${h}`}:N));return}const G=(x=d.data)==null?void 0:x.status,U=((f=(_=d.data)==null?void 0:_.content)==null?void 0:f.video_url)||"";if(G==="succeeded"&&U){v(h=>h.map((j,w)=>w===t?{...j,video:U}:j)),i.success("视频生成完成");try{if(te&&U){const h=localStorage.getItem("TUTORIAL_VIDEO_OVERRIDES"),j=h?JSON.parse(h):{};j[te]=U,localStorage.setItem("TUTORIAL_VIDEO_OVERRIDES",JSON.stringify(j)),i.success("已写入教程视频覆盖")}}catch{}}else{const h=((R=(y=d.data)==null?void 0:y.error)==null?void 0:R.code)||(($=(z=d.data)==null?void 0:z.error)==null?void 0:$.message)||((S=d.data)==null?void 0:S.status)||"UNKNOWN";i.error(`视频生成失败：${h}`),v(j=>j.map((w,N)=>N===t?{...w,video:`视频生成失败：${h}`}:w))}}catch(u){K.logError(u instanceof Error?u:"SERVER_ERROR",{scope:"generation-video",prompt:p}),i.error("视频生成异常"),v(I=>I.map((d,G)=>G===t?{...d,video:"视频生成失败"}:d))}},re=async t=>{const s=(t??p).trim();if(!s){i.warning("请输入提示词");return}T(!0);try{const r=await fe({prompt:s,n:3,size:"1024x1024",response_format:"url"});if(!r.ok){K.logError(r.error||"SERVER_ERROR",{scope:"generation",prompt:p}),i.error("生成失败，已回退为占位图"),v([{script:"占位方案A",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20A",video:"方案A视频占位"},{script:"占位方案B",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20B",video:"方案B视频占位"},{script:"占位方案C",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20C",video:"方案C视频占位"}]),T(!1);return}const a=r.data,c=a&&(a.data||a.images||[]);if(!c.length){i.info("接口无返回内容，已提供占位图"),v([{script:"占位方案A",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20A",video:"方案A视频占位"},{script:"占位方案B",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20B",video:"方案B视频占位"},{script:"占位方案C",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20C",video:"方案C视频占位"}]),T(!1);return}const o=c.map((n,g)=>{const x=n.url?n.url:n.b64_json?`data:image/png;base64,${n.b64_json}`:"";return{script:`方案${String.fromCharCode(65+g)}脚本`,image:x,video:""}});v(o),i.success("生成完成")}catch(r){K.logError(r instanceof Error?r:"SERVER_ERROR",{scope:"generation",prompt:p}),i.error("生成异常，已回退为占位图"),v([{script:"占位方案A",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20A",video:"方案A视频占位"},{script:"占位方案B",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20B",video:"方案B视频占位"},{script:"占位方案C",image:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20design%20C",video:"方案C视频占位"}])}finally{T(!1)}};m.useEffect(()=>{if(k.length===0){const t=p.trim()||"天津文化设计灵感";p.trim()||C(t),re(t),setTimeout(()=>P(t),300)}},[]);const le=async t=>{const s=k[t];if(!(s!=null&&s.script)){i.warning("暂无脚本可朗读");return}try{const r=await W.synthesize(s.script,{format:"mp3"});D(r.audioUrl),L(t)}catch(r){i.error((r==null?void 0:r.message)||"朗读失败")}},P=async t=>{const s=(t??p).trim();if(!s){i.warning("请输入提示词");return}Z(!0),O("");try{B.setCurrentModel(X);const r=B.generateCreativeDirections(s);ie(r);const a="请用中文分点回答，去除所有 Markdown 标题或装饰符（如###、####、** 等），每点保持简短清晰。",c=(s.match(/[A-Za-z]/g)||[]).length,o=(s.match(/[\u4e00-\u9fa5]/g)||[]).length,g=c>o&&c>0?s:`${a}

${s}`,x=await B.generateResponse(g,{onDelta:y=>O(R=>R+y)});O(y=>x||y);const _=x||b||s,f=await W.synthesize(_,{format:"mp3"});D(f.audioUrl),L(null)}catch(r){i.error((r==null?void 0:r.message)||"优化或朗读失败")}finally{Z(!1)}},de=async()=>{var s,r,a,c,o;const t=String(Q||"").trim();if(!t){i.warning("请填写可公网访问的图片URL");return}try{const n=await ye.chatCompletions({messages:[{role:"user",content:[{type:"image_url",image_url:{url:t}},{type:"text",text:"图片主要讲了什么?"}]}],max_tokens:512});if(!(n!=null&&n.ok)){const x=(n==null?void 0:n.error)||"SERVER_ERROR";i.error(`调用失败：${x}`);return}const g=((c=(a=(r=(s=n==null?void 0:n.data)==null?void 0:s.choices)==null?void 0:r[0])==null?void 0:a.message)==null?void 0:c.content)||"";O(g||"（无返回内容）"),(o=M.current)==null||o.scrollIntoView({behavior:"smooth",block:"start"}),i.success("豆包多模态问答完成")}catch(n){i.error((n==null?void 0:n.message)||"豆包调用失败，请检查服务端环境变量或网络")}},ge=t=>{const s=String(t||"").split(/\r?\n/),r=[];let a=null;for(const c of s){let o=c.trim();if(o=o.replace(/^#{1,6}\s*/,""),o=o.replace(/^```+\s*/,""),o=o.replace(/^>+\s*/,""),!o)continue;const n=o.match(/^(\d+)\)\s*(.+?)：/)||o.match(/^([一二三四五六七八九十]+)\)\s*(.+?)：/);if(n){a&&r.push(a),a={title:n[2],items:[]};continue}a||(a={title:"说明",items:[]});const g=o.replace(/^[-•]\s*/,"");a.items.push(g)}return a&&r.push(a),r},me=t=>{const s=a=>{const c=a||"";return c.includes("诊断")?"search":c.includes("优化")?"magic":c.includes("步骤")?"list-check":c.includes("参考")||c.includes("风格")?"book-open":"pen-nib"},r=ge(t);return r.length===0?e.jsx("pre",{className:`${l?"bg-gray-800/80 text-gray-100 ring-1 ring-gray-700":"bg-white/80 text-gray-800 ring-1 ring-gray-200"} whitespace-pre-wrap break-words rounded-2xl p-5 leading-relaxed shadow-md backdrop-blur-sm border border-white/40 dark:border-gray-700/40 min-h-24`,children:t}):e.jsx("div",{className:"grid gap-4 md:gap-6",children:r.map((a,c)=>e.jsxs("div",{className:`${l?"bg-gray-900/50 ring-1 ring-gray-700":"bg-white/60 ring-1 ring-gray-200"} rounded-2xl p-5 shadow-lg backdrop-blur-sm border border-white/40 dark:border-gray-700/40`,children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("i",{className:`fas fa-${s(a.title)} mr-2 text-blue-600`}),e.jsx("div",{className:"font-semibold tracking-wide",children:a.title})]})}),e.jsx("div",{className:"h-px w-full bg-gradient-to-r from-indigo-500 via-fuchsia-500 to-cyan-500 mb-3 opacity-60"}),e.jsx("ul",{className:"grid md:grid-cols-2 gap-x-6 gap-y-2",children:a.items.map((o,n)=>{const g=String(o||""),x=/^#{1,6}\s*\d+\)\s*/.test(g)||/^#{1,6}\s*[一二三四五六七八九十]+\)\s*/.test(g),_=g.replace(/^#{1,6}\s*\d+\)\s*/,"").replace(/^#{1,6}\s*[一二三四五六七八九十]+\)\s*/,""),f=g.match(/^\*\*(.+?)\*\*：?(.*)$/),y=!!f,R=y&&(f==null?void 0:f[1])||"",z=y&&(f==null?void 0:f[2])||"",$=!y&&!x?g.match(/^([^：:]+)[:：]\s*(.+)$/):null,S=!y&&!x?g.match(/^(\d+|[一二三四五六七八九十]+)[\.、]\s*(.+)$/):null;return e.jsx("li",{className:x?"md:col-span-2 flex items-center py-1":"flex items-start py-1",children:x?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-angle-right mr-2 text-blue-600"}),e.jsx("span",{className:`${l?"text-gray-100":"text-gray-800"} text-sm font-semibold tracking-wide`,children:_})]}):y?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 ring-1 ring-blue-200 mr-2 dark:bg-blue-900/20 dark:text-blue-300 dark:ring-blue-800",children:R}),e.jsx("span",{className:`${l?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:z})]}):$?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 ring-1 ring-blue-200 mr-2 dark:bg-blue-900/20 dark:text-blue-300 dark:ring-blue-800",children:$[1]}),e.jsx("span",{className:`${l?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:$[2]})]}):S?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 ring-1 ring-gray-300 mr-2 dark:bg-gray-700 dark:text-gray-200 dark:ring-gray-600",children:S[1]}),e.jsx("span",{className:`${l?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:S[2]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"mt-1 mr-2 h-1.5 w-1.5 rounded-full bg-gradient-to-r from-indigo-500 to-fuchsia-500"}),e.jsx("span",{className:`${l?"text-gray-200":"text-gray-700"} text-sm md:text-base leading-relaxed md:leading-7 break-words max-w-[68ch]`,children:g})]})},n)})})]},c))})};return m.useEffect(()=>{var t;(V.length>0||b)&&((t=M.current)==null||t.scrollIntoView({behavior:"smooth",block:"start"}))},[V.length,b]),m.useEffect(()=>{var t;k.length>0&&((t=ee.current)==null||t.scrollIntoView({behavior:"smooth",block:"start"}))},[k.length]),e.jsxs("main",{className:"container mx-auto px-4 py-10",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"AI生成引擎"}),e.jsxs("div",{className:`${l?"bg-gray-800":"bg-white"} rounded-2xl shadow-md p-6 mb-6`,children:[e.jsx("label",{htmlFor:"prompt-input",className:"mb-2 block",children:"Midjourney风格提示"}),e.jsx("input",{id:"prompt-input",name:"prompt",ref:F,value:p,onChange:t=>C(t.target.value),"aria-label":"请输入提示词",className:`${l?"bg-gray-700 text-white focus:ring-offset-gray-800":"bg-gray-50 text-gray-900"} w-full px-4 py-3 rounded-lg border focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2`}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx(E.button,{whileHover:{scale:1.03},type:"button",onClick:()=>re(),className:"bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",disabled:J,children:"生成"}),e.jsx(E.button,{whileHover:{scale:1.03},type:"button",onClick:()=>P(),className:"bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed",disabled:Y,children:"优化并朗读"}),e.jsxs("select",{"aria-label":"选择模型",value:X,onChange:t=>oe(t.target.value),className:`${l?"bg-gray-700 text-white":"bg-gray-50 text-gray-900"} px-3 py-2 rounded-lg border`,children:[e.jsx("option",{value:"kimi",children:"Kimi"}),e.jsx("option",{value:"doubao",children:"豆包"})]})]}),e.jsxs("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-3 gap-2 items-center",children:[e.jsx("input",{value:Q,onChange:t=>ne(t.target.value),placeholder:"填写可公网访问的图片URL（用于豆包图片问答）",className:`${l?"bg-gray-700 text-white":"bg-gray-50 text-gray-900"} w-full px-4 py-2 rounded-lg border`}),e.jsx(E.button,{whileHover:{scale:1.03},type:"button",onClick:de,className:"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2",children:"豆包图片问答"})]}),J&&e.jsx("div",{role:"status","aria-live":"polite",className:"mt-2 text-sm",children:"生成中，预期小于30秒"}),e.jsxs("div",{ref:M,role:"region","aria-labelledby":"ai-copy-title",className:`mt-4 rounded-2xl p-4 ${l?"bg-gray-800":"bg-white"} block`,children:[e.jsx("h2",{id:"ai-copy-title",className:"font-medium mb-2",children:"AI文案"}),V.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:V.map((t,s)=>e.jsx("button",{onClick:()=>{var a;const r=p?`${p} ${t}`:t;C(r),(a=F.current)==null||a.scrollIntoView({behavior:"smooth",block:"center"}),P(r)},className:`text-xs px-3 py-1 rounded-full border transition-colors ${l?"border-gray-600 text-gray-300 hover:border-gray-500":"border-gray-300 text-gray-700 hover:border-gray-400"}`,children:t},s))}),e.jsx("div",{"aria-live":"polite",className:"text-sm",children:me(b)}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{type:"button","aria-label":"朗读文案",onClick:async()=>{const t=b.trim()?b:p.trim();if(!t){i.warning("请先生成文案或填写提示");return}try{const s=await W.synthesize(t,{format:"mp3"});D(s.audioUrl),L(null)}catch(s){i.error((s==null?void 0:s.message)||"朗读失败")}},className:"text-sm px-3 py-1 rounded-md bg-green-600 text-white",disabled:!b.trim()&&!p.trim(),children:"朗读"}),e.jsx("button",{type:"button","aria-label":"复制文案",onClick:async()=>{const t=b.trim()?b:p.trim();if(!t){i.warning("暂无可复制内容");return}try{await navigator.clipboard.writeText(t),i.success("文案已复制")}catch{i.error("复制失败")}},className:`${l?"bg-gray-700 text-white":"bg-gray-100 text-gray-900"} text-sm px-3 py-1 rounded-md`,children:"复制文案"}),e.jsx("button",{type:"button","aria-label":"应用到提示词",onClick:()=>{var s;const t=b.trim()?b:p.trim();if(!t){i.warning("暂无可应用内容");return}C(t),(s=F.current)==null||s.scrollIntoView({behavior:"smooth",block:"center"})},className:`${l?"bg-gray-700 text-white":"bg-gray-100 text-gray-900"} text-sm px-3 py-1 rounded-md`,children:"应用到提示词"})]}),Y&&e.jsx("div",{role:"status","aria-live":"polite",className:`${l?"text-gray-500":"text-gray-400"} text-xs mt-2`,children:"生成中…"}),A&&e.jsx("audio",{controls:!0,src:A,className:"mt-2 w-full"})]})]}),e.jsx("div",{ref:ee,className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:k.map((t,s)=>e.jsxs("div",{className:`${l?"bg-gray-800":"bg-white"} rounded-2xl shadow-md p-4`,children:[e.jsx(be,{src:t.image,alt:"variant",className:"w-full h-40 object-cover rounded-lg mb-3",ratio:"landscape"}),e.jsx("div",{className:"text-sm mb-2",children:t.script}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx(E.button,{whileHover:{scale:1.03},onClick:()=>le(s),className:"bg-green-600 text-white px-3 py-1 rounded-md",children:"朗读脚本"}),ae===s&&A&&e.jsx("audio",{controls:!0,src:A,className:"mt-1 w-full"})]}),t.video&&(t.video.startsWith("http")?e.jsxs("div",{className:`${l?"bg-gray-700":"bg-gray-50"} rounded-lg p-3 text-sm`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("a",{href:t.video,target:"_blank",rel:"noreferrer",className:"text-blue-600",children:"打开视频"}),e.jsx("button",{className:`text-xs px-2 py-1 rounded ${l?"bg-gray-600 text-white":"bg-white ring-1 ring-gray-200"}`,onClick:async()=>{try{await navigator.clipboard.writeText(t.video),i.success("链接已复制")}catch{i.error("复制失败")}},children:"复制链接"})]}),e.jsx("video",{controls:!0,src:`/api/proxy/video?url=${encodeURIComponent(t.video)}`,className:"w-full mt-2 rounded"})]}):e.jsx("div",{className:`${l?"bg-gray-700":"bg-gray-50"} rounded-lg p-3 text-sm break-all`,children:t.video})),e.jsx(E.button,{whileHover:{scale:1.03},onClick:()=>se(s),className:"mt-2 bg-blue-600 text-white px-3 py-1 rounded-md",children:"生成视频"})]},s))})]})}export{je as default};
