var E=Object.defineProperty;var C=(i,e,r)=>e in i?E(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r;var h=(i,e,r)=>C(i,typeof e!="symbol"?e+"":e,r);import{N as D,u as O,r as u,j as t,m as w}from"./index-DW-f9EnK.js";class I{constructor(){h(this,"POINTS_RECORD_KEY","SECURE_POINTS_RECORDS");h(this,"pointsRecords",[]);h(this,"currentPoints",0);h(this,"cache",{});h(this,"CACHE_KEYS",["currentPoints","pointsRecords"]);this.loadPointsRecords(),this.calculateCurrentPoints()}loadPointsRecords(){try{const e=localStorage.getItem(this.POINTS_RECORD_KEY);e?this.pointsRecords=JSON.parse(e):(this.pointsRecords=[{id:1,source:"系统初始化",type:"system",points:0,date:new Date().toISOString().split("T")[0],description:"初始积分",balanceAfter:0}],this.savePointsRecords())}catch(e){console.error("Failed to load points records:",e),this.pointsRecords=[]}}savePointsRecords(){try{localStorage.setItem(this.POINTS_RECORD_KEY,JSON.stringify(this.pointsRecords))}catch(e){console.error("Failed to save points records:",e)}}calculateCurrentPoints(){this.currentPoints=this.pointsRecords.reduce((e,r)=>e+r.points,0),this.cache.currentPoints=this.currentPoints}getCurrentPoints(){return this.cache.currentPoints!==void 0?this.cache.currentPoints:(this.calculateCurrentPoints(),this.currentPoints)}getPointsRecords(e,r=20,a=0){let c=[...this.pointsRecords];if(e&&(e.startDate&&(c=c.filter(o=>o.date>=e.startDate)),e.endDate&&(c=c.filter(o=>o.date<=e.endDate)),e.type&&(c=c.filter(o=>o.type===e.type)),e.search)){const o=e.search.toLowerCase();c=c.filter(n=>n.source.toLowerCase().includes(o)||n.description.toLowerCase().includes(o))}return c.sort((o,n)=>new Date(n.date).getTime()-new Date(o.date).getTime()).slice(a,a+r)}getRecentPointsRecords(e=5){const r=`recentRecords_${e}`;if(this.cache[r])return this.cache[r];const a=this.getPointsRecords(void 0,e);return this.cache[r]=a,a}addPoints(e,r,a,c,o){const n={id:this.pointsRecords.length+1,source:r,type:a,points:e,date:new Date().toISOString().split("T")[0],description:c,relatedId:o,balanceAfter:this.currentPoints+e};return this.pointsRecords.push(n),this.calculateCurrentPoints(),this.savePointsRecords(),this.clearCache(),n}consumePoints(e,r,a,c,o){if(e>this.currentPoints)throw new Error("积分不足");const n={id:this.pointsRecords.length+1,source:r,type:a,points:-e,date:new Date().toISOString().split("T")[0],description:c,relatedId:o,balanceAfter:this.currentPoints-e};return this.pointsRecords.push(n),this.calculateCurrentPoints(),this.savePointsRecords(),this.clearCache(),n}syncWithAchievementService(){D.pointsRecords=this.pointsRecords.map(e=>({id:e.id,source:e.source,type:e.type,points:e.points,date:e.date,description:e.description,relatedId:e.relatedId,balanceAfter:e.balanceAfter}))}getPointsSourceStats(){if(this.cache.pointsSourceStats)return this.cache.pointsSourceStats;const e={achievement:0,task:0,daily:0,consumption:0,exchange:0,other:0};return this.pointsRecords.forEach(r=>{const a=r.type in e?r.type:"other";e[a]+=r.points}),this.cache.pointsSourceStats=e,e}clearCache(e){e?e.forEach(r=>{delete this.cache[r]}):this.CACHE_KEYS.forEach(r=>{delete this.cache[r]})}resetCache(){this.cache={}}}const p=new I;class A{constructor(){h(this,"PRODUCTS_KEY","SECURE_PRODUCTS");h(this,"EXCHANGE_RECORDS_KEY","SECURE_EXCHANGE_RECORDS");h(this,"products",[]);h(this,"exchangeRecords",[]);this.loadProducts(),this.loadExchangeRecords()}loadProducts(){try{const e=localStorage.getItem(this.PRODUCTS_KEY);e?this.products=JSON.parse(e):(this.products=[{id:1,name:"虚拟红包",description:"1000积分兑换10元虚拟红包",points:1e3,stock:100,status:"active",category:"virtual",tags:["红包","虚拟"],imageUrl:"/images/红包.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:2,name:"创意贴纸包",description:"500积分兑换创意贴纸包",points:500,stock:50,status:"active",category:"virtual",tags:["贴纸","虚拟"],imageUrl:"/images/贴纸包.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:3,name:"AI创作工具包",description:"2000积分兑换高级AI创作工具包",points:2e3,stock:30,status:"active",category:"service",tags:["AI工具","服务"],imageUrl:"/images/AI工具包.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:4,name:"专属成就徽章",description:"1500积分兑换专属成就徽章",points:1500,stock:100,status:"active",category:"rights",tags:["徽章","权益"],imageUrl:"/images/成就徽章.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{id:5,name:"实体创意笔记本",description:"3000积分兑换实体创意笔记本",points:3e3,stock:20,status:"active",category:"physical",tags:["笔记本","实体"],imageUrl:"/images/笔记本.svg",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}],this.saveProducts())}catch(e){console.error("Failed to load products:",e),this.products=[]}}saveProducts(){try{localStorage.setItem(this.PRODUCTS_KEY,JSON.stringify(this.products))}catch(e){console.error("Failed to save products:",e)}}loadExchangeRecords(){try{const e=localStorage.getItem(this.EXCHANGE_RECORDS_KEY);e?this.exchangeRecords=JSON.parse(e):(this.exchangeRecords=[],this.saveExchangeRecords())}catch(e){console.error("Failed to load exchange records:",e),this.exchangeRecords=[]}}saveExchangeRecords(){try{localStorage.setItem(this.EXCHANGE_RECORDS_KEY,JSON.stringify(this.exchangeRecords))}catch(e){console.error("Failed to save exchange records:",e)}}getAllProducts(){return[...this.products]}getProductById(e){return this.products.find(r=>r.id===e)}getUserExchangeRecords(e="current-user"){return[...this.exchangeRecords].filter(r=>r.userId===e).sort((r,a)=>new Date(a.date).getTime()-new Date(r.date).getTime())}exchangeProduct(e,r="current-user"){const a=this.products.find(n=>n.id===e);if(!a)throw new Error("商品不存在");if(a.status!=="active")throw new Error("商品不可用");if(a.stock<=0)throw new Error("商品已售罄");if(p.getCurrentPoints()<a.points)throw new Error("积分不足");p.consumePoints(a.points,"积分商城","exchange",`兑换商品：${a.name}`,`product_${e}`),a.stock-=1,a.stock===0&&(a.status="sold_out"),a.updatedAt=new Date().toISOString(),this.saveProducts();const o={id:this.exchangeRecords.length+1,productId:a.id,productName:a.name,points:a.points,date:new Date().toISOString(),userId:r,status:"completed"};return this.exchangeRecords.push(o),this.saveExchangeRecords(),o}addProduct(e){const r={...e,id:this.products.length+1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return this.products.push(r),this.saveProducts(),r}updateProduct(e,r){const a=this.products.findIndex(o=>o.id===e);if(a===-1)return;const c={...this.products[a],...r,updatedAt:new Date().toISOString()};return this.products[a]=c,this.saveProducts(),c}deleteProduct(e){const r=this.products.length;return this.products=this.products.filter(a=>a.id!==e),this.products.length<r?(this.saveProducts(),!0):!1}}const f=new A,$=()=>{const{isDark:i}=O(),[e,r]=u.useState([]),[a,c]=u.useState("all"),[o,n]=u.useState([]),[x,R]=u.useState(!1),[g,S]=u.useState(0),[m,P]=u.useState(""),[v,b]=u.useState([]);u.useEffect(()=>{localStorage.removeItem("SECURE_PRODUCTS");const s=f.getAllProducts(),d=f.getUserExchangeRecords("current-user"),l=p.getCurrentPoints();r(s),b(s),n(d),S(l)},[]),u.useEffect(()=>{let s=[...e];if(a!=="all"&&(s=s.filter(d=>d.category===a)),m){const d=m.toLowerCase();s=s.filter(l=>l.name.toLowerCase().includes(d)||l.description.toLowerCase().includes(d)||l.tags.some(y=>y.toLowerCase().includes(d)))}b(s)},[a,m,e]);const N=s=>{try{const d=f.exchangeProduct(s.id,"current-user");n([d,...o]),S(p.getCurrentPoints()),r(e.map(l=>l.id===s.id?{...l,stock:l.stock-1}:l)),alert(`兑换成功！消耗${s.points}积分`)}catch(d){alert(d.message)}},j=[{value:"all",label:"全部"},{value:"virtual",label:"虚拟商品"},{value:"physical",label:"实物商品"},{value:"service",label:"服务"},{value:"rights",label:"权益"}];return t.jsx("div",{className:`min-h-screen ${i?"bg-gray-900 text-white":"bg-white text-gray-900"}`,children:t.jsxs("main",{className:"container mx-auto px-4 py-10",children:[t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx("h1",{className:"text-2xl font-bold",children:"积分商城"}),t.jsxs("div",{className:`${i?"bg-gray-800":"bg-white"} rounded-full px-4 py-2 shadow-md`,children:[t.jsx("span",{className:"font-medium",children:"当前积分："}),t.jsx("span",{className:`ml-2 font-bold ${i?"text-red-400":"text-red-500"}`,children:g})]})]}),t.jsxs("div",{className:"mb-8",children:[t.jsx("div",{className:"mb-4",children:t.jsx("input",{type:"text",placeholder:"搜索商品...",className:`w-full px-4 py-2 rounded-lg border ${i?"bg-gray-800 border-gray-700":"bg-gray-100 border-gray-300"} focus:outline-none focus:ring-2 focus:ring-red-500`,value:m,onChange:s=>P(s.target.value)})}),t.jsx("div",{className:"flex flex-wrap gap-2",children:j.map(s=>t.jsx("button",{onClick:()=>c(s.value),className:`px-4 py-2 rounded-full text-sm font-medium transition-all ${a===s.value?i?"bg-red-600 text-white":"bg-red-500 text-white":i?"bg-gray-800 hover:bg-gray-700":"bg-white hover:bg-gray-100"}`,children:s.label},s.value))})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:v.map((s,d)=>t.jsxs(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.05*d},className:`${i?"bg-gray-800":"bg-white"} rounded-xl shadow-md overflow-hidden`,children:[t.jsx("div",{className:"h-48 overflow-hidden",children:t.jsx("img",{src:s.imageUrl,alt:s.name,className:"w-full h-full object-cover transition-transform duration-300 hover:scale-105"})}),t.jsxs("div",{className:"p-4",children:[t.jsxs("div",{className:"flex justify-between items-start mb-2",children:[t.jsx("h3",{className:"text-lg font-bold",children:s.name}),t.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${i?"bg-red-900 bg-opacity-50":"bg-red-100"} text-red-500`,children:[s.points," 积分"]})]}),t.jsx("p",{className:`mb-4 text-sm ${i?"text-gray-400":"text-gray-600"}`,children:s.description}),t.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:s.tags.map((l,y)=>t.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${i?"bg-gray-700":"bg-gray-100"}`,children:l},y))}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("span",{className:`text-sm ${i?"text-gray-400":"text-gray-600"}`,children:["库存：",s.stock]}),t.jsx("button",{onClick:()=>N(s),disabled:s.status!=="active"||s.stock<=0||g<s.points,className:`px-4 py-2 rounded-lg font-medium transition-colors ${i?g<s.points||s.stock<=0?"bg-gray-700 cursor-not-allowed":"bg-red-600 hover:bg-red-700":g<s.points||s.stock<=0?"bg-gray-200 cursor-not-allowed":"bg-red-500 hover:bg-red-600"} text-white disabled:opacity-50`,children:s.stock<=0?"已售罄":g<s.points?"积分不足":"立即兑换"})]})]})]},s.id))}),v.length===0&&t.jsxs("div",{className:"text-center py-12",children:[t.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),t.jsx("h3",{className:"text-lg font-medium mb-2",children:"未找到商品"}),t.jsx("p",{className:"opacity-70",children:"请尝试调整搜索条件或分类"})]}),t.jsxs("div",{className:"mt-12",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsx("h2",{className:"text-xl font-bold",children:"兑换记录"}),t.jsx("button",{onClick:()=>R(!x),className:`px-3 py-1 rounded-full text-sm font-medium ${i?"bg-gray-800 hover:bg-gray-700":"bg-gray-100 hover:bg-gray-200"}`,children:x?"隐藏":"查看"})]}),x&&t.jsx(w.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:`${i?"bg-gray-800":"bg-white"} rounded-xl shadow-md overflow-hidden`,children:o.length===0?t.jsx("div",{className:"p-6 text-center",children:t.jsx("p",{className:"opacity-70",children:"暂无兑换记录"})}):t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{children:t.jsxs("tr",{className:`${i?"border-b border-gray-700":"border-b border-gray-200"}`,children:[t.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"商品名称"}),t.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"积分"}),t.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"日期"}),t.jsx("th",{className:"text-left p-4 text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-600'}",children:"状态"})]})}),t.jsx("tbody",{children:o.map(s=>t.jsxs("tr",{className:`${i?"border-b border-gray-700":"border-b border-gray-200"}`,children:[t.jsx("td",{className:"p-4",children:s.productName}),t.jsx("td",{className:"p-4",children:s.points}),t.jsx("td",{className:"p-4 text-sm opacity-70",children:s.date}),t.jsx("td",{className:"p-4",children:t.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${s.status==="completed"?"bg-green-500 text-white":s.status==="pending"?"bg-yellow-500 text-white":"bg-red-500 text-white"}`,children:s.status==="completed"?"已完成":s.status==="pending"?"处理中":"已取消"})})]},s.id))})]})})]})]})})};export{$ as default};
