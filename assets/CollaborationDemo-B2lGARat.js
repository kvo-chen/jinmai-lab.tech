var we=Object.defineProperty;var je=(m,s,c)=>s in m?we(m,s,{enumerable:!0,configurable:!0,writable:!0,value:c}):m[s]=c;var S=(m,s,c)=>je(m,typeof s!="symbol"?s+"":s,c);import{z as Ne,u as re,r as a,t as I,j as t,m as H}from"./index-DW-f9EnK.js";class Se{constructor(){S(this,"ws",null);S(this,"callbacks",{});S(this,"reconnectAttempts",0);S(this,"maxReconnectAttempts",5);S(this,"reconnectDelay",1e3);S(this,"isConnecting",!1);S(this,"heartbeatInterval",null)}connect(s,c,f){var o;if(!(this.isConnecting||((o=this.ws)==null?void 0:o.readyState)===WebSocket.OPEN)){this.isConnecting=!0;try{const i=`ws://localhost:3007/ws?sessionId=${encodeURIComponent(s)}&userId=${encodeURIComponent(c)}&username=${encodeURIComponent(f)}`;this.ws=new WebSocket(i),this.ws.onopen=()=>{var d,u;console.log("WebSocket连接已建立"),this.isConnecting=!1,this.reconnectAttempts=0,this.startHeartbeat(),(u=(d=this.callbacks).onOpen)==null||u.call(d)},this.ws.onclose=d=>{var u,x;console.log("WebSocket连接已关闭",d.code,d.reason),this.isConnecting=!1,this.stopHeartbeat(),(x=(u=this.callbacks).onClose)==null||x.call(u),this.reconnectAttempts<this.maxReconnectAttempts&&setTimeout(()=>{this.reconnectAttempts++,this.connect(s,c,f)},this.reconnectDelay*this.reconnectAttempts)},this.ws.onerror=d=>{var u,x;console.error("WebSocket错误:",d),this.isConnecting=!1,(x=(u=this.callbacks).onError)==null||x.call(u,d)},this.ws.onmessage=d=>{try{const u=JSON.parse(d.data);this.handleMessage(u)}catch(u){console.error("WebSocket消息解析错误:",u)}}}catch(i){console.error("WebSocket连接失败:",i),this.isConnecting=!1}}}disconnect(){this.ws&&(this.ws.close(1e3,"用户主动断开"),this.ws=null),this.stopHeartbeat(),this.isConnecting=!1}send(s){var c;((c=this.ws)==null?void 0:c.readyState)===WebSocket.OPEN?this.ws.send(JSON.stringify(s)):console.warn("WebSocket未连接，无法发送消息")}sendTextEdit(s,c,f="",o=0){this.send({type:"text_edit",operation:s,position:c,text:f,length:o})}sendCursorMove(s){this.send({type:"cursor_move",position:s})}sendSelectionChange(s,c){this.send({type:"selection_change",start:s,end:c})}sendTypingStart(){this.send({type:"typing_start"})}sendTypingStop(){this.send({type:"typing_stop"})}handleMessage(s){var c,f,o,i,d,u,x,w,g,v,y,j,C,U;switch((f=(c=this.callbacks).onMessage)==null||f.call(c,s),s.type){case"session_joined":(i=(o=this.callbacks).onSessionJoin)==null||i.call(o,s);break;case"user_joined":(u=(d=this.callbacks).onUserJoined)==null||u.call(d,s);break;case"user_left":(w=(x=this.callbacks).onUserLeft)==null||w.call(x,s);break;case"text_edit":(v=(g=this.callbacks).onTextEdit)==null||v.call(g,s);break;case"cursor_update":(j=(y=this.callbacks).onCursorUpdate)==null||j.call(y,s);break;case"selection_update":(U=(C=this.callbacks).onSelectionUpdate)==null||U.call(C,s);break;case"error":console.error("WebSocket服务器错误:",s.message);break;default:console.warn("未知的WebSocket消息类型:",s.type)}}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{var s;((s=this.ws)==null?void 0:s.readyState)===WebSocket.OPEN&&this.send({type:"ping"})},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}setCallbacks(s){this.callbacks={...this.callbacks,...s}}onOpen(s){this.callbacks.onOpen=s}onClose(s){this.callbacks.onClose=s}onError(s){this.callbacks.onError=s}onMessage(s){this.callbacks.onMessage=s}onSessionJoin(s){this.callbacks.onSessionJoin=s}onUserJoined(s){this.callbacks.onUserJoined=s}onUserLeft(s){this.callbacks.onUserLeft=s}onTextEdit(s){this.callbacks.onTextEdit=s}onCursorUpdate(s){this.callbacks.onCursorUpdate=s}onSelectionUpdate(s){this.callbacks.onSelectionUpdate=s}getConnectionState(){var s,c;return this.isConnecting?"connecting":((s=this.ws)==null?void 0:s.readyState)===WebSocket.OPEN?"open":((c=this.ws)==null?void 0:c.readyState)===WebSocket.CLOSED?"closed":"error"}}const b=new Se,ve=Ne.memo(({sessionId:m,userId:s,username:c,initialContent:f="",readOnly:o=!1,onContentChange:i,className:d=""})=>{const{theme:u,isDark:x}=re(),[w,g]=a.useState(f),[v,y]=a.useState(!1),[j,C]=a.useState([]),[U,G]=a.useState([]),[D,Z]=a.useState([]),[L,P]=a.useState(!1),[Ce,ne]=a.useState(0),[M,ae]=a.useState(!1),[p,ce]=a.useState([f]),[h,$]=a.useState(0),[q,Q]=a.useState(!1),[V,ee]=a.useState(!1),R=a.useRef(null),B=a.useRef(),_=a.useRef(new Map),J=a.useRef();a.useEffect(()=>{ae(!0)},[]);const W=a.useCallback(e=>{if(!_.current.has(e)){const r=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FECA57","#FF9FF3","#54A0FF","#5F27CD","#00D2D3","#FF9F43"],n=r[_.current.size%r.length];_.current.set(e,n)}return _.current.get(e)},[]);a.useEffect(()=>(b.connect(m,s,c),b.onMessage(e=>{ie(e)}),b.onOpen(()=>{y(!0),I.success("协作连接已建立")}),b.onClose(()=>{y(!1),I.error("协作连接已断开")}),b.onError(e=>{console.error("WebSocket错误:",e),I.error("协作连接出现错误")}),()=>{b.disconnect()}),[m,s,c]);const ie=a.useCallback(e=>{switch(e.type){case"text_edit":oe(e);break;case"cursor_move":le(e);break;case"selection_change":de(e);break;case"user_joined":ue(e);break;case"user_left":xe(e);break;case"typing_start":he(e);break;case"typing_stop":be(e);break}},[]),oe=a.useCallback(e=>{e.userId!==s&&g(r=>{let n=r;return e.operation==="insert"?n=r.slice(0,e.position)+e.text+r.slice(e.position):e.operation==="delete"&&(n=r.slice(0,e.position)+r.slice(e.position+e.length)),i==null||i(n),n!==p[h]&&z(n),n})},[s,i,p,h]),K=a.useCallback(e=>{var A;if(!R.current)return e*8;const r=R.current,n=r.textContent||"";if(e===0)return 0;if(e>=n.length){const T=document.createRange();T.selectNodeContents(r),T.collapse(!1);const Y=T.getBoundingClientRect(),ke=r.getBoundingClientRect();return Y.left-ke.left}const l=document.createRange();l.selectNodeContents(r),l.setStart(r.firstChild||r,0);let N=0,k=r.firstChild;for(;k&&N<e;){if(k.nodeType===Node.TEXT_NODE){const T=((A=k.textContent)==null?void 0:A.length)||0;if(N+T>=e){const Y=e-N;l.setStart(k,Y);break}N+=T}k=k.nextSibling}const X=l.getBoundingClientRect(),F=r.getBoundingClientRect();return X.left-F.left},[]),le=a.useCallback(e=>{e.userId!==s&&C(r=>[...r.filter(l=>l.userId!==e.userId),{userId:e.userId,username:e.username,position:e.position,color:W(e.userId)}])},[s,W]),de=a.useCallback(e=>{e.userId!==s&&G(r=>{const n=r.filter(l=>l.userId!==e.userId);return e.start!==e.end?[...n,{userId:e.userId,username:e.username,start:e.start,end:e.end,color:W(e.userId)}]:n})},[s,W]),ue=a.useCallback(e=>{I.info(`${e.username} 加入了协作`)},[]),xe=a.useCallback(e=>{I.info(`${e.username} 离开了协作`),C(r=>r.filter(n=>n.userId!==e.userId)),G(r=>r.filter(n=>n.userId!==e.userId))},[]),he=a.useCallback(e=>{e.userId!==s&&Z(r=>[...r.filter(l=>l.userId!==e.userId),{userId:e.userId,username:e.username,isTyping:!0}])},[s]),be=a.useCallback(e=>{e.userId!==s&&Z(r=>r.filter(n=>n.userId!==e.userId))},[s]),te=a.useCallback(()=>{if(h>0){Q(!0);const e=h-1,r=p[e];g(r),$(e),i==null||i(r),setTimeout(()=>Q(!1),0)}},[p,h,i]),se=a.useCallback(()=>{if(h<p.length-1){ee(!0);const e=h+1,r=p[e];g(r),$(e),i==null||i(r),setTimeout(()=>ee(!1),0)}},[p,h,i]),O=a.useCallback(e=>{o||((e.ctrlKey||e.metaKey)&&e.key==="z"&&(e.preventDefault(),te()),(e.ctrlKey||e.metaKey)&&e.key==="y"&&(e.preventDefault(),se()))},[o,te,se]);a.useEffect(()=>(window.addEventListener("keydown",O),()=>{window.removeEventListener("keydown",O)}),[O]);const z=a.useCallback(e=>{if(q||V)return;const r=p.slice(0,h+1),n=50;r.length>=n&&(r.shift(),$(h-1)),ce([...r,e]),$(l=>Math.min(l+1,n-1))},[p,h,q,V]),fe=a.useCallback(e=>{if(o)return;const n=e.target.innerHTML||"";g(n),i==null||i(n),J.current&&clearTimeout(J.current),J.current=setTimeout(()=>{n!==p[h]&&z(n)},500),L||(P(!0),b.sendTypingStart()),ne(Date.now()),B.current&&clearTimeout(B.current),B.current=setTimeout(()=>{P(!1),b.sendTypingStop()},1e3)},[o,i,L,w,p,h,z]),pe=a.useCallback(e=>{if(o||!M)return;const r=e.target,n=window.getSelection();if(!n||n.rangeCount===0)return;const l=n.getRangeAt(0),N=E(r,l);if(b.sendCursorMove(N),l.collapsed)b.sendSelectionChange(N,N);else{const k=l.cloneRange();k.collapse(!0);const X=E(r,k),F=l.cloneRange();F.collapse(!1);const A=E(r,F);b.sendSelectionChange(X,A)}},[o,M]),E=(e,r)=>{const n=r.cloneRange();return n.selectNodeContents(e),n.setEnd(r.endContainer,r.endOffset),n.toString().length},me=a.useCallback(()=>{if(o||!R.current||!M)return;const e=window.getSelection();if(!e||e.rangeCount===0)return;const r=e.getRangeAt(0),n=E(R.current,r.cloneRange());r.collapse(!1);const l=E(R.current,r);b.sendSelectionChange(n,l)},[o,M]),ge=()=>j.map(e=>{const r=K(e.position);return t.jsxs("div",{className:"absolute flex flex-col items-center pointer-events-none",style:{left:`${r}px`,top:"0px"},children:[t.jsx("div",{className:"w-0.5 h-5 animate-pulse",style:{backgroundColor:e.color}}),t.jsx("div",{className:"mt-1 px-2 py-0.5 rounded text-xs font-medium text-white shadow-sm",style:{backgroundColor:e.color},children:e.username})]},e.userId)}),ye=()=>U.map(e=>{const r=K(e.start),n=K(e.end),l=Math.abs(n-r);return t.jsx("div",{className:"absolute h-5 opacity-20",style:{left:`${Math.min(r,n)}px`,width:`${l}px`,backgroundColor:e.color,top:"2px"},title:`${e.username}的选择`},e.userId)});return t.jsxs(H.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},className:`relative ${d}`,children:[t.jsxs("div",{className:`flex flex-col mb-3 p-2 rounded-lg text-sm ${x?"bg-gray-800":"bg-gray-100"}`,children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:`w-2 h-2 rounded-full ${v?"bg-green-500":"bg-red-500"} animate-pulse`}),t.jsx("span",{children:v?"协作已连接":"协作已断开"}),t.jsx("span",{className:"text-gray-500",children:"•"}),t.jsxs("span",{children:[j.length+1," 人在线"]})]}),t.jsx("div",{className:"flex items-center space-x-1",children:j.map(e=>t.jsxs(H.div,{className:"flex items-center space-x-1 px-2 py-1 rounded text-xs",style:{backgroundColor:e.color+"20"},initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.2},children:[t.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),t.jsx("span",{children:e.username})]},e.userId))})]}),D.length>0&&t.jsx(H.div,{className:"text-xs text-gray-600 dark:text-gray-300",initial:{opacity:0,y:-5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},children:D.map(e=>t.jsxs("span",{className:"mr-2",children:[e.username," 正在输入",D.length>1?"...":""]},e.userId))})]}),t.jsxs("div",{className:"relative",children:[t.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[ge(),ye()]}),t.jsx("div",{ref:R,contentEditable:!o,suppressContentEditableWarning:!0,className:`min-h-[200px] p-4 rounded-lg border-2 focus:outline-none focus:border-red-500 transition-colors ${x?"bg-gray-900 border-gray-700 text-white":"bg-white border-gray-300 text-gray-900"} ${o?"cursor-not-allowed opacity-70":""}`,dangerouslySetInnerHTML:{__html:w},onInput:fe,onKeyDown:pe,onMouseUp:me,onBlur:()=>{L&&(P(!1),b.sendTypingStop())},"aria-label":"协作编辑器","aria-describedby":D.length>0?"typing-status":void 0})]}),t.jsx("div",{className:"mt-2 text-xs text-gray-500",children:!o&&t.jsxs("span",{children:["使用 ",t.jsx("kbd",{className:"px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",children:"Ctrl+Z"})," 撤销，",t.jsx("kbd",{className:"ml-1 px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded",children:"Ctrl+Y"})," 重做"]})})]})}),Te=()=>{const{theme:m,isDark:s}=re(),[c,f]=a.useState("demo-session-1"),[o,i]=a.useState(`user-${Date.now()}`),[d,u]=a.useState(`用户${Math.floor(Math.random()*1e3)}`),[x,w]=a.useState(`欢迎来到津脉智坊协作编辑器！

这是一个实时协作编辑演示，您可以与其他人同时编辑同一份文档。

功能特性：
• 实时文本同步
• 光标位置共享
• 选择范围可视化
• 用户状态指示
• 输入状态显示`),g=y=>{w(y)},v=()=>{const y=`session-${Date.now()}`,j=`user-${Date.now()}`,C=`用户${Math.floor(Math.random()*1e3)}`;f(y),i(j),u(C),w(`新的协作会话已创建！

开始您的实时协作编辑体验吧！`),I.success("已创建新的协作会话")};return t.jsx(H.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"min-h-screen p-6",style:{backgroundColor:s?"#0f172a":"#f8fafc"},children:t.jsxs("div",{className:"max-w-6xl mx-auto",children:[t.jsxs("div",{className:"text-center mb-8",children:[t.jsx("h1",{className:"text-4xl font-bold mb-4 bg-gradient-to-r from-red-600 to-red-400 bg-clip-text text-transparent",children:"津脉智坊 - 实时协作编辑器"}),t.jsx("p",{className:"text-lg text-gray-600 dark:text-gray-400 mb-6",children:"体验多人实时协作编辑的强大功能"})]}),t.jsx("div",{className:`mb-6 p-4 rounded-lg ${s?"bg-gray-800":"bg-white shadow"} border border-gray-200 dark:border-gray-700`,children:t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[t.jsxs("div",{className:"flex flex-col space-y-2",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"会话ID:"}),t.jsx("code",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-sm",children:c})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"当前用户:"}),t.jsx("span",{className:"px-2 py-1 bg-red-100 dark:bg-red-900 rounded text-sm text-red-800 dark:text-red-200",children:d})]})]}),t.jsxs("div",{className:"flex items-center space-x-3",children:[t.jsx("button",{onClick:v,className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors duration-200 font-medium",children:"创建新会话"}),t.jsx("button",{onClick:()=>{navigator.clipboard.writeText(c),I.success("会话ID已复制到剪贴板")},className:"px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 font-medium",children:"复制会话ID"})]})]})}),t.jsx("div",{className:`mb-6 rounded-lg overflow-hidden ${s?"bg-gray-800":"bg-white shadow"} border border-gray-200 dark:border-gray-700`,children:t.jsx(ve,{sessionId:c,userId:o,username:d,initialContent:x,onContentChange:g,className:"w-full"})}),t.jsxs("div",{className:`p-6 rounded-lg ${s?"bg-gray-800":"bg-white shadow"} border border-gray-200 dark:border-gray-700`,children:[t.jsx("h2",{className:"text-2xl font-bold mb-4 text-gray-800 dark:text-white",children:"功能说明"}),t.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-red-100 dark:bg-red-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-users text-red-600 dark:text-red-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"实时协作"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"多人同时编辑同一文档，所有更改实时同步"})]})]}),t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-mouse-pointer text-blue-600 dark:text-blue-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"光标同步"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"实时显示其他用户的光标位置和选择范围"})]})]})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-bolt text-green-600 dark:text-green-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"输入状态"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"显示其他用户的输入状态，了解协作进度"})]})]}),t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center flex-shrink-0",children:t.jsx("i",{className:"fas fa-shield-alt text-purple-600 dark:text-purple-400"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white",children:"稳定连接"}),t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"自动重连机制，确保协作过程稳定可靠"})]})]})]})]})]}),t.jsx("div",{className:`mt-6 p-4 rounded-lg ${s?"bg-yellow-900/20 border-yellow-800":"bg-yellow-50 border-yellow-200"} border`,children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("i",{className:"fas fa-lightbulb text-yellow-500 mt-1"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold text-yellow-800 dark:text-yellow-200",children:"使用提示"}),t.jsxs("ul",{className:"text-sm text-yellow-700 dark:text-yellow-300 mt-1 space-y-1",children:[t.jsx("li",{children:"• 在多个浏览器标签页中打开此页面，模拟多人协作"}),t.jsx("li",{children:"• 复制会话ID分享给其他人，邀请他们加入协作"}),t.jsx("li",{children:"• 观察光标和选择范围的实时同步效果"}),t.jsx("li",{children:"• 尝试同时输入，体验实时同步的流畅性"})]})]})]})})]})})};export{Te as default};
