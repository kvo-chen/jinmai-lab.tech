var u=Object.defineProperty;var g=(c,t,e)=>t in c?u(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var o=(c,t,e)=>g(c,typeof t!="symbol"?t+"":t,e);const p={sm:{width:320,quality:70},md:{width:640,quality:80},lg:{width:1200,quality:90},xl:{width:1920,quality:95}},m={maxCacheSize:500,cacheTTL:2880*60*1e3,maxRetries:2,retryDelay:c=>300*Math.pow(2,c),preloadDistance:400,enableWebP:!0,enableAVIF:!0,enableResponsiveLoading:!0,enablePriorityLoading:!0,enablePredictiveLoading:!0,enableImageCompression:!0,compressionQuality:85,cacheStrategy:"LRU"};class f{constructor(t={}){o(this,"cache",new Map);o(this,"config");o(this,"inProgressRequests",new Map);o(this,"preloadedUrls",new Set);o(this,"preloadObserver",null);o(this,"stats",{totalRequests:0,cacheHits:0,loadSuccess:0,loadFailed:0,totalLoadTime:0,averageLoadTime:0,totalSize:0,averageSize:0,cacheHitRate:0,successRate:0,preloadCount:0,preloadHitCount:0,preloadHitRate:0});o(this,"predictiveUrls",new Set);o(this,"pageTransitionHistory",[]);o(this,"concurrentPreloadLimit");o(this,"pendingPreloads",[]);o(this,"currentPreloadCount",0);o(this,"networkCondition","medium");o(this,"devicePerformance","medium");this.config={...m,...t},this.cleanupCache(),this.initPreloadObserver(),this.initPredictiveLoading(),this.detectNetworkCondition(),this.detectDevicePerformance(),this.concurrentPreloadLimit=this.getDynamicPreloadLimit(),this.setupNetworkListeners()}detectNetworkCondition(){if("connection"in navigator){const t=navigator.connection;this.updateNetworkCondition(t)}}updateNetworkCondition(t){const e=t.effectiveType||"4g",a=t.downlink||10;e.includes("2g")||a<1?this.networkCondition="slow":e.includes("3g")||a<5?this.networkCondition="medium":this.networkCondition="fast"}detectDevicePerformance(){const t=navigator.hardwareConcurrency||4,e=navigator.deviceMemory||4;t<=2||e<=2?this.devicePerformance="low":t<=4||e<=4?this.devicePerformance="medium":this.devicePerformance="high"}getDynamicPreloadLimit(){let t=3;switch(this.networkCondition){case"slow":t-=1;break;case"fast":t+=2;break}switch(this.devicePerformance){case"low":t-=1;break;case"high":t+=1;break}return Math.max(1,Math.min(8,t))}setupNetworkListeners(){if("connection"in navigator){const t=navigator.connection;t.addEventListener("change",()=>{this.updateNetworkCondition(t),this.concurrentPreloadLimit=this.getDynamicPreloadLimit()})}}initPreloadObserver(){if("IntersectionObserver"in window){const t=this.getDynamicPreloadDistance();this.preloadObserver=new IntersectionObserver(e=>{e.forEach(a=>{var s;if(a.isIntersecting){const i=a.target.getAttribute("data-preload-img");i&&this.preloadImage(i),(s=this.preloadObserver)==null||s.unobserve(a.target)}})},{rootMargin:`${t}px 0px`,threshold:0})}}getDynamicPreloadDistance(){let t=this.config.preloadDistance;switch(this.devicePerformance){case"high":t+=200;break;case"low":t-=150;break}switch(this.networkCondition){case"slow":t-=200;break;case"fast":t+=150;break}return Math.max(100,Math.min(1e3,t))}initPredictiveLoading(){this.config.enablePredictiveLoading&&(window.addEventListener("popstate",t=>{this.updatePageTransitionHistory(window.location.pathname),this.predictiveLoadImages()}),document.addEventListener("click",t=>{const a=t.target.closest("a");if(a&&a.href){const s=new URL(a.href);s.origin===window.location.origin&&(this.updatePageTransitionHistory(s.pathname),this.predictiveLoadImages())}}))}updatePageTransitionHistory(t){this.pageTransitionHistory.push(t),this.pageTransitionHistory.length>10&&this.pageTransitionHistory.shift()}predictiveLoadImages(){const t=window.location.pathname,e=this.predictNextPage(t);e&&this.loadPageImages(e)}predictNextPage(t){const e={};for(let i=0;i<this.pageTransitionHistory.length-1;i++)if(this.pageTransitionHistory[i]===t){const r=this.pageTransitionHistory[i+1];e[r]=(e[r]||0)+1}let a=null,s=0;for(const[i,r]of Object.entries(e))r>s&&(a=i,s=r);return a}loadPageImages(t){const a={"/home":["/api/proxy/trae-api/home-banner.jpg","/api/proxy/trae-api/featured-1.jpg","/api/proxy/trae-api/featured-2.jpg"],"/explore":["/api/proxy/trae-api/explore-banner.jpg","/api/proxy/trae-api/popular-1.jpg","/api/proxy/trae-api/popular-2.jpg"],"/create":["/api/proxy/trae-api/create-banner.jpg","/api/proxy/trae-api/tools-1.jpg","/api/proxy/trae-api/tools-2.jpg"],"/community":["/api/proxy/trae-api/community-banner.jpg","/api/proxy/trae-api/discussion-1.jpg","/api/proxy/trae-api/discussion-2.jpg"],"/dashboard":["/api/proxy/trae-api/dashboard-banner.jpg","/api/proxy/trae-api/stats-1.jpg","/api/proxy/trae-api/stats-2.jpg"]}[t]||[];this.preloadImages(a)}cleanupCache(){const t=Date.now();for(const[e,a]of this.cache.entries())t-a.timestamp>this.config.cacheTTL&&this.cache.delete(e);for(;this.cache.size>this.config.maxCacheSize;){let e;switch(this.config.cacheStrategy){case"LRU":e=Array.from(this.cache.entries()).sort((a,s)=>a[1].lastUsed-s[1].lastUsed)[0][0];break;case"LFU":e=Array.from(this.cache.entries()).sort((a,s)=>a[1].usageCount-s[1].usageCount)[0][0];break;case"MRU":e=Array.from(this.cache.entries()).sort((a,s)=>s[1].lastUsed-a[1].lastUsed)[0][0];break;default:e=Array.from(this.cache.entries()).sort((a,s)=>a[1].lastUsed-s[1].lastUsed)[0][0];break}this.cache.delete(e)}}normalizeUrl(t){try{let e=t.trim().replace(/[\s\t\n\r]+/g,"");if(e.startsWith("data:"))return e;const a=e.startsWith("http")?new URL(e):new URL(e,window.location.origin);if(a.hostname.includes("github.com")||a.hostname.includes("raw.githubusercontent.com"))return a.toString();const s=new URLSearchParams(a.search);return s.sort(),a.search=s.toString(),a.pathname.endsWith("/")&&a.pathname.length>1&&(a.pathname=a.pathname.slice(0,-1)),a.toString()}catch(e){return console.error(`[ImageService] URL标准化失败: ${t}`,e),t}}detectSupportedFormats(){const t=(()=>{try{return document.createElement("canvas").toDataURL("image/webp").indexOf("data:image/webp")===0}catch{return!1}})(),e=(()=>{try{return document.createElement("canvas").toDataURL("image/avif").indexOf("data:image/avif")===0}catch{return!1}})();return{webp:t,avif:e}}getResponsiveUrl(t,e="md",a){if(t.includes("/api/proxy/trae-api")||t.includes("trae-api-sg.mchost.guru"))try{return(t.startsWith("http")?new URL(t):new URL(t,window.location.origin)).toString()}catch{return t}if(t.includes("github.com")||t.includes("raw.githubusercontent.com"))return t;try{const s=t.startsWith("http")?new URL(t):new URL(t,window.location.origin),i=p[e],r=a||i.quality;return s.searchParams.set("w",i.width.toString()),s.searchParams.set("q",r.toString()),s.toString()}catch{return t}}getLowQualityUrl(t){if(t.includes("/api/proxy/trae-api")||t.includes("trae-api-sg.mchost.guru"))try{return(t.startsWith("http")?new URL(t):new URL(t,window.location.origin)).toString()}catch{return t}if(t.includes("github.com")||t.includes("raw.githubusercontent.com"))return t;try{const e=t.startsWith("http")?new URL(t):new URL(t,window.location.origin);return e.searchParams.set("w","100"),e.searchParams.set("q","20"),e.toString()}catch{return t}}getFallbackUrl(t){return"/images/placeholder-image.jpg"}isValidImageUrl(t){try{const e=new URL(t);return["http:","https:"].includes(e.protocol)}catch{return!1}}preloadImage(t){this.preloadedUrls.has(t)||(this.preloadedUrls.add(t),this.pendingPreloads.push(t),this.stats.preloadCount++,this.processPreloadQueue())}processPreloadQueue(){for(;this.currentPreloadCount<this.concurrentPreloadLimit&&this.pendingPreloads.length>0;){const t=this.pendingPreloads.shift();this.loadPreloadImage(t)}}loadPreloadImage(t,e=0){this.currentPreloadCount++;const a=new Image,s=Date.now(),i=setTimeout(()=>{a.src="",this.handlePreloadError(t,e)},5e3);a.onload=()=>{clearTimeout(i);const r=Date.now()-s;this.updateImageStatus(t,!0,a.naturalWidth*a.naturalHeight),this.stats.totalLoadTime+=r,this.stats.preloadHitCount++,this.currentPreloadCount--,this.processPreloadQueue()},a.onerror=()=>{clearTimeout(i),this.handlePreloadError(t,e)},a.src=t}handlePreloadError(t,e){e<this.config.maxRetries?setTimeout(()=>{this.loadPreloadImage(t,e+1)},this.config.retryDelay(e)):(this.updateImageStatus(t,!1),this.currentPreloadCount--,this.processPreloadQueue())}preloadImages(t){t.forEach(e=>this.preloadImage(e))}observeForPreload(t,e){this.preloadObserver&&(t.setAttribute("data-preload-img",e),this.preloadObserver.observe(t))}async validateImageUrl(t,e=0){if(!this.isValidImageUrl(t))return!1;try{const a=new AbortController,s=setTimeout(()=>a.abort(),5e3),i=await fetch(t,{method:"HEAD",signal:a.signal});clearTimeout(s);const r=i.headers.get("content-type");return i.ok&&((r==null?void 0:r.startsWith("image/"))||!1)}catch{return e<this.config.maxRetries?(await new Promise(s=>setTimeout(s,this.config.retryDelay(e))),this.validateImageUrl(t,e+1)):!1}}async getReliableImageUrl(t,e,a){const s=this.normalizeUrl(t),{priority:i=!1,validate:r=!1,size:n="md",quality:l}=a||{};this.stats.totalRequests++,this.cleanupCache();let h=this.cache.get(s);if(h)return h.usageCount++,h.lastUsed=Date.now(),this.cache.set(s,h),this.stats.cacheHits++,h.success?this.getResponsiveUrl(s,n,l):this.getFallbackUrl(e);if(this.inProgressRequests.has(s))return this.inProgressRequests.get(s);const d=this.getResponsiveUrl(s,n,l);return i&&this.preloadImage(d),this.cache.set(s,{url:s,timestamp:Date.now(),success:!0,usageCount:1,lastUsed:Date.now(),format:this.detectSupportedFormats().avif?"avif":this.detectSupportedFormats().webp?"webp":void 0,quality:l||p[n].quality}),d}async getReliableImageUrls(t,e){return Promise.all(t.map(({url:a,alt:s})=>this.getReliableImageUrl(a,s,e)))}updateImageStatus(t,e,a){const s=this.normalizeUrl(t);e?this.stats.loadSuccess++:this.stats.loadFailed++;const i=this.cache.get(s);if(i!=null&&i.loadTime){this.stats.totalLoadTime+=i.loadTime;const n=this.stats.loadSuccess+this.stats.loadFailed;this.stats.averageLoadTime=n>0?Math.round(this.stats.totalLoadTime/n):0}if(a){this.stats.totalSize+=a;const n=this.stats.loadSuccess+this.stats.loadFailed;this.stats.averageSize=n>0?Math.round(this.stats.totalSize/n):0}this.stats.totalRequests>0&&(this.stats.cacheHitRate=Math.round(this.stats.cacheHits/this.stats.totalRequests*100));const r=this.stats.loadSuccess+this.stats.loadFailed;r>0&&(this.stats.successRate=Math.round(this.stats.loadSuccess/r*100)),this.stats.preloadCount>0&&(this.stats.preloadHitRate=Math.round(this.stats.preloadHitCount/this.stats.preloadCount*100)),this.cache.set(s,{url:s,timestamp:Date.now(),success:e,size:a,usageCount:(i==null?void 0:i.usageCount)||1,lastUsed:Date.now(),format:i==null?void 0:i.format,quality:i==null?void 0:i.quality,width:i==null?void 0:i.width,height:i==null?void 0:i.height,loadTime:i==null?void 0:i.loadTime}),this.cleanupCache()}clearCache(t){if(t){const e=this.normalizeUrl(t);this.cache.delete(e),this.preloadedUrls.delete(e)}else this.cache.clear(),this.preloadedUrls.clear()}getCacheStats(){const t=this.stats.totalRequests>0?Math.round(this.stats.cacheHits/this.stats.totalRequests*100):0,e=this.stats.loadSuccess+this.stats.loadFailed,a=e>0?Math.round(this.stats.loadSuccess/e*100):0;return{size:this.cache.size,maxSize:this.config.maxCacheSize,hitRate:t,successRate:a}}getPerformanceStats(){return{...this.stats}}resetStats(){this.stats={totalRequests:0,cacheHits:0,loadSuccess:0,loadFailed:0,totalLoadTime:0,averageLoadTime:0,totalSize:0,averageSize:0,cacheHitRate:0,successRate:0,preloadCount:0,preloadHitCount:0,preloadHitRate:0}}}const y=new f;export{y as i};
