<!DOCTYPE html>
<html>
<head>
  <title>版本检查测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>积分商城版本检查测试</h1>
    
    <div class="test-section">
      <h2>测试说明</h2>
      <p>这个测试页面会模拟旧版本的数据，然后加载商品服务来验证版本检查功能是否正常工作。</p>
    </div>

    <div class="test-section">
      <h2>测试结果</h2>
      <div id="output">
        <p class="info">正在执行测试...</p>
      </div>
    </div>

    <div class="test-section">
      <h2>当前数据状态</h2>
      <div id="data-status">
        <p class="info">等待测试完成...</p>
      </div>
    </div>
  </div>

  <script type="module">
    // 模拟商品服务类
    class MockProductService {
      constructor() {
        this.PRODUCTS_KEY = 'SECURE_PRODUCTS';
        this.PRODUCTS_VERSION_KEY = 'SECURE_PRODUCTS_VERSION';
        this.CURRENT_VERSION = 2;
        this.loadProducts();
      }

      loadProducts() {
        try {
          const stored = localStorage.getItem(this.PRODUCTS_KEY);
          const storedVersion = localStorage.getItem(this.PRODUCTS_VERSION_KEY);
          
          if (stored && storedVersion === String(this.CURRENT_VERSION)) {
            this.products = JSON.parse(stored);
          } else {
            localStorage.removeItem(this.PRODUCTS_KEY);
            localStorage.setItem(this.PRODUCTS_VERSION_KEY, String(this.CURRENT_VERSION));
            this.initializeDefaultProducts();
          }
        } catch (error) {
          console.error('Failed to load products:', error);
          this.initializeDefaultProducts();
        }
      }

      initializeDefaultProducts() {
        this.products = [
          {
            id: 1,
            name: '虚拟红包',
            description: '1000积分兑换10元虚拟红包',
            points: 1000,
            stock: 100,
            status: 'active',
            category: 'virtual',
            tags: ['红包', '虚拟'],
            imageUrl: '/images/红包.svg',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          },
          {
            id: 2,
            name: '创意贴纸包',
            description: '500积分兑换创意贴纸包',
            points: 500,
            stock: 50,
            status: 'active',
            category: 'virtual',
            tags: ['贴纸', '虚拟'],
            imageUrl: '/images/周边商品.svg',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          }
        ];
        this.saveProducts();
      }

      saveProducts() {
        try {
          localStorage.setItem(this.PRODUCTS_KEY, JSON.stringify(this.products));
        } catch (error) {
          console.error('Failed to save products:', error);
        }
      }

      getAllProducts() {
        return [...this.products];
      }
    }

    // 执行测试
    async function runTest() {
      const output = document.getElementById('output');
      const dataStatus = document.getElementById('data-status');
      
      try {
        // 1. 清理现有数据
        localStorage.removeItem('SECURE_PRODUCTS');
        localStorage.removeItem('SECURE_PRODUCTS_VERSION');
        
        // 2. 设置旧版本数据
        const oldProducts = [{ id: 1, name: '旧版本商品', description: '这是旧版本的数据' }];
        localStorage.setItem('SECURE_PRODUCTS', JSON.stringify(oldProducts));
        localStorage.setItem('SECURE_PRODUCTS_VERSION', '1');
        
        output.innerHTML = '<p class="info">✓ 已设置旧版本数据 (版本 1)</p>';
        
        // 3. 创建商品服务实例
        const productService = new MockProductService();
        
        // 4. 检查版本更新
        const newVersion = localStorage.getItem('SECURE_PRODUCTS_VERSION');
        const products = JSON.parse(localStorage.getItem('SECURE_PRODUCTS') || '[]');
        
        output.innerHTML += `<p class="info">✓ 当前版本: ${newVersion}</p>`;
        output.innerHTML += `<p class="info">✓ 商品数量: ${products.length}</p>`;
        
        // 5. 验证测试结果
        if (newVersion === '2' && products.length === 2) {
          output.innerHTML += '<p class="success">✓ 版本检查功能正常工作！</p>';
          output.innerHTML += '<p class="success">✓ 数据已成功从版本 1 更新到版本 2</p>';
        } else {
          output.innerHTML += '<p class="error">✗ 版本检查功能异常</p>';
        }
        
        // 显示当前数据状态
        dataStatus.innerHTML = '<h3>当前商品列表:</h3>';
        products.forEach(product => {
          dataStatus.innerHTML += `<p>• ${product.name} (${product.points || 0}积分)</p>`;
        });
        
      } catch (error) {
        output.innerHTML = `<p class="error">测试失败: ${error.message}</p>`;
        console.error('Test error:', error);
      }
    }

    // 页面加载后运行测试
    window.addEventListener('DOMContentLoaded', runTest);
  </script>
</body>
</html>