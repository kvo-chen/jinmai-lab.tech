## 目标
- 完善平台的“大语言模型设置”，提升可用性与可控性（含 Kimi）。
- 增强配置项、持久化、校验与错误提示；支持更丰富的模型选项与流式输出。

## 现状简述
- 已有模型选择面板与基础参数：`temperature`、`top_p`、`max_tokens`、`timeout`，并可输入 `Kimi` 密钥与调用 Moonshot API（前端直连）。
- 需要完善：配置持久化、参数校验、Kimi 规格选择、系统提示词、上下文管理、流式输出、错误与配额提示、安全建议等。

## 交互与持久化
1. 在模型选择面板保存：当前模型与所有配置项（含 Kimi 密钥/规格），统一持久化到 `localStorage`。
2. 打开面板时自动读取并填充；首次加载时也应用已保存配置。
3. 提供“恢复默认”按钮（重置为安全默认）。

## Kimi 专属设置
1. 模型规格选择：`moonshot-v1-8k`、`moonshot-v1-32k`、`moonshot-v1-128k`（或 K2 系列别名），用于不同上下文长度与成本场景。[1][2]
2. 基础地址切换：`https://api.moonshot.ai/v1`（全球）与 `https://api.moonshot.cn/v1`（中国）。在 UI 中提供 Base URL 下拉或自动根据网络/用户选择。[1]
3. 密钥输入体验：
   - 掩码显示与一键清除；
   - 粘贴后格式校验（以 `sk-` 开头）；
   - 优先环境变量，其次本地存储；清晰提示密钥不被提交。
4. 请求参数映射：将面板参数映射到 Kimi 的 `chat/completions`。

## 通用高级设置
1. 系统提示词：可编辑并持久化，用于对话风格与角色设定。
2. 历史上下文：
   - `maxHistoryLength` 滑块；
   - “清空对话”与“锁定系统提示”的开关。
3. 输出控制：停止词、最大输出长度上限、`presence_penalty`/`frequency_penalty`（若模型支持则暴露）。
4. 流式输出：提供开关；前端展示增量文本（更快的交互体验）。Kimi 支持流式响应（SSE/流参数）。[1]
5. 超时与重试：
   - 将默认超时提高到 30s；
   - 指数退避重试（最多 2-3 次），对请求失败给出明确提示。

## 错误与配额提示
- 明确的错误提示卡片：网络错误、鉴权错误、配额不足、参数错误；展示 HTTP 状态与简化原因。
- 对 `max_tokens` 与上下文体量预估（简单估算 token），超出风险提前警示。

## 安全与架构建议
- 生产建议改为后端代理（隐藏密钥、统一重试/审计/限流），前端仅调用自有 API；保留前端直连仅用于开发体验。[1][2]

## 前端实现点（不立即改动，待确认后执行）
- `src/components/ModelSelector.tsx`：
  - 新增字段：系统提示词、历史长度、流式开关、Kimi 模型规格与 Base URL；
  - 输入校验与错误提示；
  - 读写持久化逻辑与“恢复默认”。
- `src/services/llmService.ts`：
  - 扩展配置结构体；
  - Kimi 调用支持 Base URL/规格参数与重试；
  - 可选流式模式（提供事件/回调接口）。
- `src/components/LLMCommandPanel.tsx`：
  - 增量渲染（流式模式）；
  - 清空历史与系统提示词注入；
  - 更细致的错误反馈。

## 验证方案
- 本地：切换不同模型与配置，发送多轮对话，验证参数生效与持久化；
- Kimi：分别测试 8k/32k/128k 与两种 Base URL 成功返回；
- 流式：启用开关，观察增量输出；
- 错误：人为设置错误密钥/超时，检查提示是否合理。

## 风险与兼容性
- 增加配置字段需保持默认值安全；
- 流式模式对 UI 有依赖，确保回退为非流式时仍稳定；
- 生产直连风险，需要后端代理时另行实施。

## 交付物
- 完整的模型设置面板增强与服务层扩展；
- 流式输出支持与更完善的错误/校验体验；
- 文档化的使用说明（面板内就地提示）。

## 参考
- [1] Moonshot AI API 支持与流式说明（LiteLLM 提供的 Moonshot 集成文档）: https://docs.litellm.ai/docs/providers/moonshot
- [2] Moonshot AI 开放平台（模型/API 基本信息与中国区/全球区基址）: https://platform.moonshot.ai/