## 完善收藏功能 - 支持多用户收藏

### 1. 优化目标
- 为收藏功能添加用户关联，支持多用户收藏
- 确保每个用户只能看到和管理自己的收藏
- 保持向后兼容性
- 提高收藏功能的安全性和可靠性

### 2. 具体优化措施

#### 2.1 更新数据库结构
- **文件修改**：`server/db.mjs`
- **优化内容**：
  - 修改`favorites`表结构，添加`user_id`字段
  - 建立`favorites.user_id`与`users.id`的外键关联
  - 为`favorites`表添加复合主键（`user_id`, `tutorial_id`）
  - 添加索引优化查询性能
  - 更新数据库迁移脚本

#### 2.2 更新数据库操作函数
- **文件修改**：`server/db.mjs`
- **优化内容**：
  - 更新`getFavoriteTutorialIds`函数，添加`user_id`参数
  - 更新`toggleFavoriteTutorial`函数，添加`user_id`参数
  - 确保收藏操作与特定用户关联
  - 增强错误处理和日志记录

#### 2.3 更新API端点
- **文件修改**：`server/local-api.mjs`
- **优化内容**：
  - 更新收藏相关API端点，添加用户认证
  - 从JWT令牌中获取当前用户ID
  - 确保收藏操作与当前登录用户关联
  - 更新API响应格式，保持向后兼容

#### 2.4 更新前端代码
- **文件修改**：相关前端组件和API调用
- **优化内容**：
  - 更新收藏功能的API调用，传递认证令牌
  - 确保收藏状态与当前用户关联
  - 保持与现有UI的兼容性

### 3. 实施步骤
1. 更新数据库结构和迁移脚本
2. 更新数据库操作函数
3. 更新API端点，添加用户认证
4. 测试API端点功能
5. 更新前端代码（如果需要）
6. 进行完整的功能测试

### 4. 预期效果
- 支持多用户收藏，每个用户只能看到自己的收藏
- 提高收藏功能的安全性和可靠性
- 保持与现有代码的向后兼容性
- 提供更好的用户体验

### 5. 向后兼容性
- 对于未登录用户，收藏功能将保持原有行为
- 对于已登录用户，收藏功能将与用户关联
- 现有收藏数据将被保留，并关联到默认用户

### 6. 安全性考虑
- 使用JWT认证确保只有授权用户可以访问自己的收藏
- 实现输入验证，防止无效数据
- 增强错误处理，防止SQL注入和其他安全问题

这个计划将确保收藏功能支持多用户，提高系统的安全性和可靠性，同时保持与现有代码的兼容性。