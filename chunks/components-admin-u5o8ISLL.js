import{r as e,j as t,u as r,N as a}from"./vendor-react-7rlDZYVK.js";import{c as s}from"./db-libs-D0Hh-v_I.js";const i={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_SUPABASE_ANON_KEY:"sb_publishable_AYUZnzF2LNBPXi2o_3LGbA_7ceksBnv",VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY:"sb_publishable_AYUZnzF2LNBPXi2o_3LGbA_7ceksBnv",VITE_SUPABASE_URL:"https://pptqdicaaewtnaiflfcs.supabase.co"};var n={};const o=e=>e?e.trim().replace(/^[\s"'`]+|[\s"'`]+$/g,""):"",u=e=>{try{if(void 0!==import.meta)return i?.[e];if("undefined"!=typeof window&&window.env)return window.env[e];if("undefined"!=typeof process&&n)return n[e]}catch(t){}},m=o(u("NEXT_PUBLIC_SUPABASE_URL"))||o(u("VITE_SUPABASE_URL"))||o(u("SUPABASE_URL")),c=o(u("NEXT_PUBLIC_SUPABASE_ANON_KEY"))||o(u("VITE_SUPABASE_ANON_KEY"))||o(u("SUPABASE_ANON_KEY"))||o(u("NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY"))||o(u("VITE_SUPABASE_PUBLISHABLE_DEFAULT_KEY"))||o(u("NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY"))||o(u("SUPABASE_PUBLISHABLE_KEY")),h=()=>{try{if(void 0!==import.meta)return!1;if("undefined"!=typeof window&&window.env)return"development"===window.env.NODE_ENV;if("undefined"!=typeof process&&n)return!1}catch(e){}return!1};m||h(),c||h(),m&&c&&h();let d=null;try{if(m&&c){let e=!1;try{new URL(m),e=!0}catch(_){e=!1}if(e&&c.length>=30)try{const e={auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,...(c.startsWith("sb_publishable_")||c.startsWith("sb_secret_"))&&{endpoints:{signUp:`${m}/auth/v1/signup`,signIn:`${m}/auth/v1/token?grant_type=password`,refreshToken:`${m}/auth/v1/token?grant_type=refresh_token`,signOut:`${m}/auth/v1/logout`,getUser:`${m}/auth/v1/user`,resetPasswordForEmail:`${m}/auth/v1/recover`,updateUser:`${m}/auth/v1/user`,getSession:`${m}/auth/v1/session`}}}};d=s(m,c,e)}catch(y){d=null}else c.length,d=null}}catch(_){d=null}"undefined"!=typeof window&&(window.__SUPABASE__=d);const l=new class{ENCRYPTION_KEY="j9kL2pQ5rT8wZ1cV4xY7mU3tR6nH9bE2";SALT="f3s6v9yB2e5h8k0n3q6t9w2z5C8r1V4x7";MAX_CACHE_AGE=36e5;cryptoKey=null;constructor(){this.initializeCryptoKey()}async initializeCryptoKey(){try{"undefined"!=typeof window&&window.crypto&&window.crypto.subtle&&(this.cryptoKey=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]))}catch(_){}}async encryptWithWebCrypto(e){if(!this.cryptoKey)throw new Error("Crypto key not initialized");const t=(new TextEncoder).encode(e),r=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},this.cryptoKey,t);return{encrypted:btoa(String.fromCharCode(...new Uint8Array(a))),iv:btoa(String.fromCharCode(...r))}}async decryptWithWebCrypto(e,t){if(!this.cryptoKey)throw new Error("Crypto key not initialized");const r=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),a=Uint8Array.from(atob(t),e=>e.charCodeAt(0)),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:a},this.cryptoKey,r);return(new TextDecoder).decode(s)}async encrypt(e){const t=JSON.stringify(e),r=Date.now();try{if(this.cryptoKey){const{encrypted:e,iv:a}=await this.encryptWithWebCrypto(t);return{data:e,timestamp:r,signature:this.generateSignature(e,r),iv:a}}}catch(_){}let a="";for(let i=0;i<t.length;i++){const e=t.charCodeAt(i)^this.ENCRYPTION_KEY.charCodeAt(i%this.ENCRYPTION_KEY.length);a+=String.fromCharCode(e)}const s=btoa(a);return{data:s,timestamp:r,signature:this.generateSignature(s,r)}}async decrypt(e){const{data:t,timestamp:r,signature:a,iv:s}=e;if(!this.verifySignature(t,r,a))throw new Error("数据已被篡改");if(Date.now()-r>this.MAX_CACHE_AGE)throw new Error("数据已过期");try{if(this.cryptoKey&&s){const e=await this.decryptWithWebCrypto(t,s);return JSON.parse(e)}}catch(_){}const i=atob(t);let n="";for(let o=0;o<i.length;o++){const e=i.charCodeAt(o)^this.ENCRYPTION_KEY.charCodeAt(o%this.ENCRYPTION_KEY.length);n+=String.fromCharCode(e)}return JSON.parse(n)}generateSignature(e,t){const r=`${e}${t}${this.SALT}`;return this.hash(r)}verifySignature(e,t,r){return this.generateSignature(e,t)===r}hash(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r),t&=t;return Math.abs(t).toString(16)}verifyDataIntegrity(e,t){return typeof e===t}detectCheating(e){try{const e=localStorage.getItem("POINTS_RECORDS");if(e){const t=JSON.parse(e);if(!Array.isArray(t))return!0;for(const e of t)if(!e.id||!e.source||!e.type||void 0===e.points)return!0}const t=localStorage.getItem("CREATIVE_TASKS");if(t){const e=JSON.parse(t);if(!Array.isArray(e))return!0}const r=localStorage.getItem("CHECKIN_RECORDS");if(r){const e=JSON.parse(r);if(!Array.isArray(e))return!0}return!1}catch(_){return!0}}async getSecureItem(e){try{const t=localStorage.getItem(e);if(t){const e=JSON.parse(t);return await this.decrypt(e)}return null}catch(_){return localStorage.removeItem(e),null}}async setSecureItem(e,t){try{const r=await this.encrypt(t);localStorage.setItem(e,JSON.stringify(r))}catch(_){}}cleanupExpiredCache(){const e=Date.now();for(let t=0;t<localStorage.length;t++){const r=localStorage.key(t);if(r&&(r.includes("SECURE_")||r.includes("_SECURE")))try{const t=localStorage.getItem(r);t&&e-JSON.parse(t).timestamp>this.MAX_CACHE_AGE&&localStorage.removeItem(r)}catch(_){localStorage.removeItem(r)}}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}},p=e.createContext({isAuthenticated:!1,user:null,login:async()=>!1,register:async()=>({success:!1,error:"默认注册方法未实现"}),logout:()=>{},setIsAuthenticated:()=>{},quickLogin:async()=>!1,updateUser:()=>{},updateMembership:async()=>!1,checkMembershipStatus:()=>!1,getMembershipBenefits:()=>[],enableTwoFactorAuth:async()=>!1,verifyTwoFactorCode:async()=>!1,refreshToken:async()=>!1}),S=({children:r})=>{const[a,s]=e.useState(()=>!!localStorage.getItem("token")||"true"===localStorage.getItem("isAuthenticated")),[i,n]=e.useState(()=>{const e=localStorage.getItem("user");if(e)try{const t=JSON.parse(e),r=t.avatar&&t.avatar.trim()?t.avatar:"https://picsum.photos/id/1005/200/200";return{...t,avatar:r,membershipLevel:t.membershipLevel||"free",membershipStatus:t.membershipStatus||"active",membershipStart:t.membershipStart||(new Date).toISOString()}}catch(_){return localStorage.removeItem("user"),null}return null});e.useEffect(()=>{if(a&&i&&"https://picsum.photos/id/1005/200/200"!==i.avatar){const e={...i,avatar:"https://picsum.photos/id/1005/200/200"};localStorage.setItem("user",JSON.stringify(e)),n(e)}},[a,i]),e.useEffect(()=>{(async()=>{try{if(d){const{data:{session:e}}=await d.auth.getSession();if(e&&e.user){const t="https://picsum.photos/id/1005/200/200",r={id:e.user.id,username:e.user.user_metadata?.username||e.user.email?.split("@")[0]||"用户",email:e.user.email||"",avatar:t,phone:e.user.user_metadata?.phone||"",interests:e.user.user_metadata?.interests||[],isAdmin:e.user.user_metadata?.isAdmin||!1,age:e.user.user_metadata?.age||0,tags:e.user.user_metadata?.tags||[],membershipLevel:e.user.user_metadata?.membershipLevel||"free",membershipStart:e.user.user_metadata?.membershipStart||(new Date).toISOString(),membershipEnd:e.user.user_metadata?.membershipEnd,membershipStatus:e.user.user_metadata?.membershipStatus||"active"};localStorage.setItem("user",JSON.stringify(r)),n(r),s(!0)}else localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),s(!1),n(null)}else{const e=localStorage.getItem("user");if(e)try{const t={...JSON.parse(e),avatar:"https://picsum.photos/id/1005/200/200"};localStorage.setItem("user",JSON.stringify(t)),n(t),s(!0)}catch(_){localStorage.removeItem("user"),s(!1),n(null)}else s(!1),n(null)}}catch(_){localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),s(!1),n(null)}})();let e=null;if(d){const{data:t}=d.auth.onAuthStateChange((e,t)=>{if("SIGNED_IN"===e&&t?.user){const e="https://picsum.photos/id/1005/200/200",r={id:t.user.id,username:t.user.user_metadata?.username||t.user.email?.split("@")[0]||"用户",email:t.user.email||"",avatar:e,phone:t.user.user_metadata?.phone||"",interests:t.user.user_metadata?.interests||[],isAdmin:t.user.user_metadata?.isAdmin||!1,age:t.user.user_metadata?.age||0,tags:t.user.user_metadata?.tags||[],membershipLevel:t.user.user_metadata?.membershipLevel||"free",membershipStart:t.user.user_metadata?.membershipStart||(new Date).toISOString(),membershipEnd:t.user.user_metadata?.membershipEnd,membershipStatus:t.user.user_metadata?.membershipStatus||"active"};localStorage.setItem("user",JSON.stringify(r)),n(r),s(!0)}else"SIGNED_OUT"===e&&(localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),s(!1),n(null))});e=t.subscription}return()=>{e&&e.unsubscribe()}},[d]);const o=async()=>{try{d&&await d.auth.signOut()}catch(_){}s(!1),n(null),localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("user"),localStorage.removeItem("isAuthenticated"),l.setSecureItem("SECURE_TOKEN",""),l.setSecureItem("SECURE_REFRESH_TOKEN",""),l.setSecureItem("SECURE_USER",null)},u=e=>{n(t=>{const r={...t||{},...e};try{localStorage.setItem("user",JSON.stringify(r)),l.setSecureItem("SECURE_USER",r)}catch(_){}return r})},m={isAuthenticated:a,user:i,login:async(e,t)=>{try{if(!/^(?=.*[a-zA-Z])(?=.*\d)[A-Za-z\d@$!%*?&]{8,}$/.test(t))return!1;if(d)try{const{data:r,error:a}=await d.auth.signInWithPassword({email:e,password:t});if(a);else if(r.user){const e="https://picsum.photos/id/1005/200/200",t={id:r.user.id,username:r.user.user_metadata?.username||r.user.email?.split("@")[0]||"用户",email:r.user.email||"",avatar:e,phone:r.user.user_metadata?.phone||"",interests:r.user.user_metadata?.interests||[],isAdmin:r.user.user_metadata?.isAdmin||!1,age:r.user.user_metadata?.age||0,tags:r.user.user_metadata?.tags||[],membershipLevel:r.user.user_metadata?.membershipLevel||"free",membershipStart:r.user.user_metadata?.membershipStart||(new Date).toISOString(),membershipEnd:r.user.user_metadata?.membershipEnd,membershipStatus:r.user.user_metadata?.membershipStatus||"active"};return localStorage.setItem("user",JSON.stringify(t)),s(!0),n(t),!0}}catch(r){}const a={id:`mock-${Date.now()}`,username:e.split("@")[0]||"用户",email:e,avatar:"https://picsum.photos/id/1005/200/200",phone:"",interests:[],isAdmin:!1,age:0,tags:[],membershipLevel:"free",membershipStart:(new Date).toISOString(),membershipEnd:void 0,membershipStatus:"active"};return localStorage.setItem("user",JSON.stringify(a)),localStorage.setItem("token",`mock-token-${Date.now()}`),localStorage.setItem("isAuthenticated","true"),s(!0),n(a),!0}catch(_){return!1}},register:async(e,t,r,a,i)=>{try{if(!/^(?=.*[a-zA-Z])(?=.*\d)[A-Za-z\d@$!%*?&]{8,}$/.test(r))return{success:!1,error:"密码格式不符合要求：至少8个字符，包含至少一个字母和一个数字"};if(!d)return{success:!1,error:"Supabase客户端未配置，无法注册"};try{const{data:u,error:m}=await d.auth.signUp({email:t,password:r,options:{data:{username:e,age:a?parseInt(a):null,tags:i,membershipLevel:"free",membershipStatus:"active",membershipStart:(new Date).toISOString(),avatar:"https://picsum.photos/id/1005/200/200"},emailRedirectTo:window.location.origin}});if(m){let e=m.message;return"user_already_registered"===m.code?e="该邮箱已被注册":"invalid_password"===m.code?e="密码格式不符合要求":"invalid_email"===m.code&&(e="请输入有效的邮箱地址"),{success:!1,error:e}}if(!u)return{success:!1,error:"注册失败: 服务器返回无效数据"};if(u.user){const t=u.user.user_metadata?.avatar&&u.user.user_metadata?.avatar.trim()?u.user.user_metadata?.avatar:"https://picsum.photos/id/1005/200/200",r={id:u.user.id,username:u.user.user_metadata?.username||e,email:u.user.email||"",avatar:t,phone:u.user.user_metadata?.phone||"",interests:u.user.user_metadata?.interests||[],isAdmin:u.user.user_metadata?.isAdmin||!1,age:u.user.user_metadata?.age||(a?parseInt(a):0),tags:u.user.user_metadata?.tags||i||[],membershipLevel:u.user.user_metadata?.membershipLevel||"free",membershipStart:u.user.user_metadata?.membershipStart||(new Date).toISOString(),membershipEnd:u.user.user_metadata?.membershipEnd,membershipStatus:u.user.user_metadata?.membershipStatus||"active"};try{const t=u.user.user_metadata?.avatar&&u.user.user_metadata?.avatar.trim()?u.user.user_metadata?.avatar:"https://picsum.photos/id/1005/200/200",r={id:u.user.id,username:u.user.user_metadata?.username||e,email:u.user.email||"",avatar:t,phone:u.user.user_metadata?.phone||"",interests:u.user.user_metadata?.interests||[],is_admin:u.user.user_metadata?.isAdmin||!1,age:u.user.user_metadata?.age||(a?parseInt(a):0),tags:u.user.user_metadata?.tags||i||[],membership_level:u.user.user_metadata?.membershipLevel||"free",membership_status:u.user.user_metadata?.membershipStatus||"active",membership_start:u.user.user_metadata?.membershipStart||(new Date).toISOString(),membership_end:u.user.user_metadata?.membershipEnd};if(d){const{error:e}=await d.from("users").insert([r]);if(e){const{error:e}=await d.from("users").update(r).eq("id",u.user.id)}}}catch(o){}return localStorage.setItem("user",JSON.stringify(r)),localStorage.setItem("isAuthenticated","true"),s(!0),n(r),{success:!0}}return u.session,{success:!0}}catch(_){return{success:!1,error:_.message||"注册失败，请稍后重试"}}}catch(_){return{success:!1,error:_.message||"注册失败，请稍后重试"}}},logout:o,setIsAuthenticated:s,quickLogin:async e=>new Promise(t=>{setTimeout(()=>{const r="wechat"===e?"微信用户":"phone"===e?"手机号用户":"第三方用户",a={id:`quick-${e}-${Date.now()}`,username:r,email:`${e}-${Date.now()}@example.com`,avatar:"https://picsum.photos/id/1005/200/200",tags:["国潮爱好者"],membershipLevel:"free",membershipStart:(new Date).toISOString(),membershipStatus:"active"},i=`mock-token-${e}-${Date.now()}`,o=`mock-refresh-token-${e}-${Date.now()}`;l.setSecureItem("SECURE_TOKEN",i),l.setSecureItem("SECURE_REFRESH_TOKEN",o),localStorage.setItem("token",i),localStorage.setItem("refreshToken",o),localStorage.setItem("isAuthenticated","true"),localStorage.setItem("user",JSON.stringify(a)),s(!0),n(a),t(!0)},500)}),updateUser:u,updateMembership:async e=>{try{if(d){const{data:t,error:r}=await d.auth.updateUser({data:e});if(r)return u(e),!1;if(t.user){const e=t.user.user_metadata?.avatar&&t.user.user_metadata?.avatar.trim()?t.user.user_metadata?.avatar:"https://picsum.photos/id/1005/200/200",r={id:t.user.id,username:t.user.user_metadata?.username||t.user.email?.split("@")[0]||"用户",email:t.user.email||"",avatar:e,phone:t.user.user_metadata?.phone||"",interests:t.user.user_metadata?.interests||[],isAdmin:t.user.user_metadata?.isAdmin||!1,age:t.user.user_metadata?.age||0,tags:t.user.user_metadata?.tags||[],membershipLevel:t.user.user_metadata?.membershipLevel||"free",membershipStart:t.user.user_metadata?.membershipStart||(new Date).toISOString(),membershipEnd:t.user.user_metadata?.membershipEnd,membershipStatus:t.user.user_metadata?.membershipStatus||"active"};return u(r),!0}}return u(e),!0}catch(_){return u(e),!1}},checkMembershipStatus:()=>!!i&&("free"===i.membershipLevel||"active"===i.membershipStatus&&(!i.membershipEnd||new Date<=new Date(i.membershipEnd))),getMembershipBenefits:()=>{if(!i)return[];switch(i.membershipLevel){case"vip":return["无限AI生成次数","高级AI模型访问","高清作品导出","优先处理队列","专属模板库","去除水印","专属AI训练模型","一对一设计师服务","商业授权","专属活动邀请"];case"premium":return["无限AI生成次数","高级AI模型访问","高清作品导出","优先处理队列","专属模板库","去除水印"];default:return["基础AI创作功能","每天限量生成次数","基础社区功能","基础作品存储"]}},enableTwoFactorAuth:async()=>{try{return!0}catch(_){return!1}},verifyTwoFactorCode:async e=>{try{return!0}catch(_){return!1}},refreshToken:async()=>{try{if(d){const{data:e,error:t}=await d.auth.refreshSession();return t?(o(),!1):null!==e.session}return!1}catch(_){return o(),!1}}};return t.jsx(p.Provider,{value:m,children:r})},g=e.memo(({component:s,children:i})=>{const{isAuthenticated:n,user:o}=e.useContext(p),u=r();return!1!==n&&o?.isAdmin?void 0===n?null:i?t.jsx(t.Fragment,{children:i}):s?t.jsx(s,{}):null:t.jsx(a,{to:"/login",state:{from:u},replace:!0})});g.displayName="AdminRoute";export{p as A,d as a,g as b,S as c,l as s};
