import{r as e,t,j as s,m as i,A as a}from"./vendor-react-7rlDZYVK.js";import{u as l}from"./components-analytics-D0Glag6r.js";import{A as r}from"./components-admin-u5o8ISLL.js";import{L as n}from"./components-media-BNdY5qC-.js";const d=new class{prefix;constructor(e="jinmai_game"){this.prefix=e}save(e,t){try{const s={data:t,timestamp:Date.now()};localStorage.setItem(`${this.prefix}_${e}`,JSON.stringify(s))}catch(s){}}load(e,t){try{const t=localStorage.getItem(`${this.prefix}_${e}`);if(t)return JSON.parse(t).data}catch(s){}return t}clear(e){try{localStorage.removeItem(`${this.prefix}_${e}`)}catch(t){}}clearAll(){try{Object.keys(localStorage).forEach(e=>{e.startsWith(this.prefix)&&localStorage.removeItem(e)})}catch(e){}}getAllKeys(){try{return Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).map(e=>e.replace(`${this.prefix}_`,""))}catch(e){return[]}}},o=new class{questions=[];levels=[];gameProgress=new Map;nextQuestionId=1;nextLevelId=1;constructor(){this.initQuestions(),this.initLevels(),this.loadGameProgress()}initQuestions(){this.questions=[{id:"question-"+this.nextQuestionId++,type:"single",title:"天津文化常识",content:"天津的市花是什么？",options:["梅花","月季","菊花","牡丹"],correctAnswers:[1],explanation:"天津的市花是月季，象征着天津人民的热情和活力。",hint:"天津的市花是一种四季常开的花卉。",culturalTheme:"天津地方文化",category:"天津文化"},{id:"question-"+this.nextQuestionId++,type:"single",title:"天津传统小吃",content:'天津的传统名吃"狗不理包子"的创始人是谁？',options:["张三","李四","王五","高贵友"],correctAnswers:[3],explanation:'狗不理包子的创始人是高贵友，因其乳名"狗子"，且卖包子时忙于生意不与人说话，被顾客戏称为"狗不理"。',hint:'创始人的乳名是"狗子"。',culturalTheme:"天津地方文化",category:"天津美食"},{id:"question-"+this.nextQuestionId++,type:"multiple",title:"天津文化遗产",content:"以下哪些是天津的国家级非物质文化遗产？",options:["杨柳青年画","泥人张彩塑","天津相声","狗不理包子制作技艺"],correctAnswers:[0,1,2,3],explanation:"杨柳青年画、泥人张彩塑、天津相声和狗不理包子制作技艺均为天津的国家级非物质文化遗产。",hint:"这些都是天津的传统特色文化。",culturalTheme:"天津地方文化",category:"天津文化遗产"},{id:"question-"+this.nextQuestionId++,type:"judgment",title:"天津历史",content:"天津是中国北方最早开放的通商口岸之一。",correctAnswers:[0],explanation:"天津是中国北方最早开放的通商口岸之一，自1860年开埠以来，逐渐发展成为重要的工商业城市。",hint:"天津开埠时间较早。",culturalTheme:"天津地方文化",category:"天津历史"},{id:"question-"+this.nextQuestionId++,type:"single",title:"天津方言",content:'天津方言中"嘛意思"是什么意思？',options:["什么意思","没关系","不用谢","再见"],correctAnswers:[0],explanation:'"嘛意思"是天津方言中"什么意思"的常用表达。',hint:'"嘛"是天津方言中的疑问词。',culturalTheme:"天津地方文化",category:"天津方言"},{id:"question-"+this.nextQuestionId++,type:"single",title:"中国传统节日",content:"以下哪个节日是中国的传统节日？",options:["情人节","圣诞节","中秋节","感恩节"],correctAnswers:[2],explanation:"中秋节是中国的传统节日，每年农历八月十五，人们会赏月、吃月饼。",hint:"这个节日与月亮有关。",culturalTheme:"中国传统文化",category:"传统节日"},{id:"question-"+this.nextQuestionId++,type:"multiple",title:"中国传统绘画",content:"以下哪些是中国传统绘画的主要形式？",options:["国画","油画","水彩画","工笔画"],correctAnswers:[0,3],explanation:"国画和工笔画是中国传统绘画的主要形式，油画和水彩画是西方绘画形式。",hint:"这些是中国本土的绘画形式。",culturalTheme:"中国传统文化",category:"传统艺术"},{id:"question-"+this.nextQuestionId++,type:"judgment",title:"中国传统哲学",content:'儒家思想的核心是"仁、义、礼、智、信"。',correctAnswers:[0],explanation:'儒家思想的核心是"仁、义、礼、智、信"，这是中国传统文化的重要组成部分。',hint:"这是孔子思想的核心。",culturalTheme:"中国传统文化",category:"传统哲学"},{id:"question-"+this.nextQuestionId++,type:"single",title:"中国传统工艺",content:"青花瓷是中国哪个朝代的代表性瓷器？",options:["唐朝","宋朝","元朝","明朝"],correctAnswers:[2],explanation:"青花瓷起源于唐朝，但在元朝达到鼎盛，成为中国瓷器的代表品种之一。",hint:"这个朝代是蒙古族建立的。",culturalTheme:"中国传统文化",category:"传统工艺"},{id:"question-"+this.nextQuestionId++,type:"single",title:"中国传统医学",content:'中医理论中的"五脏六腑"不包括以下哪个器官？',options:["心脏","肝脏","脾脏","胰腺"],correctAnswers:[3],explanation:'中医理论中的"五脏"指心、肝、脾、肺、肾，"六腑"指胆、胃、小肠、大肠、膀胱、三焦，不包括胰腺。',hint:"这个器官在西医中很重要，但中医理论中没有单独列出。",culturalTheme:"中国传统文化",category:"传统医学"}]}initLevels(){this.levels=[{id:"level-"+this.nextLevelId++,name:"天津文化入门",description:"了解天津的基本文化常识",questions:this.questions.slice(0,5),gridSize:{rows:4,cols:4},difficulty:"easy",reward:"解锁天津文化素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20cultural%20heritage%20tourism"},{id:"level-"+this.nextLevelId++,name:"中国传统文化基础",description:"了解中国传统文化的基本常识",questions:this.questions.slice(5,10),gridSize:{rows:4,cols:4},difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁中国传统文化素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20traditional%20culture%20collection"},{id:"level-"+this.nextLevelId++,name:"文化知识挑战",description:"综合挑战天津文化和中国传统文化知识",questions:[...this.questions.slice(0,3),...this.questions.slice(5,8)],gridSize:{rows:4,cols:5},difficulty:"hard",unlockCondition:{type:"level",value:2},reward:"解锁高级文化素材包",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20cultural%20knowledge%20challenge"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getQuestions(){return[...this.questions]}getQuestionById(e){return this.questions.find(t=>t.id===e)}loadGameProgress(){const e=d.load("quiz_game_progress",new Map);e instanceof Map?this.gameProgress=e:this.gameProgress=new Map(Object.entries(e||{}))}saveGameProgress(){const e=Object.fromEntries(this.gameProgress.entries());d.save("quiz_game_progress",e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},unlockedHints:3,bestTimes:{},lastPlayed:new Date};this.gameProgress.set(e,t),this.saveGameProgress()}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),this.saveGameProgress(),s}checkAnswer(e,t){const s=[...e.correctAnswers].sort(),i=[...t].sort();if(s.length!==i.length)return!1;for(let a=0;a<s.length;a++)if(s[a]!==i[a])return!1;return!0}calculateQuestionScore(e,t,s){let i=0;return t&&(i=10,s&&s<10?i+=5:s&&s<20&&(i+=3),"multiple"===e.type?i+=5:"judgment"===e.type&&(i+=2)),i}calculateLevelScore(e,t,s,i){const a=e/t,l=Math.round(100*a),r={easy:.3,medium:.5,hard:.8}[i]||.5,n=20*t,d=Math.max(0,n-s)*r,o={easy:1,medium:1.2,hard:1.5}[i]||1;return Math.round((l+d)*o)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),this.saveGameProgress(),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),this.saveGameProgress(),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1}),this.saveGameProgress()}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},c=({isOpen:d,onClose:c})=>{const{isDark:m}=l(),{user:g}=e.useContext(r),[x,h]=e.useState("menu"),[u,p]=e.useState([]),[y,b]=e.useState(null),[f,v]=e.useState(0),[j,N]=e.useState(null),[w,k]=e.useState([]),[C,S]=e.useState(!1),[I,T]=e.useState(!1),[_,L]=e.useState(0),[P,$]=e.useState(null),[U,z]=e.useState(null),[D,H]=e.useState(null),[M,G]=e.useState(!1),[E,q]=e.useState(!0),[O,B]=e.useState(0);e.useEffect(()=>{if(d){q(!0);try{const e=o.getLevels();if(p(e),g){const e=o.getGameProgress(g.id);$(e)}}catch(e){}finally{q(!1)}}},[d,g]),e.useEffect(()=>{y&&(v(0),N(y.questions[0]),k([]),S(!1),T(!1),L(0),h("playing"),z(new Date),H(null),G(!1),B(0))},[y]),e.useEffect(()=>{y&&y.questions[f]&&(N(y.questions[f]),k([]),S(!1),T(!1),G(!1))},[y,f]),e.useEffect(()=>{let e;return U&&"playing"===x&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-U.getTime())/1e3);B(t)},1e3)),()=>clearInterval(e)},[U,x]);const W=e.useCallback(e=>{g?o.isLevelUnlocked(g.id,e.id)?b(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[g]),A=e.useCallback(e=>{C||j&&("single"===j.type?k([e]):k(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e]))},[j,C]),R=e.useCallback(()=>{if(!j||0===w.length)return void t.error("请选择答案！");const e=o.checkAnswer(j,w);S(!0),T(e),e?(L(e=>e+1),t.success("回答正确！")):t.error("回答错误")},[j,w]),Q=e.useCallback(()=>{y&&(f<y.questions.length-1?v(e=>e+1):V())},[f,y]),V=e.useCallback(()=>{if(!g||!y)return;const e=new Date,s=U?Math.round((e.getTime()-U.getTime())/1e3):0;H(s);const i=o.calculateLevelScore(_,y.questions.length,s,y.difficulty),a=o.completeLevel(g.id,y.id,i,s);$(a),h("completed"),t.success(`关卡完成！得分：${i}`)},[g,y,_,U]),F=e.useCallback(()=>{if(g&&P&&j)if(o.useHint(g.id)){G(!0);const e=o.getGameProgress(g.id);$(e),t.success("已显示提示")}else t.error("提示已用完")},[g,P,j]),Y=e.useCallback(()=>{h("menu"),b(null),N(null),v(0),k([]),S(!1),T(!1),L(0),z(null),H(null),G(!1),B(0)},[]),X=e.useCallback(()=>{y&&(v(0),N(y.questions[0]),k([]),S(!1),T(!1),L(0),h("playing"),z(new Date),H(null),G(!1),B(0))},[y]),J=e.useCallback(e=>{if(!e)return"00:00";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&c(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-2xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${m?"bg-gray-800":"bg-white"} text-${m?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${m?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化知识挑战"}),s.jsx("button",{onClick:c,className:`p-3 rounded-full text-xl ${m?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[E&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===x&&!E&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化知识挑战"}),s.jsx("p",{className:m?"text-gray-400":"text-gray-600",children:"测试你对天津地方文化和中国传统文化的了解"})]}),P&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(m?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:P.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:P.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:P.unlockedHints})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:u.length})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:u.map(e=>{const t=P?.completedLevels.includes(e.id)||!1,a=!g||o.isLevelUnlocked(g.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${m?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&W(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(m?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(m?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(m?"bg-gray-700":"bg-gray-100"),children:[e.questions.length," 题"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(m?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(m?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",J(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(m?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===x&&y&&j&&!E&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium",children:y.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:Y,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(m?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:F,disabled:!P||P.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${m?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",P?.unlockedHints||0,")"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"p-2 rounded-lg "+(m?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"题目进度"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-medium",children:f+1}),s.jsxs("span",{className:"text-xs",children:["/ ",y.questions.length]})]})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(m?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"正确题数"}),s.jsx("span",{className:"font-medium",children:_})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(m?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"用时"}),s.jsx("span",{className:"font-medium",children:J(O)})]})]})]}),s.jsxs("div",{className:"p-4 rounded-lg mb-4 "+(m?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h4",{className:"text-lg font-medium mb-2",children:j.title}),s.jsx("p",{className:"mb-4 "+(m?"text-gray-300":"text-gray-700"),children:j.content}),M&&j.hint&&s.jsx("div",{className:`p-3 rounded-lg mb-4 ${m?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${m?"border-yellow-700":"border-yellow-200"}`,children:s.jsxs("div",{className:"flex items-start",children:[s.jsx("i",{className:"fas fa-lightbulb text-yellow-500 mt-1 mr-2"}),s.jsx("p",{className:"text-sm "+(m?"text-yellow-200":"text-yellow-800"),children:j.hint})]})}),s.jsx("div",{className:"space-y-3",children:j.options?.map((e,t)=>s.jsx(i.button,{className:`w-full p-3 rounded-lg text-left transition-all ${m?"bg-gray-800 hover:bg-gray-700":"bg-white hover:bg-gray-50"} border ${m?"border-gray-700":"border-gray-200"} ${w.includes(t)?C?I?"border-green-500 bg-green-500 bg-opacity-10":"border-red-500 bg-red-500 bg-opacity-10":"border-blue-500 bg-blue-500 bg-opacity-10":""} ${C&&j.correctAnswers.includes(t)?"border-green-500 bg-green-500 bg-opacity-10":""}`,whileHover:0===w.length?{scale:1.02}:{},onClick:()=>A(t),disabled:C,children:s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center mr-3 border "+(w.includes(t)?C?I?"border-green-500 bg-green-500 text-white":"border-red-500 bg-red-500 text-white":"border-blue-500 bg-blue-500 text-white":C&&j.correctAnswers.includes(t)?"border-green-500 bg-green-500 text-white":m?"border-gray-600":"border-gray-300"),children:String.fromCharCode(65+t)}),s.jsx("span",{children:e})]})},t))}),C&&s.jsxs("div",{className:`mt-4 p-3 rounded-lg ${I?m?"bg-green-900 bg-opacity-30":"bg-green-100":m?"bg-red-900 bg-opacity-30":"bg-red-100"} border ${I?m?"border-green-700":"border-green-200":m?"border-red-700":"border-red-200"}`,children:[s.jsx("h5",{className:"font-medium mb-2",children:"答案解析"}),s.jsx("p",{className:m?"text-gray-300":"text-gray-700",children:j.explanation})]})]}),s.jsx("div",{className:"flex justify-end gap-3",children:C?s.jsx("button",{onClick:Q,className:`px-4 py-2 rounded-lg transition-colors ${m?"bg-green-600 hover:bg-green-700":"bg-green-500 hover:bg-green-600"} text-white`,children:f<y.questions.length-1?"下一题":"完成关卡"}):s.jsx("button",{onClick:R,disabled:0===w.length,className:`px-4 py-2 rounded-lg transition-colors ${m?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:"提交答案"})})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===x&&y&&P&&!E&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(m?"text-gray-400":"text-gray-600"),children:["你成功完成了「",y.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(m?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:P.levelScores[y.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:J(D||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsxs("p",{className:"text-xl font-bold",children:[Math.round(_/y.questions.length*100),"%"]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(m?"text-gray-400":"text-gray-600"),children:"正确题数"}),s.jsxs("p",{className:"text-xl font-bold",children:[_," / ",y.questions.length]})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${m?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${m?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:m?"text-yellow-200":"text-yellow-800",children:y.reward})]}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx("button",{onClick:X,className:"px-4 py-2 rounded-lg transition-colors "+(m?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:Y,className:`px-4 py-2 rounded-lg transition-colors ${m?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},m=new class{cardDatabase=[];levels=[];gameProgress=new Map;nextCardId=1;nextLevelId=1;constructor(){this.initCardDatabase(),this.initLevels(),this.loadGameProgress()}initCardDatabase(){[{name:"天津之眼",description:"天津标志性建筑，是世界上唯一一个桥上瞰景摩天轮。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Tianjin%20Eye%20ferris%20wheel%20night%20view",culturalTheme:"天津地方文化",category:"地标建筑"},{name:"杨柳青年画",description:"中国著名的民间木版年画，源于天津杨柳青镇。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Yangliuqing%20New%20Year%20paintings%20traditional%20Chinese%20folk%20art",culturalTheme:"天津地方文化",category:"传统艺术"},{name:"泥人张彩塑",description:"天津传统民间艺术，以泥塑造各种人物形象。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Nirenzhang%20clay%20sculptures%20traditional%20Tianjin%20art",culturalTheme:"天津地方文化",category:"传统工艺"},{name:"狗不理包子",description:"天津传统名吃，以皮薄馅大、味道鲜美著称。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Goubuli%20steamed%20buns%20traditional%20Tianjin%20food",culturalTheme:"天津地方文化",category:"传统美食"},{name:"天津相声",description:"中国北方传统曲艺形式，天津是相声的重要发源地。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Tianjin%20cross-talk%20traditional%20Chinese%20comedy",culturalTheme:"天津地方文化",category:"传统曲艺"},{name:"瓷房子",description:"天津特色建筑，用数万件古董瓷器装饰而成。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Porcelain%20House%20Tianjin%20China%20unique%20architecture",culturalTheme:"天津地方文化",category:"特色建筑"},{name:"古文化街",description:"天津著名的文化旅游街区，展示传统民俗文化。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Tianjin%20Ancient%20Culture%20Street%20traditional%20architecture",culturalTheme:"天津地方文化",category:"文化街区"},{name:"麻花",description:"天津传统小吃，酥脆香甜，造型独特。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Tianjin%20twisted%20dough%20sticks%20traditional%20snack",culturalTheme:"天津地方文化",category:"传统美食"},{name:"京剧脸谱",description:"京剧艺术中的重要元素，通过不同颜色和图案表达人物性格。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Peking%20Opera%20facial%20makeup%20traditional%20Chinese%20art",culturalTheme:"中国传统文化",category:"传统艺术"},{name:"故宫",description:"中国明清两代的皇家宫殿，世界上现存规模最大、保存最为完整的木质结构古建筑之一。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Forbidden%20City%20Beijing%20China%20ancient%20palace",culturalTheme:"中国传统文化",category:"历史建筑"},{name:"长城",description:"中国古代的军事防御工程，是世界七大奇迹之一。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Great%20Wall%20of%20China%20mountain%20scenery",culturalTheme:"中国传统文化",category:"历史遗迹"},{name:"兵马俑",description:'秦始皇陵中的陶俑群，被誉为"世界第八大奇迹"。',imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Terracotta%20Army%20Xi%27an%20China%20ancient%20sculptures",culturalTheme:"中国传统文化",category:"历史文物"},{name:"青花瓷",description:"中国传统瓷器工艺，以白地蓝花为主要特征。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Blue%20and%20white%20porcelain%20traditional%20Chinese%20craft",culturalTheme:"中国传统文化",category:"传统工艺"},{name:"书法",description:"中国特有的传统艺术，通过汉字的书写表现美感。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20calligraphy%20traditional%20art%20brush%20writing",culturalTheme:"中国传统文化",category:"传统艺术"},{name:"剪纸",description:"中国传统民间艺术，用剪刀或刻刀在纸上剪刻图案。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20paper%20cutting%20traditional%20folk%20art",culturalTheme:"中国传统文化",category:"传统工艺"},{name:"中国结",description:"中国传统手工艺品，象征着团结、幸福和吉祥。",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20knot%20traditional%20decoration%20red%20thread",culturalTheme:"中国传统文化",category:"传统工艺"}].forEach(e=>{const t=`pair-${this.nextCardId}`;for(let s=0;s<2;s++)this.cardDatabase.push({id:`card-${this.nextCardId}-${s+1}`,pairId:t,name:e.name,description:e.description,imageUrl:e.imageUrl,culturalTheme:e.culturalTheme,category:e.category,isFlipped:!1,isMatched:!1,isSelected:!1});this.nextCardId++})}initLevels(){const e=this.getShuffledCards(8),t=this.getShuffledCards(12),s=this.getShuffledCards(16);this.levels=[{id:"memory-level-"+this.nextLevelId++,name:"文化记忆入门",description:"了解天津和中国传统文化的基本元素",cards:e,gridSize:{rows:4,cols:4},difficulty:"easy",timeLimit:180,reward:"解锁文化记忆入门徽章",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Memory%20game%20easy%20level%20cultural%20elements"},{id:"memory-level-"+this.nextLevelId++,name:"文化记忆挑战",description:"挑战你的文化记忆能力，识别更多文化元素",cards:t,gridSize:{rows:6,cols:6},difficulty:"medium",unlockCondition:{type:"level",value:1},timeLimit:300,reward:"解锁文化记忆挑战徽章",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Memory%20game%20medium%20level%20cultural%20elements"},{id:"memory-level-"+this.nextLevelId++,name:"文化记忆大师",description:"成为文化记忆大师，挑战最难的记忆关卡",cards:s,gridSize:{rows:8,cols:8},difficulty:"hard",unlockCondition:{type:"level",value:2},timeLimit:600,reward:"解锁文化记忆大师徽章",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Memory%20game%20hard%20level%20cultural%20elements"}]}getShuffledCards(e){const t=this.nextCardId-1,s=Math.min(e,t),i=Array.from({length:t},(e,t)=>`pair-${t+1}`),a=this.shuffleArray(i),l=new Set(a.slice(0,s)),r=this.cardDatabase.filter(e=>l.has(e.pairId));return this.shuffleArray([...r]).map(e=>({...e,isFlipped:!1,isMatched:!1,isSelected:!1}))}shuffleArray(e){const t=[...e];for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getLevelCards(e){const t=this.getLevelById(e);if(t)return JSON.parse(JSON.stringify(t.cards))}loadGameProgress(){const e=d.load("memory_game_progress",new Map);e instanceof Map?this.gameProgress=e:this.gameProgress=new Map(Object.entries(e||{}))}saveGameProgress(){const e=Object.fromEntries(this.gameProgress.entries());d.save("memory_game_progress",e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},bestTimes:{},lastPlayed:new Date};this.gameProgress.set(e,t),this.saveGameProgress()}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),this.saveGameProgress(),s}calculateScore(e,t,s,i){const a=e/t,l=Math.round(1e3*a),r={easy:.5,medium:1,hard:1.5}[i],n=t*{easy:10,medium:8,hard:6}[i],d=Math.max(0,n-s)*r,o={easy:1,medium:1.5,hard:2}[i];return Math.round((l+d)*o)}completeLevel(e,t,s,i){const a=this.getGameProgress(e);if(!this.getLevelById(t))return a;const l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),this.saveGameProgress(),r}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},g=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:g}=e.useContext(r),[x,h]=e.useState("menu"),[u,p]=e.useState([]),[y,b]=e.useState(null),[f,v]=e.useState([]),[j,N]=e.useState([]),[w,k]=e.useState(0),[C,S]=e.useState(!1),[I,T]=e.useState(null),[_,L]=e.useState(0),[P,$]=e.useState(null),[U,z]=e.useState(null),[D,H]=e.useState(!0);e.useEffect(()=>{if(d){H(!0);try{const e=m.getLevels();if(p(e),g){const e=m.getGameProgress(g.id);z(e)}}catch(e){}finally{H(!1)}}},[d,g]),e.useEffect(()=>{let e;return I&&"playing"===x&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-I.getTime())/1e3);L(t)},1e3)),()=>clearInterval(e)},[I,x]),e.useEffect(()=>{if(y){const e=m.getLevelCards(y.id);e&&(v(e),N([]),k(0),h("playing"),T(new Date),L(0),$(null),S(!1))}},[y]),e.useEffect(()=>{if(y&&"playing"===x){const e=y.cards.length/2;w===e&&E()}},[w,y,x]);const M=e.useCallback(e=>{g?m.isLevelUnlocked(g.id,e.id)?b(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[g]),G=e.useCallback(e=>{"playing"!==x||C||e.isFlipped||e.isMatched||j.length>=2||(v(t=>t.map(t=>t.id===e.id?{...t,isFlipped:!0}:t)),N(s=>{const i=[...s,{...e,isFlipped:!0}];if(2===i.length){S(!0);const[e,s]=i,a=e.pairId===s.pairId;setTimeout(()=>{v(i=>{if(a){const s=i.map(t=>t.pairId===e.pairId?{...t,isMatched:!0,isFlipped:!0}:t);return k(e=>e+1),t.success("配对成功！"),s}return i.map(t=>t.id===e.id||t.id===s.id?{...t,isFlipped:!1}:t)}),N([]),S(!1)},800)}return i}))},[x,C]),E=e.useCallback(()=>{if(!g||!y)return;const e=new Date,s=I?Math.round((e.getTime()-I.getTime())/1e3):0;$(s);const i=y.cards.length/2,a=m.calculateScore(w,i,s,y.difficulty),l=m.completeLevel(g.id,y.id,a,s);z(l),h("completed"),t.success(`关卡完成！得分：${a}`)},[g,y,w,I]),q=e.useCallback(()=>{h("menu"),b(null),v([]),N([]),k(0),T(null),L(0),$(null),S(!1)},[]),O=e.useCallback(()=>{if(!y)return;const e=m.getLevelCards(y.id);e&&(v(e),N([]),k(0),h("playing"),T(new Date),L(0),$(null),S(!1))},[y]),B=e.useCallback(e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-4xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化记忆游戏"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[D&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===x&&!D&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化记忆游戏"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"翻牌匹配相同的文化元素，挑战你的记忆力和文化知识"})]}),U&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:U.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:U.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:u.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最佳时间"}),s.jsx("p",{className:"text-xl font-bold",children:U.bestTimes&&Object.keys(U.bestTimes).length>0?B(Math.min(...Object.values(U.bestTimes))):"--:--"})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:u.map(e=>{const t=U?.completedLevels.includes(e.id)||!1,a=!g||m.isLevelUnlocked(g?.id||"",e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&M(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.gridSize.rows,"x",e.gridSize.cols]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.cards.length/2," 对卡片"]})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",B(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===x&&y&&!D&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsx("div",{className:"mb-4",children:s.jsxs("div",{className:"flex flex-wrap justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium mb-2 md:mb-0",children:y.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:`p-2 rounded-lg ${c?"bg-gray-700":"bg-gray-100"} min-w-[120px]`,children:[s.jsx("span",{className:"text-xs block mb-1",children:"时间"}),s.jsx("span",{className:"font-medium",children:B(_)})]}),s.jsxs("div",{className:`p-2 rounded-lg ${c?"bg-gray-700":"bg-gray-100"} min-w-[120px]`,children:[s.jsx("span",{className:"text-xs block mb-1",children:"已匹配"}),s.jsxs("span",{className:"font-medium",children:[w," / ",y.cards.length/2]})]}),s.jsx("button",{onClick:q,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"})]})]})}),s.jsx("div",{className:"grid gap-2 mb-6 mx-auto",style:{gridTemplateColumns:`repeat(${y.gridSize.cols}, 1fr)`,maxWidth:"600px"},children:f.map(e=>s.jsx(i.div,{className:"aspect-square perspective-1000",onClick:()=>G(e),children:s.jsxs(i.div,{className:"relative w-full h-full cursor-pointer",style:{transformStyle:"preserve-3d",transition:"transform 0.6s"},animate:{rotateY:e.isFlipped||e.isMatched?180:0},transition:{duration:.5},children:[s.jsx(i.div,{className:`absolute w-full h-full backface-hidden rounded-lg flex items-center justify-center transition-all ${c?"bg-gradient-to-br from-red-600 to-purple-600":"bg-gradient-to-br from-blue-500 to-purple-500"} shadow-md`,style:{transform:"rotateY(180deg)",backfaceVisibility:"hidden"},children:e.isMatched?s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},children:s.jsx("i",{className:"fas fa-check-circle text-4xl text-green-500"})}):s.jsxs("div",{className:"flex flex-col items-center justify-center p-2",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover rounded-lg mb-2",ratio:"square",fit:"cover"}),s.jsx("p",{className:"text-sm font-medium text-center",children:e.name})]})}),s.jsx(i.div,{className:`absolute w-full h-full backface-hidden rounded-lg flex items-center justify-center ${c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"} border ${c?"border-gray-600":"border-gray-300"} shadow-md transition-all`,style:{backfaceVisibility:"hidden"},children:s.jsx("div",{className:"text-2xl",children:s.jsx("i",{className:"fas fa-question-circle"})})})]})},e.id))}),s.jsxs("div",{className:"p-4 rounded-lg mb-4 "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h4",{className:"font-medium mb-2",children:"游戏提示"}),s.jsx("p",{className:"text-sm "+(c?"text-gray-300":"text-gray-700"),children:"点击卡片查看文化元素，记住它们的位置，然后找出所有配对的卡片。 配对成功后，你可以看到文化元素的详细信息。"})]})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===x&&y&&U&&!D&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",y.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:U.levelScores[y.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:B(P||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsx("p",{className:"text-xl font-bold",children:"100%"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总配对数"}),s.jsx("p",{className:"text-xl font-bold",children:y.cards.length/2})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:y.reward})]}),s.jsxs("div",{className:"flex flex-wrap justify-center gap-3",children:[s.jsx("button",{onClick:O,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:q,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},x=new class{cards=[];levels=[];gameProgress=new Map;nextCardId=1;nextLevelId=1;constructor(){this.initCards(),this.initLevels()}initCards(){this.cards=[{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Yangliuqing%20New%20Year%20Painting%20traditional%20Chinese%20art",name:"杨柳青年画",description:"中国四大木版年画之一，以色彩鲜艳、构图饱满著称",culturalElement:"传统绘画",category:"天津文化"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Nirenzhang%20clay%20sculpture%20traditional%20Chinese%20art",name:"泥人张彩塑",description:"天津传统民间艺术，以细腻的造型和生动的表情著称",culturalElement:"传统雕塑",category:"天津文化"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Tianjin%20crosstalk%20performance%20traditional%20Chinese%20art",name:"天津相声",description:"中国北方传统曲艺形式，以幽默风趣的对话著称",culturalElement:"传统曲艺",category:"天津文化"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Tianjin%20mahua%20traditional%20Chinese%20snack",name:"天津麻花",description:"天津传统名点，以酥脆香甜著称",culturalElement:"传统美食",category:"天津文化"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Goubuli%20steamed%20buns%20traditional%20Chinese%20food",name:"狗不理包子",description:"天津传统名点，以皮薄馅大、鲜香可口著称",culturalElement:"传统美食",category:"天津文化"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Tianjin%20dialect%20conversation%20illustration",name:"天津方言",description:"天津地区的方言，以幽默风趣、表现力强著称",culturalElement:"方言文化",category:"天津文化"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Beijing%20Opera%20face%20paint%20traditional%20Chinese%20art",name:"京剧脸谱",description:"京剧艺术的重要组成部分，以色彩象征人物性格",culturalElement:"传统戏曲",category:"传统艺术"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20calligraphy%20art%20traditional%20writing",name:"书法艺术",description:"中国传统艺术形式，以毛笔书写汉字为表现手段",culturalElement:"传统书画",category:"传统艺术"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Traditional%20Chinese%20patterns%20cloud%20design",name:"传统纹样",description:"中国传统装饰图案，具有丰富的文化内涵",culturalElement:"传统工艺",category:"传统艺术"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20knot%20traditional%20decorative%20art",name:"中国结",description:"中国传统手工艺品，象征吉祥如意",culturalElement:"传统工艺",category:"传统艺术"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20paper%20cutting%20art%20traditional%20craft",name:"剪纸艺术",description:"中国传统民间艺术，以剪刀或刻刀在纸上剪刻花纹",culturalElement:"传统工艺",category:"传统艺术"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Blue%20and%20white%20porcelain%20traditional%20Chinese%20ceramics",name:"青花瓷",description:"中国传统瓷器品种，以青花为装饰手法",culturalElement:"传统工艺",category:"传统艺术"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20dragon%20symbol%20traditional%20culture",name:"龙",description:"中国传统文化中的祥瑞动物，象征权力和尊贵",culturalElement:"文化符号",category:"文化符号"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20phoenix%20symbol%20traditional%20culture",name:"凤",description:"中国传统文化中的祥瑞动物，象征吉祥和美好",culturalElement:"文化符号",category:"文化符号"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Chinese%20character%20Fu%20symbol%20good%20luck",name:"福字",description:"中国传统文化中的吉祥符号，象征幸福和福气",culturalElement:"文化符号",category:"文化符号"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Traditional%20Chinese%20cloud%20pattern%20design",name:"祥云",description:"中国传统文化中的吉祥图案，象征祥瑞和好运",culturalElement:"文化符号",category:"文化符号"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Bagua%20symbol%20traditional%20Chinese%20philosophy",name:"八卦",description:"中国传统文化中的哲学符号，象征宇宙万物的变化规律",culturalElement:"文化符号",category:"文化符号"},{id:"card-"+this.nextCardId++,imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=512x512&prompt=Taiji%20symbol%20yin%20yang%20traditional%20Chinese%20philosophy",name:"太极",description:"中国传统文化中的哲学符号，象征阴阳对立统一",culturalElement:"文化符号",category:"文化符号"}]}initLevels(){const e=(e,t=2)=>{const s=e.map(e=>this.cards[e-1]),i=[];for(const a of s)for(let e=0;e<t;e++)i.push({...a,id:`${a.id}-copy-${e}`});return i};this.levels=[{id:"level-"+this.nextLevelId++,name:"天津文化入门",description:"了解天津的传统特色文化元素",cards:e([1,2,3,4]),gridSize:{rows:4,cols:4},difficulty:"easy",reward:"解锁天津文化素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20cultural%20heritage%20tourism"},{id:"level-"+this.nextLevelId++,name:"传统艺术探索",description:"探索中国传统艺术形式",cards:e([7,8,9,10,11,12]),gridSize:{rows:6,cols:4},difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁传统纹样素材包",culturalTheme:"中国传统艺术",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20traditional%20art%20collection"},{id:"level-"+this.nextLevelId++,name:"文化符号挑战",description:"挑战识别中国文化符号",cards:e([13,14,15,16,17,18,1,2]),gridSize:{rows:4,cols:8},difficulty:"hard",unlockCondition:{type:"level",value:2},reward:"解锁高级配色方案",culturalTheme:"中国文化符号",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20cultural%20symbols%20collection"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getCards(){return[...this.cards]}getCardById(e){const t=e.split("-copy-")[0];return this.cards.find(e=>e.id===t)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},unlockedHints:3,bestTimes:{},lastPlayed:new Date};this.gameProgress.set(e,t)}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),s}checkMatch(e,t){return e.id.split("-copy-")[0]===t.id.split("-copy-")[0]}calculateScore(e,t,s){const i=10*e,a={easy:.3,medium:.5,hard:.8}[s]||.5,l=Math.max(0,600-t)*a,r={easy:1,medium:1.2,hard:1.5}[s]||1;return Math.round((i+l)*r)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1})}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}shuffleCards(e){const t=[...e];for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t}},h=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,h]=e.useState("menu"),[u,p]=e.useState([]),[y,b]=e.useState(null),[f,v]=e.useState(null),[j,N]=e.useState([]),[w,k]=e.useState([]),[C,S]=e.useState(0),[I,T]=e.useState(0),[_,L]=e.useState(null),[P,$]=e.useState(null),[U,z]=e.useState(!1),[D,H]=e.useState(!1),[M,G]=e.useState([]),[E,q]=e.useState(!0);e.useEffect(()=>{if(d){q(!0);const e=x.getLevels();if(p(e),m){const e=x.getGameProgress(m.id);v(e)}q(!1)}},[d,m]);const O=e.useCallback(e=>{b(e),h("playing"),S(0),T(0),L(new Date),$(null),z(!0),H(!1),G([]),k([]);const t=x.shuffleCards(e.cards).map(e=>({card:e,isFlipped:!1,isMatched:!1,isHinted:!1}));N(t)},[]),B=e.useCallback(e=>{!U||w.length>=2||(N(t=>{const s=[...t];return s[e].isFlipped||s[e].isMatched||(s[e].isFlipped=!0),s}),k(t=>{const s=[...t,j[e]];return 2===s.length&&setTimeout(()=>W(s),1e3),s}))},[U,w,j]),W=e.useCallback(e=>{if(2!==e.length)return;const[s,i]=e;x.checkMatch(s.card,i.card)?(N(e=>{const t=[...e],a=t.findIndex(e=>e.card.id===s.card.id),l=t.findIndex(e=>e.card.id===i.card.id);return-1!==a&&(t[a].isMatched=!0,t[a].isHinted=!1),-1!==l&&(t[l].isMatched=!0,t[l].isHinted=!1),t}),S(e=>e+1),t.success("匹配成功！")):(N(e=>{const t=[...e],a=t.findIndex(e=>e.card.id===s.card.id),l=t.findIndex(e=>e.card.id===i.card.id);return-1!==a&&(t[a].isFlipped=!1,t[a].isHinted=!1),-1!==l&&(t[l].isFlipped=!1,t[l].isHinted=!1),t}),t.error("匹配失败，再试一次！")),k([]),H(!1),G([])},[]),A=e.useCallback(()=>{if(m&&f)if(x.useHint(m.id)){const e=j.filter(e=>!e.isMatched&&!e.isFlipped);if(e.length<2)return void t.info("没有可提示的卡片了！");let s=null,i=null;for(let t=0;t<e.length;t++){for(let a=t+1;a<e.length;a++)if(x.checkMatch(e[t].card,e[a].card)){s=e[t],i=e[a];break}if(s&&i)break}if(s&&i){N(e=>{const t=[...e],a=t.findIndex(e=>e.card.id===s?.card.id),l=t.findIndex(e=>e.card.id===i?.card.id);return-1!==a&&(t[a].isHinted=!0),-1!==l&&(t[l].isHinted=!0),t}),H(!0),G([s,i]),t.success("已显示提示卡片！");const e=x.getGameProgress(m.id);v(e)}}else t.error("提示次数已用完！")},[m,f,j]),R=e.useCallback(()=>{if(!m||!y)return;const e=new Date,s=_?Math.round((e.getTime()-_.getTime())/1e3):0;$(s);const i=x.calculateScore(C,s,y.difficulty);T(i);const a=x.completeLevel(m.id,y.id,i,s);v(a),h("completed"),z(!1),t.success(`关卡完成！得分：${i}`)},[m,y,C,_]);e.useEffect(()=>{if(y&&j.length>0){const e=y.cards.length/2;C===e&&U&&R()}},[C,y,j.length,U,R]);const Q=e.useCallback(e=>{m?x.isLevelUnlocked(m.id,e.id)?O(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m,O]),V=e.useCallback(()=>{h("menu"),b(null),N([]),k([]),S(0),T(0),L(null),$(null),z(!1),H(!1),G([])},[]),F=e.useCallback(()=>{y&&O(y)},[y,O]),Y=e.useCallback(e=>{if(!e)return"00:00";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]),[X,J]=e.useState(0);return e.useEffect(()=>{let e;return _&&U&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-_.getTime())/1e3);J(t)},1e3)),()=>clearInterval(e)},[_,U]),d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{scale:.9,y:50},animate:{scale:1,y:0},exit:{scale:.9,y:50},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-6xl rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"}`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`p-4 border-b ${c?"border-gray-700":"border-gray-200"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化元素连连看"}),s.jsx("button",{onClick:o,className:`p-2 rounded-full ${c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"} transition-colors`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6",children:[E&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!E&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化元素连连看"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"通过匹配相同的文化元素卡片，了解中国传统文化和天津地方特色"})]}),f&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:f.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:f.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:f.unlockedHints})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:u.length})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:u.map(e=>{const t=f?.completedLevels.includes(e.id)||!1,a=!m||x.isLevelUnlocked(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&Q(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.gridSize.rows,"x",e.gridSize.cols]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("span",{className:"text-xs font-medium",children:[e.cards.length/2," 对卡片"]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&y&&!E&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium",children:y.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:V,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:A,disabled:!f||f.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",f?.unlockedHints||0,")"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"匹配进度"}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("span",{className:"font-medium",children:C}),s.jsxs("span",{className:"text-xs",children:["/ ",y.cards.length/2," 对"]})]})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"当前得分"}),s.jsx("span",{className:"font-medium",children:I})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"用时"}),s.jsx("span",{className:"font-medium",children:Y(X)})]})]})]}),s.jsx("div",{className:"flex justify-center mb-6",children:s.jsx("div",{className:"grid gap-2",style:{gridTemplateColumns:`repeat(${y.gridSize.cols}, minmax(60px, 100px))`,gridTemplateRows:`repeat(${y.gridSize.rows}, minmax(60px, 100px))`},children:j.map((e,t)=>s.jsx(i.div,{className:"relative w-full h-full perspective",onClick:()=>B(t),children:s.jsx(i.div,{className:"w-full h-full rounded-lg overflow-hidden cursor-pointer "+(e.isMatched?"opacity-0":"opacity-100"),animate:{opacity:e.isMatched?0:1,scale:e.isMatched?.8:1},transition:{duration:.3},children:s.jsxs(i.div,{className:"relative w-full h-full transition-transform duration-500 transform-style-3d",animate:{rotateY:e.isFlipped?180:0},style:{transformStyle:"preserve-3d"},children:[s.jsx("div",{className:"absolute inset-0 backface-hidden flex items-center justify-center rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),style:{backfaceVisibility:"hidden"},children:s.jsx("i",{className:"fas fa-question text-2xl"})}),s.jsxs("div",{className:`absolute inset-0 backface-hidden flex flex-col items-center justify-center p-2 rounded-lg ${c?"bg-gray-800 border border-gray-700":"bg-white border border-gray-200"} ${e.isHinted?"ring-2 ring-yellow-500":""}`,style:{backfaceVisibility:"hidden",transform:"rotateY(180deg)"},children:[s.jsx(n,{src:e.card.imageUrl,alt:e.card.name,className:"w-full h-24 object-cover rounded mb-2",ratio:"auto",fit:"cover",priority:!0}),s.jsx("span",{className:"text-xs font-medium text-center",children:e.card.name})]})]})})},e.card.id))})})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&y&&f&&!E&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",y.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:I})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:Y(P||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"匹配对数"}),s.jsxs("p",{className:"text-xl font-bold",children:[C," / ",y.cards.length/2]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"历史最佳"}),s.jsx("p",{className:"text-xl font-bold",children:f.bestTimes[y.id]?Y(f.bestTimes[y.id]):"-"})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:y.reward})]}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx("button",{onClick:F,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:V,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},u=Object.freeze(Object.defineProperty({__proto__:null,default:h},Symbol.toStringTag,{value:"Module"})),p="cultural_puzzle_game_progress",y=[{id:"level1",name:"天津之眼",description:"天津地标建筑，世界上唯一建在桥上的摩天轮",imageUrl:"https://images.unsplash.com/photo-1618005198919-d3d4b5a92ead?w=1024&h=768&fit=crop",difficulty:"easy",pieceCount:16,rows:4,cols:4,timeLimit:300,reward:"100积分 + 1个提示",culturalTheme:"天津地标",unlockedHints:2},{id:"level2",name:"古文化街",description:"天津最具代表性的古文化街区，展示天津民俗文化",imageUrl:"https://images.unsplash.com/photo-1549298916-b41d501d3772?w=1024&h=768&fit=crop",difficulty:"medium",pieceCount:25,rows:5,cols:5,timeLimit:480,reward:"150积分 + 2个提示",culturalTheme:"天津民俗",unlockedHints:3},{id:"level3",name:"泥人张彩塑",description:"天津传统民间艺术，国家级非物质文化遗产",imageUrl:"https://images.unsplash.com/photo-1618005198919-d3d4b5a92ead?w=1024&h=768&fit=crop",difficulty:"hard",pieceCount:36,rows:6,cols:6,timeLimit:600,reward:"200积分 + 3个提示",culturalTheme:"天津非遗",unlockedHints:4}],b=e=>{try{const t=localStorage.getItem(p);if(t){const s=JSON.parse(t);if(s[e])return{...s[e],lastPlayed:new Date(s[e].lastPlayed)}}}catch(t){}return{userId:e,completedLevels:[],levelScores:{},totalScore:0,unlockedHints:3,lastPlayed:new Date}},f=e=>{try{const t=localStorage.getItem(p),s=t?JSON.parse(t):{};s[e.userId]={...e,lastPlayed:new Date},localStorage.setItem(p,JSON.stringify(s))}catch(t){}},v=e=>{const t=[],s=100/e.cols,i=100/e.rows;let a=0;for(let l=0;l<e.rows;l++)for(let r=0;r<e.cols;r++)t.push({id:a++,x:100*Math.random(),y:100*Math.random(),width:s,height:i,correctX:r*s,correctY:l*i,isPlaced:!1,imageUrl:e.imageUrl});return(e=>{const t=[...e];for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t})(t)},j=(e,t,s)=>Math.abs(t-e.correctX)<=5&&Math.abs(s-e.correctY)<=5,N=e=>e.every(e=>e.isPlaced),w=(e,t,s,i)=>{const a=1e3*Math.max(0,1-t/e.timeLimit),l=1e3*Math.max(0,1-s/(2*e.pieceCount)),r=50*i,n=Math.round((a+l)/2*{easy:1,medium:1.5,hard:2}[e.difficulty]-r);return Math.max(0,n)},k=()=>y,C=(e,t)=>{const s=b(e);if("level1"===t)return!0;const i=y.findIndex(e=>e.id===t);if(i>0){const e=y[i-1].id;return s.completedLevels.includes(e)}return!1},S=b,I=(e,t,s,i)=>{const a=b(e);if(a.completedLevels.includes(t)||a.completedLevels.push(t),!a.levelScores[t]||s>a.levelScores[t]){a.levelScores[t]=s;const e=Object.values(a.levelScores).reduce((e,t)=>e+t,0);a.totalScore=e}return f(a),a},T=e=>{const t=b(e);return t.unlockedHints>0&&(t.unlockedHints-=1,f(t),!0)},_=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,x]=e.useState("menu"),[h,u]=e.useState([]),[p,y]=e.useState(null),[b,f]=e.useState([]),[_,L]=e.useState(null),[P,$]=e.useState(null),[U,z]=e.useState(null),[D,H]=e.useState(null),[M,G]=e.useState(0),[E,q]=e.useState(0),[O,B]=e.useState(0),[W,A]=e.useState(!1),[R,Q]=e.useState(!0),[V,F]=e.useState(!1),Y=e.useRef(null);e.useEffect(()=>{if(d){Q(!0);try{const e=k();if(u(e),m){const e=S(m.id);$(e)}}catch(e){}finally{Q(!1)}}},[d,m]),e.useEffect(()=>{if(p){const e=v(p);f(e),x("playing"),z(new Date),H(null),G(0),q(0),B(0),A(!1),F(!1)}},[p]),e.useEffect(()=>{let e;return U&&"playing"===g&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-U.getTime())/1e3);G(t)},1e3)),()=>clearInterval(e)},[U,g]);const X=e.useCallback(e=>{m?C(m.id,e.id)?y(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m]),J=e.useCallback((e,t)=>{t.isPlaced||L(t)},[]),K=e.useCallback(e=>{L(null)},[]),Z=e.useCallback(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]),ee=e.useCallback(e=>{if(e.preventDefault(),!_||!Y.current)return;const t=parseInt(e.dataTransfer.getData("text/plain")),s=b.find(e=>e.id===t);if(!s||s.isPlaced)return;const i=Y.current.getBoundingClientRect(),a=(e.clientX-i.left)/i.width*100,l=(e.clientY-i.top)/i.height*100,r=j(s,a,l),n=b.map(e=>e.id===s.id?{...e,x:r?e.correctX:a,y:r?e.correctY:l,isPlaced:r}:e);f(n),q(e=>e+1),N(n)&&te()},[_,b]),te=e.useCallback(()=>{if(!m||!p)return;const e=new Date,s=U?Math.round((e.getTime()-U.getTime())/1e3):0;H(s);const i=w(p,s,E,O),a=I(m.id,p.id,i,s);$(a),x("completed"),t.success(`拼图完成！得分：${i}`)},[m,p,U,E,O]),se=e.useCallback(()=>{if(m&&P&&p)if(T(m.id)){A(!0),B(e=>e+1);const e=S(m.id);$(e),t.success("已显示提示"),setTimeout(()=>{A(!1)},3e3)}else t.error("提示已用完")},[m,P,p]),ie=e.useCallback(()=>{F(e=>!e)},[]),ae=e.useCallback(()=>{x("menu"),y(null),f([]),L(null),z(null),H(null),G(0),q(0),B(0),A(!1),F(!1)},[]),le=e.useCallback(()=>{if(!p)return;const e=v(p);f(e),x("playing"),z(new Date),H(null),G(0),q(0),B(0),A(!1),F(!1)},[p]),re=e.useCallback(e=>{if(!e)return"00:00";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-4xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化拼图游戏"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[R&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!R&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化拼图游戏"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"拼合文化图片，了解天津地方文化和中国传统文化"})]}),P&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:P.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:P.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:P.unlockedHints})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:h.length})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(e=>{const t=P?.completedLevels.includes(e.id)||!1,a=!m||C(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&X(e),children:[s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.pieceCount," 片"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",re(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&p&&b.length>0&&!R&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium",children:p.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:ae,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:ie,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-purple-600 hover:bg-purple-700":"bg-purple-500 hover:bg-purple-600"} text-white`,children:[s.jsx("i",{className:"fas fa-eye mr-1"}),V?"隐藏":"显示","答案"]}),s.jsxs("button",{onClick:se,disabled:!P||P.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",P?.unlockedHints||0,")"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"时间"}),s.jsx("span",{className:"font-medium",children:re(M)})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"移动次数"}),s.jsx("span",{className:"font-medium",children:E})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已完成"}),s.jsxs("span",{className:"font-medium",children:[b.filter(e=>e.isPlaced).length," / ",p.pieceCount]})]})]})]}),s.jsx("div",{className:"mb-6",children:s.jsxs("div",{ref:Y,className:`relative aspect-video rounded-lg overflow-hidden border ${c?"border-gray-700":"border-gray-300"} bg-${c?"gray-800":"gray-100"}`,onDragOver:Z,onDrop:ee,children:[V&&s.jsx("div",{className:"absolute inset-0 opacity-50 z-0",children:s.jsx(n,{src:p.imageUrl,alt:"Solution",className:"w-full h-full object-cover",ratio:"landscape",fit:"cover",priority:!0})}),s.jsx("div",{className:"absolute inset-0 z-0",children:Array.from({length:p.rows}).map((e,t)=>Array.from({length:p.cols}).map((e,i)=>{const a=i/p.cols*100,l=t/p.rows*100,r=100/p.cols,n=100/p.rows;return s.jsx("div",{className:`absolute border border-dashed ${c?"border-gray-600":"border-gray-300"} bg-opacity-10`,style:{left:`${a}%`,top:`${l}%`,width:`${r}%`,height:`${n}%`}},`slot-${t}-${i}`)}))}),b.map(e=>s.jsx(i.div,{className:"absolute cursor-move z-20 shadow-md "+(e.isPlaced?"z-10 opacity-100":"opacity-80 hover:opacity-100"),style:{left:`${e.x}%`,top:`${e.y}%`,width:`${e.width}%`,height:`${e.height}%`,backgroundImage:`url(${e.imageUrl})`,backgroundPosition:`-${e.correctX}% -${e.correctY}%`,backgroundSize:`${100*p.cols}% ${100*p.rows}%`,backgroundRepeat:"no-repeat",border:c?"1px solid #4b5563":"1px solid #e5e7eb",borderRadius:"4px",opacity:e.isPlaced?1:.8},draggable:!e.isPlaced,onDragStart:t=>J(t,e),onDragEnd:K,whileHover:e.isPlaced?{}:{scale:1.05},whileTap:e.isPlaced?{}:{scale:.95},animate:e.isPlaced?{scale:[1,1.1,1],transition:{duration:.3}}:{}},e.id))]})}),s.jsxs("div",{className:"mb-4",children:[s.jsx("h4",{className:"text-sm font-medium mb-2",children:"未放置的碎片"}),s.jsx("div",{className:"p-4 rounded-lg overflow-x-auto "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsx("div",{className:"flex gap-2 min-w-max",children:b.filter(e=>!e.isPlaced).map(e=>s.jsx(i.div,{className:"cursor-move flex-shrink-0 shadow-md "+(c?"border-gray-600":"border-gray-300"),style:{width:"80px",height:"80px",backgroundImage:`url(${e.imageUrl})`,backgroundPosition:`-${e.correctX}% -${e.correctY}%`,backgroundSize:`${100*p.cols}% ${100*p.rows}%`,backgroundRepeat:"no-repeat",border:"1px solid",borderRadius:"4px"},draggable:!0,onDragStart:t=>J(t,e),onDragEnd:K,whileHover:{scale:1.1},whileTap:{scale:.9}},`piece-${e.id}`))})})]}),s.jsx("div",{className:"flex justify-end gap-3",children:s.jsx("button",{onClick:le,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新开始"})})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&p&&P&&null!==D&&!R&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成拼图！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",p.name,"」拼图"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:P.levelScores[p.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:re(D)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"移动次数"}),s.jsx("p",{className:"text-xl font-bold",children:E})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"提示使用"}),s.jsx("p",{className:"text-xl font-bold",children:O})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:p.reward})]}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx("button",{onClick:le,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:ae,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},L=new class{sortItems=[];questions=[];levels=[];gameProgress=new Map;nextItemId=1;nextQuestionId=1;nextLevelId=1;constructor(){this.initSortItems(),this.initQuestions(),this.initLevels()}initSortItems(){this.sortItems=[{id:"item-"+this.nextItemId++,name:"天津鼓楼",content:"天津鼓楼",sortValue:1420,description:"天津鼓楼是天津卫的发源地，始建于明永乐十八年（1420年）",culturalTheme:"天津地方文化",category:"天津建筑"},{id:"item-"+this.nextItemId++,name:"石家大院",content:"石家大院",sortValue:1875,description:"石家大院是清代津门八大家之一石万程第四子石元士的宅第，始建于1875年",culturalTheme:"天津地方文化",category:"天津建筑"},{id:"item-"+this.nextItemId++,name:"天津劝业场",content:"天津劝业场",sortValue:1928,description:"天津劝业场是天津商业的象征，始建于1928年",culturalTheme:"天津地方文化",category:"天津建筑"},{id:"item-"+this.nextItemId++,name:"天津广播电视塔",content:"天津广播电视塔",sortValue:1991,description:"天津广播电视塔又称天塔，建成于1991年，是天津的标志性建筑之一",culturalTheme:"天津地方文化",category:"天津建筑"},{id:"item-"+this.nextItemId++,name:"天津环球金融中心",content:"天津环球金融中心",sortValue:2010,description:"天津环球金融中心又称津塔，建成于2010年，是天津的摩天大楼",culturalTheme:"天津地方文化",category:"天津建筑"},{id:"item-"+this.nextItemId++,name:"天津周大福金融中心",content:"天津周大福金融中心",sortValue:2019,description:"天津周大福金融中心又称津沽棒，建成于2019年，是天津的新地标",culturalTheme:"天津地方文化",category:"天津建筑"},{id:"item-"+this.nextItemId++,name:"春节",content:"春节",sortValue:1,description:"春节是中国最重要的传统节日，农历正月初一",culturalTheme:"中国传统文化",category:"传统节日"},{id:"item-"+this.nextItemId++,name:"元宵节",content:"元宵节",sortValue:15,description:"元宵节又称上元节，农历正月十五",culturalTheme:"中国传统文化",category:"传统节日"},{id:"item-"+this.nextItemId++,name:"清明节",content:"清明节",sortValue:105,description:"清明节是传统祭祖节日，农历三月初五前后",culturalTheme:"中国传统文化",category:"传统节日"},{id:"item-"+this.nextItemId++,name:"端午节",content:"端午节",sortValue:145,description:"端午节又称龙舟节，农历五月初五",culturalTheme:"中国传统文化",category:"传统节日"},{id:"item-"+this.nextItemId++,name:"中秋节",content:"中秋节",sortValue:225,description:"中秋节是传统团圆节日，农历八月十五",culturalTheme:"中国传统文化",category:"传统节日"},{id:"item-"+this.nextItemId++,name:"重阳节",content:"重阳节",sortValue:255,description:"重阳节又称老人节，农历九月初九",culturalTheme:"中国传统文化",category:"传统节日"},{id:"item-"+this.nextItemId++,name:"造纸术",content:"造纸术",sortValue:105,description:"造纸术由东汉蔡伦改进，约公元105年",culturalTheme:"中国传统文化",category:"古代发明"},{id:"item-"+this.nextItemId++,name:"印刷术",content:"印刷术",sortValue:868,description:"雕版印刷术发明于唐朝，约公元868年",culturalTheme:"中国传统文化",category:"古代发明"},{id:"item-"+this.nextItemId++,name:"火药",content:"火药",sortValue:904,description:"火药发明于唐朝末年，约公元904年",culturalTheme:"中国传统文化",category:"古代发明"},{id:"item-"+this.nextItemId++,name:"指南针",content:"指南针",sortValue:1044,description:"指南针发明于北宋，约公元1044年",culturalTheme:"中国传统文化",category:"古代发明"}]}initQuestions(){this.questions=[{id:"question-"+this.nextQuestionId++,title:"天津地标建筑时间排序",description:"请按照建造时间的先后顺序排列以下天津地标建筑",items:this.sortItems.filter(e=>"天津建筑"===e.category),sortType:"asc",explanation:"天津地标建筑的建造时间顺序反映了天津城市发展的历程，从古代的鼓楼到现代的摩天大楼，见证了天津的繁荣发展。",culturalTheme:"天津地方文化",category:"天津建筑"},{id:"question-"+this.nextQuestionId++,title:"中国传统节日时间排序",description:"请按照农历时间的先后顺序排列以下中国传统节日",items:this.sortItems.filter(e=>"传统节日"===e.category),sortType:"asc",explanation:"中国传统节日按照农历时间顺序排列，反映了中国传统文化中对自然节律的观察和尊重。",culturalTheme:"中国传统文化",category:"传统节日"},{id:"question-"+this.nextQuestionId++,title:"中国古代四大发明时间排序",description:"请按照发明时间的先后顺序排列以下中国古代四大发明",items:this.sortItems.filter(e=>"古代发明"===e.category),sortType:"asc",explanation:"中国古代四大发明的出现时间顺序，展示了中国古代科技发展的脉络和成就。",culturalTheme:"中国传统文化",category:"古代发明"}]}initLevels(){this.levels=[{id:"level-"+this.nextLevelId++,name:"天津建筑时间线",description:"了解天津地标建筑的建造时间顺序",questions:[this.questions[0]],gridSize:{rows:4,cols:4},difficulty:"easy",reward:"解锁天津建筑素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20landmark%20buildings%20skyline"},{id:"level-"+this.nextLevelId++,name:"中国传统节日",description:"了解中国传统节日的时间顺序",questions:[this.questions[1]],gridSize:{rows:4,cols:4},difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁中国传统节日素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20traditional%20festivals%20collection"},{id:"level-"+this.nextLevelId++,name:"中国古代发明",description:"了解中国古代四大发明的时间顺序",questions:[this.questions[2]],gridSize:{rows:4,cols:4},difficulty:"hard",unlockCondition:{type:"level",value:2},reward:"解锁中国古代发明素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20ancient%20inventions"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getQuestions(){return[...this.questions]}getQuestionById(e){return this.questions.find(t=>t.id===e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},unlockedHints:3,bestTimes:{},lastPlayed:new Date};this.gameProgress.set(e,t)}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),s}checkSort(e,t){if(t.length!==e.items.length)return!1;for(let s=0;s<t.length-1;s++){const i=t[s],a=t[s+1];if("asc"===e.sortType){if(i.sortValue>a.sortValue)return!1}else if(i.sortValue<a.sortValue)return!1}return!0}calculateQuestionScore(e,t,s){let i=0;return t&&(i=100,s&&s<30?i+=20:s&&s<60&&(i+=10)),i}calculateLevelScore(e,t,s,i){const a=e/t,l=Math.round(100*a),r={easy:.3,medium:.5,hard:.8}[i]||.5,n=60*t,d=Math.max(0,n-s)*r,o={easy:1,medium:1.2,hard:1.5}[i]||1;return Math.round((l+d)*o)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1})}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},P=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,x]=e.useState("menu"),[h,u]=e.useState([]),[p,y]=e.useState(null),[b,f]=e.useState(0),[v,j]=e.useState(null),[N,w]=e.useState([]),[k,C]=e.useState([]),[S,I]=e.useState(!1),[T,_]=e.useState(!1),[P,$]=e.useState(0),[U,z]=e.useState(null),[D,H]=e.useState(null),[M,G]=e.useState(null),[E,q]=e.useState(!1),[O,B]=e.useState(!0),[W,A]=e.useState(0),[R,Q]=e.useState(0);e.useEffect(()=>{if(d){B(!0);try{const e=L.getLevels();if(u(e),m){const e=L.getGameProgress(m.id);z(e)}}catch(e){}finally{B(!1)}}},[d,m]),e.useEffect(()=>{p&&(f(0),j(p.questions[0]),w(p.questions[0].items),C([]),q(!1),_(!1),$(0),x("playing"),H(new Date),G(null),A(0),Q(0),I(!1))},[p]),e.useEffect(()=>{p&&p.questions[b]&&(j(p.questions[b]),w(p.questions[b].items),C([]),q(!1),_(!1),I(!1))},[p,b]),e.useEffect(()=>{let e;return D&&"playing"===g&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-D.getTime())/1e3);A(t)},1e3)),()=>clearInterval(e)},[D,g]),e.useEffect(()=>{p&&"playing"===g&&P>=p.questions.length&&te()},[P,p,g]);const V=e.useCallback(e=>{m?L.isLevelUnlocked(m.id,e.id)?y(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m]),F=e.useCallback((e,t)=>{e.dataTransfer.setData("itemId",t.id)},[]),Y=e.useCallback(e=>{e.dataTransfer.clearData("itemId")},[]),X=e.useCallback(e=>{e.preventDefault()},[]),J=e.useCallback(e=>{e.preventDefault()},[]),K=e.useCallback((e,t)=>{e.preventDefault();const s=e.dataTransfer.getData("itemId");if(!s)return;const i=N.find(e=>e.id===s);i&&(void 0!==t?(w(e=>e.filter(e=>e.id!==s)),C(e=>{const s=[...e];return s.splice(t,0,i),s})):(C(e=>e.filter(e=>e.id!==s)),w(e=>[...e,i])))},[N]),Z=e.useCallback(e=>{N.includes(e)?(w(t=>t.filter(t=>t.id!==e.id)),C(t=>[...t,e])):(C(t=>t.filter(t=>t.id!==e.id)),w(t=>[...t,e]))},[N]),ee=e.useCallback(()=>{if(!v||k.length!==v.items.length)return void t.error("请将所有项排序完成！");I(!0);const e=L.checkSort(v,k);_(e),e?($(e=>e+1),t.success("排序正确！"),setTimeout(()=>{b<(p?.questions.length||0)-1?f(e=>e+1):te(),I(!1)},1500)):(t.error("排序错误，请重新尝试！"),I(!1))},[v,k,b,p]),te=e.useCallback(()=>{if(!m||!p)return;const e=new Date,s=D?Math.round((e.getTime()-D.getTime())/1e3):0;G(s);const i=L.calculateLevelScore(P,p.questions.length,s,p.difficulty),a=L.completeLevel(m.id,p.id,i,s);z(a),x("completed"),t.success(`关卡完成！得分：${i}`)},[m,p,P,D]),se=e.useCallback(()=>{if(m&&U&&v)if(L.useHint(m.id)){q(!0),Q(e=>e+1);const e=L.getGameProgress(m.id);z(e),t.success("已显示提示")}else t.error("提示已用完")},[m,U,v]),ie=e.useCallback(()=>{x("menu"),y(null),j(null),f(0),w([]),C([]),_(!1),$(0),H(null),G(null),q(!1),I(!1),A(0),Q(0)},[]),ae=e.useCallback(()=>{p&&(f(0),j(p.questions[0]),w(p.questions[0].items),C([]),q(!1),_(!1),$(0),x("playing"),H(new Date),G(null),A(0),Q(0),I(!1))},[p]),le=e.useCallback(e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-4xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化元素排序游戏"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[O&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!O&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化元素排序游戏"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"按照时间顺序或逻辑顺序排列文化元素，了解天津地方文化和中国传统文化"})]}),U&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:U.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:U.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:h.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:U.unlockedHints})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(e=>{const t=U?.completedLevels.includes(e.id)||!1,a=!m||L.isLevelUnlocked(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&V(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.questions.length," 题"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",le(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&p&&v&&!O&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsx("div",{className:"mb-4",children:s.jsxs("div",{className:"flex flex-wrap justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium mb-2 md:mb-0",children:p.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:`p-2 rounded-lg ${c?"bg-gray-700":"bg-gray-100"} min-w-[120px]`,children:[s.jsx("span",{className:"text-xs block mb-1",children:"时间"}),s.jsx("span",{className:"font-medium",children:le(W)})]}),s.jsxs("div",{className:`p-2 rounded-lg ${c?"bg-gray-700":"bg-gray-100"} min-w-[120px]`,children:[s.jsx("span",{className:"text-xs block mb-1",children:"进度"}),s.jsxs("span",{className:"font-medium",children:[b+1," / ",p.questions.length]})]}),s.jsx("button",{onClick:ie,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:se,disabled:!U||U.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",U?.unlockedHints||0,")"]})]})]})}),s.jsxs("div",{className:"p-4 rounded-lg mb-4 "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h4",{className:"text-lg font-medium mb-2",children:v.title}),s.jsx("p",{className:"mb-4 "+(c?"text-gray-300":"text-gray-700"),children:v.description}),E&&s.jsx("div",{className:`p-3 rounded-lg mb-4 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:s.jsxs("div",{className:"flex items-start",children:[s.jsx("i",{className:"fas fa-lightbulb text-yellow-500 mt-1 mr-2"}),s.jsxs("p",{className:"text-sm "+(c?"text-yellow-200":"text-yellow-800"),children:["提示：请按照","asc"===v.sortType?"升序":"降序","排列"]})]})}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[s.jsxs("div",{children:[s.jsx("h5",{className:"text-md font-medium mb-3",children:"待排序项"}),s.jsx("div",{className:`min-h-[200px] p-4 rounded-lg border-2 border-dashed ${c?"border-gray-600 bg-gray-800":"border-gray-300 bg-gray-50"} transition-all hover:border-blue-500`,onDragOver:J,onDragEnter:X,onDrop:e=>K(e),children:0===N.length?s.jsx("p",{className:"text-center py-8 "+(c?"text-gray-500":"text-gray-400"),children:"所有项已排序"}):s.jsx("div",{className:"space-y-3",children:N.map(e=>s.jsxs("div",{className:`p-3 rounded-lg cursor-move transition-all ${c?"bg-gray-700 hover:bg-gray-600":"bg-white hover:bg-gray-50"} border ${c?"border-gray-600":"border-gray-200"} hover:shadow-md`,draggable:!0,onClick:()=>Z(e),onDragStart:t=>F(t,e),onDragEnd:Y,children:[s.jsx("h6",{className:"font-medium",children:e.name}),s.jsx("p",{className:"text-xs mt-1 "+(c?"text-gray-400":"text-gray-500"),children:e.content})]},e.id))})})]}),s.jsxs("div",{children:[s.jsx("h5",{className:"text-md font-medium mb-3",children:"已排序项"}),s.jsx("div",{className:`min-h-[200px] p-4 rounded-lg border-2 border-dashed ${c?"border-gray-600 bg-gray-800":"border-gray-300 bg-gray-50"} transition-all hover:border-blue-500`,children:0===k.length?s.jsx("p",{className:"text-center py-8 "+(c?"text-gray-500":"text-gray-400"),children:"拖拽或点击项到此处进行排序"}):s.jsx("div",{className:"space-y-3",children:k.map((e,t)=>s.jsx("div",{className:`p-3 rounded-lg cursor-move transition-all ${c?"bg-gray-700 hover:bg-gray-600":"bg-white hover:bg-gray-50"} border ${c?"border-gray-600":"border-gray-200"} hover:shadow-md`,draggable:!0,onDragStart:t=>F(t,e),onDragEnd:Y,onDragOver:J,onDragEnter:X,onDrop:e=>K(e,t),onClick:()=>Z(e),children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h6",{className:"font-medium",children:e.name}),s.jsx("p",{className:"text-xs mt-1 "+(c?"text-gray-400":"text-gray-500"),children:e.content})]}),s.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center "+(c?"bg-gray-600":"bg-gray-200"),children:t+1})]})},e.id))})})]})]}),S&&T&&s.jsx("div",{className:`p-3 rounded-lg ${c?"bg-green-900 bg-opacity-30":"bg-green-100"} border ${c?"border-green-700":"border-green-200"}`,children:s.jsxs("div",{className:"flex items-start",children:[s.jsx("i",{className:"fas fa-check-circle text-green-500 mt-1 mr-2"}),s.jsxs("div",{children:[s.jsx("h5",{className:"font-medium mb-1",children:"回答正确！"}),s.jsx("p",{className:"text-sm "+(c?"text-green-200":"text-green-800"),children:v.explanation})]})]})}),s.jsx("div",{className:"flex justify-end gap-3",children:s.jsx("button",{onClick:ee,disabled:S||k.length!==v.items.length,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:S?"检查中...":"提交排序"})})]})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&p&&U&&!O&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",p.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:U.levelScores[p.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:le(M||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsx("p",{className:"text-xl font-bold",children:"100%"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总题数"}),s.jsx("p",{className:"text-xl font-bold",children:p.questions.length})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:p.reward})]}),s.jsxs("div",{className:"flex flex-wrap justify-center gap-3",children:[s.jsx("button",{onClick:ae,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:ie,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},$=new class{riddles=[];levels=[];gameProgress=new Map;nextRiddleId=1;nextLevelId=1;constructor(){this.initRiddles(),this.initLevels()}initRiddles(){this.riddles=[{id:"riddle-"+this.nextRiddleId++,title:"天津特产",content:"形如元宝，皮薄馅大，咬一口汤汁四溢，天津名吃人人夸。",hints:["这是天津的传统名吃","它的名字和狗有关","它是一种包子"],answer:"狗不理包子",explanation:'狗不理包子是天津的传统名吃，因其创始人高贵友乳名"狗子"而得名，以皮薄馅大、汤汁鲜美著称。',culturalTheme:"天津地方文化",category:"天津美食",difficulty:"easy"},{id:"riddle-"+this.nextRiddleId++,title:"天津地标",content:"一座铁桥横跨海河，百年历史见证天津变迁。",hints:["这是天津的标志性桥梁","它的名字与一个国家有关","它建于1907年"],answer:"解放桥",explanation:"解放桥原名万国桥，是天津的标志性桥梁，横跨海河，建于1907年，见证了天津的百年变迁。",culturalTheme:"天津地方文化",category:"天津建筑",difficulty:"easy"},{id:"riddle-"+this.nextRiddleId++,title:"天津民俗",content:"正月十五闹花灯，天津特色民俗活动。",hints:["这是天津的传统民俗活动","它在元宵节举行","活动地点在天津的一个著名古文化街"],answer:"杨柳青灯会",explanation:"杨柳青灯会是天津的传统民俗活动，每年元宵节在杨柳青古镇举行，展示精美的花灯和传统文化。",culturalTheme:"天津地方文化",category:"天津民俗",difficulty:"medium"},{id:"riddle-"+this.nextRiddleId++,title:"传统节日",content:"嫦娥奔月的故事与之相关，家家户户吃月饼。",hints:["这是中国的传统节日","它在农历八月十五","与月亮有关"],answer:"中秋节",explanation:"中秋节是中国的传统节日，每年农历八月十五，人们会赏月、吃月饼，嫦娥奔月是与中秋节相关的传说故事。",culturalTheme:"中国传统文化",category:"传统节日",difficulty:"easy"},{id:"riddle-"+this.nextRiddleId++,title:"传统艺术",content:"一支毛笔，一张宣纸，挥洒自如，中国特色绘画。",hints:["这是中国的传统绘画形式","使用水墨作为主要颜料","强调意境和神韵"],answer:"国画",explanation:"国画是中国的传统绘画形式，使用毛笔、宣纸和水墨等工具，强调意境和神韵，是中国传统文化的重要组成部分。",culturalTheme:"中国传统文化",category:"传统艺术",difficulty:"easy"},{id:"riddle-"+this.nextRiddleId++,title:"历史人物",content:'儒家学派创始人，主张"仁"和"礼"。',hints:["他是中国古代思想家","他的弟子记录了他的言行",'他被尊称为"圣人"'],answer:"孔子",explanation:'孔子是儒家学派的创始人，主张"仁"和"礼"，是中国古代伟大的思想家、教育家，被尊称为"圣人"。',culturalTheme:"中国传统文化",category:"历史人物",difficulty:"medium"},{id:"riddle-"+this.nextRiddleId++,title:"传统工艺",content:"以泥为原料，塑造栩栩如生的人物形象。",hints:["这是中国的传统民间工艺",'天津有著名的"泥人张"',"使用泥土作为主要材料"],answer:"泥人",explanation:'泥人是中国的传统民间工艺，以泥土为原料，塑造栩栩如生的人物形象，天津的"泥人张"是其中的代表。',culturalTheme:"中国传统文化",category:"传统工艺",difficulty:"medium"},{id:"riddle-"+this.nextRiddleId++,title:"传统节日",content:"屈原投江的故事与之相关，人们赛龙舟、吃粽子。",hints:["这是中国的传统节日","它在农历五月初五","与一位爱国诗人有关"],answer:"端午节",explanation:"端午节是中国的传统节日，每年农历五月初五，人们会赛龙舟、吃粽子，以纪念爱国诗人屈原。",culturalTheme:"中国传统文化",category:"传统节日",difficulty:"easy"},{id:"riddle-"+this.nextRiddleId++,title:"天津历史",content:'天津古代的名称，意为"天子经过的渡口"。',hints:["这是天津的古称","与明朝皇帝朱棣有关","意为天子经过的渡口"],answer:"天津卫",explanation:'天津卫是天津的古称，意为"天子经过的渡口"，明朝永乐二年（1404年），朱棣为纪念自己在此渡过大运河南下争夺皇位，赐名"天津"。',culturalTheme:"天津地方文化",category:"天津历史",difficulty:"hard"},{id:"riddle-"+this.nextRiddleId++,title:"传统哲学",content:"老子的代表作，蕴含深刻的道家思想。",hints:["这是中国古代哲学著作","作者是老子","全书共81章"],answer:"道德经",explanation:"《道德经》是老子的代表作，蕴含深刻的道家思想，全书共81章，是中国古代哲学的重要经典。",culturalTheme:"中国传统文化",category:"传统哲学",difficulty:"hard"}]}initLevels(){this.levels=[{id:"level-"+this.nextLevelId++,name:"天津文化入门",description:"了解天津的基本文化常识",riddles:this.riddles.filter(e=>"天津地方文化"===e.culturalTheme&&"easy"===e.difficulty),gridSize:{rows:4,cols:4},difficulty:"easy",reward:"解锁天津文化素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20cultural%20heritage"},{id:"level-"+this.nextLevelId++,name:"中国传统文化基础",description:"了解中国传统文化的基本常识",riddles:this.riddles.filter(e=>"中国传统文化"===e.culturalTheme&&"easy"===e.difficulty),gridSize:{rows:4,cols:4},difficulty:"easy",reward:"解锁中国传统文化素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20traditional%20culture%20collection"},{id:"level-"+this.nextLevelId++,name:"天津文化进阶",description:"深入了解天津的文化底蕴",riddles:this.riddles.filter(e=>"天津地方文化"===e.culturalTheme&&"medium"===e.difficulty),gridSize:{rows:4,cols:4},difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁天津文化高级素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20traditional%20culture"},{id:"level-"+this.nextLevelId++,name:"中国传统文化进阶",description:"深入了解中国传统文化的丰富内涵",riddles:this.riddles.filter(e=>"中国传统文化"===e.culturalTheme&&"medium"===e.difficulty),gridSize:{rows:4,cols:4},difficulty:"medium",unlockCondition:{type:"level",value:2},reward:"解锁中国传统文化高级素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20traditional%20art"},{id:"level-"+this.nextLevelId++,name:"文化知识挑战",description:"综合挑战天津文化和中国传统文化知识",riddles:this.riddles.filter(e=>"hard"===e.difficulty),gridSize:{rows:4,cols:4},difficulty:"hard",unlockCondition:{type:"level",value:4},reward:"解锁高级文化素材包",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20cultural%20knowledge%20challenge"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getRiddles(){return[...this.riddles]}getRiddleById(e){return this.riddles.find(t=>t.id===e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},unlockedHints:3,bestTimes:{},lastPlayed:new Date};this.gameProgress.set(e,t)}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),s}checkAnswer(e,t){return t.trim().toLowerCase()===e.answer.trim().toLowerCase()}calculateRiddleScore(e,t,s,i){const a={easy:50,medium:100,hard:150}[e.difficulty];let l=0;return t&&(l=a,s&&s<10?l+=20:s&&s<30&&(l+=10),i&&(l=Math.max(0,l-10*i))),l}calculateLevelScore(e,t,s,i,a){const l=e/t,r=Math.round(100*l),n={easy:.3,medium:.5,hard:.8}[i]||.5,d=60*t,o=Math.max(0,d-s)*n,c={easy:1,medium:1.2,hard:1.5}[i]||1,m=5*a;return Math.round((r+o-m)*c)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1})}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},U=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,x]=e.useState("menu"),[h,u]=e.useState([]),[p,y]=e.useState(null),[b,f]=e.useState(0),[v,j]=e.useState(null),[N,w]=e.useState(""),[k,C]=e.useState(!1),[S,I]=e.useState(!1),[T,_]=e.useState(0),[L,P]=e.useState(null),[U,z]=e.useState(null),[D,H]=e.useState(null),[M,G]=e.useState(0),[E,q]=e.useState(!1),[O,B]=e.useState(!0),[W,A]=e.useState(0),[R,Q]=e.useState(0);e.useEffect(()=>{if(d){B(!0);try{const e=$.getLevels();if(u(e),m){const e=$.getGameProgress(m.id);P(e)}}catch(e){}finally{B(!1)}}},[d,m]),e.useEffect(()=>{p&&(f(0),j(p.riddles[0]),w(""),C(!1),I(!1),_(0),x("playing"),z(new Date),H(null),G(0),q(!1),A(0),Q(0))},[p]),e.useEffect(()=>{p&&p.riddles[b]&&(j(p.riddles[b]),w(""),C(!1),I(!1),G(0),q(!1))},[p,b]),e.useEffect(()=>{let e;return U&&"playing"===g&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-U.getTime())/1e3);A(t)},1e3)),()=>clearInterval(e)},[U,g]),e.useEffect(()=>{p&&"playing"===g&&T>=p.riddles.length&&Y()},[T,p,g]);const V=e.useCallback(e=>{m?$.isLevelUnlocked(m.id,e.id)?y(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m]),F=e.useCallback(()=>{if(!v||""===N.trim())return void t.error("请输入答案！");C(!0);const e=$.checkAnswer(v,N);I(e),e?(_(e=>e+1),t.success("回答正确！"),setTimeout(()=>{b<(p?.riddles.length||0)-1?f(e=>e+1):Y(),C(!1)},1500)):(t.error("回答错误，请重新尝试！"),C(!1))},[v,N,b,p]),Y=e.useCallback(()=>{if(!m||!p)return;const e=new Date,s=U?Math.round((e.getTime()-U.getTime())/1e3):0;H(s);const i=$.calculateLevelScore(T,p.riddles.length,s,p.difficulty,R),a=$.completeLevel(m.id,p.id,i,s);P(a),x("completed"),t.success(`关卡完成！得分：${i}`)},[m,p,T,U,R]),X=e.useCallback(()=>{if(m&&L&&v)if(M>=v.hints.length)t.error("提示已用完");else if($.useHint(m.id)){q(!0),Q(e=>e+1);const e=$.getGameProgress(m.id);P(e),t.success("已显示提示")}else t.error("提示已用完")},[m,L,v,M]),J=e.useCallback(()=>{if(m&&v&&!(M>=v.hints.length-1))if($.useHint(m.id)){G(e=>e+1),Q(e=>e+1);const e=$.getGameProgress(m.id);P(e),t.success("已显示下一个提示")}else t.error("提示已用完")},[m,v,M]),K=e.useCallback(()=>{x("menu"),y(null),j(null),f(0),w(""),I(!1),_(0),z(null),H(null),G(0),q(!1),C(!1),A(0),Q(0)},[]),Z=e.useCallback(()=>{p&&(f(0),j(p.riddles[0]),w(""),I(!1),_(0),x("playing"),z(new Date),H(null),G(0),q(!1),A(0),Q(0),C(!1))},[p]),ee=e.useCallback(e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-2xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化猜谜游戏"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[O&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!O&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化猜谜游戏"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"根据提示猜文化元素、成语或历史人物，了解天津地方文化和中国传统文化"})]}),L&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:L.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:L.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:h.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:L.unlockedHints})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(e=>{const t=L?.completedLevels.includes(e.id)||!1,a=!m||$.isLevelUnlocked(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&V(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.riddles.length," 题"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",ee(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&p&&v&&!O&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsx("div",{className:"mb-4",children:s.jsxs("div",{className:"flex flex-wrap justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium mb-2 md:mb-0",children:p.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs("div",{className:`p-2 rounded-lg ${c?"bg-gray-700":"bg-gray-100"} min-w-[120px]`,children:[s.jsx("span",{className:"text-xs block mb-1",children:"时间"}),s.jsx("span",{className:"font-medium",children:ee(W)})]}),s.jsxs("div",{className:`p-2 rounded-lg ${c?"bg-gray-700":"bg-gray-100"} min-w-[120px]`,children:[s.jsx("span",{className:"text-xs block mb-1",children:"进度"}),s.jsxs("span",{className:"font-medium",children:[b+1," / ",p.riddles.length]})]}),s.jsx("button",{onClick:K,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"})]})]})}),s.jsxs("div",{className:"p-4 rounded-lg mb-4 "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsxs("h4",{className:"text-lg font-medium mb-2",children:["第 ",b+1," 题：",v.title]}),s.jsx("p",{className:"mb-6 text-lg "+(c?"text-gray-300":"text-gray-700"),children:v.content}),E&&v.hints[M]&&s.jsx("div",{className:`p-3 rounded-lg mb-4 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:s.jsxs("div",{className:"flex flex-col",children:[s.jsxs("div",{className:"flex items-center mb-2",children:[s.jsx("i",{className:"fas fa-lightbulb text-yellow-500 mr-2"}),s.jsxs("span",{className:"font-medium "+(c?"text-yellow-200":"text-yellow-800"),children:["提示 ",M+1,"/",v.hints.length]})]}),s.jsx("p",{className:`text-sm ${c?"text-yellow-200":"text-yellow-800"} mb-2`,children:v.hints[M]}),M<v.hints.length-1&&s.jsx("button",{onClick:J,className:"text-xs self-start px-2 py-1 rounded-lg "+(c?"bg-yellow-800 hover:bg-yellow-700 text-yellow-200":"bg-yellow-200 hover:bg-yellow-300 text-yellow-800"),children:"获取下一个提示"})]})}),s.jsxs("div",{className:"mb-6",children:[s.jsxs("div",{className:"flex gap-3",children:[s.jsx("input",{type:"text",placeholder:"请输入答案...",value:N,onChange:e=>w(e.target.value),onKeyPress:e=>"Enter"===e.key&&F(),className:`flex-1 px-4 py-3 rounded-lg ${c?"bg-gray-800 border-gray-700 text-white":"bg-white border-gray-300 text-gray-900"} border focus:outline-none focus:ring-2 focus:ring-blue-500`,disabled:k}),s.jsx("button",{onClick:F,disabled:k||""===N.trim(),className:`px-4 py-3 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:k?"检查中...":"提交"})]}),s.jsx("div",{className:"mt-2 text-right",children:s.jsxs("button",{onClick:X,disabled:E&&M>=v.hints.length-1,className:`text-sm px-3 py-1 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"获取提示 (",L?.unlockedHints||0,")"]})})]}),k&&S&&s.jsx("div",{className:`p-3 rounded-lg ${c?"bg-green-900 bg-opacity-30":"bg-green-100"} border ${c?"border-green-700":"border-green-200"}`,children:s.jsxs("div",{className:"flex items-start",children:[s.jsx("i",{className:"fas fa-check-circle text-green-500 mt-1 mr-2"}),s.jsxs("div",{children:[s.jsx("h5",{className:"font-medium mb-1",children:"回答正确！"}),s.jsx("p",{className:"text-sm "+(c?"text-green-200":"text-green-800"),children:v.explanation})]})]})})]})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&p&&L&&!O&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",p.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:L.levelScores[p.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:ee(D||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsxs("p",{className:"text-xl font-bold",children:[Math.round(T/p.riddles.length*100),"%"]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总题数"}),s.jsx("p",{className:"text-xl font-bold",children:p.riddles.length})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:p.reward})]}),s.jsxs("div",{className:"flex flex-wrap justify-center gap-3",children:[s.jsx("button",{onClick:Z,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:K,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},z=new class{words=[];levels=[];gameProgress=new Map;nextWordId=1;nextLevelId=1;constructor(){this.initWords(),this.initLevels()}initWords(){this.words=[{id:"word-"+this.nextWordId++,word:"天津",pinyin:"tiān jīn",meaning:"中国四大直辖市之一，位于华北平原东北部",culturalTheme:"天津地方文化",category:"地理"},{id:"word-"+this.nextWordId++,word:"津门",pinyin:"jīn mén",meaning:"天津的别称",culturalTheme:"天津地方文化",category:"地理"},{id:"word-"+this.nextWordId++,word:"门脸",pinyin:"mén liǎn",meaning:"天津方言，指店铺的门面",culturalTheme:"天津地方文化",category:"方言"},{id:"word-"+this.nextWordId++,word:"脸谱",pinyin:"liǎn pǔ",meaning:"戏曲演员面部化妆的谱式",culturalTheme:"中国传统文化",category:"传统艺术"},{id:"word-"+this.nextWordId++,word:"谱曲",pinyin:"pǔ qǔ",meaning:"为歌词配上曲子",culturalTheme:"中国传统文化",category:"传统艺术"},{id:"word-"+this.nextWordId++,word:"曲艺",pinyin:"qǔ yì",meaning:"中国传统的说唱艺术",culturalTheme:"中国传统文化",category:"传统艺术"},{id:"word-"+this.nextWordId++,word:"艺术",pinyin:"yì shù",meaning:"用形象来反映现实但比现实有典型性的社会意识形态",culturalTheme:"中国传统文化",category:"传统艺术"},{id:"word-"+this.nextWordId++,word:"术语",pinyin:"shù yǔ",meaning:"各门学科中用以表示严格规定的意义的专门用语",culturalTheme:"中国传统文化",category:"文化常识"},{id:"word-"+this.nextWordId++,word:"语文",pinyin:"yǔ wén",meaning:"语言和文学的简称",culturalTheme:"中国传统文化",category:"文化常识"},{id:"word-"+this.nextWordId++,word:"文学",pinyin:"wén xué",meaning:"以语言文字为工具形象化地反映客观现实的艺术",culturalTheme:"中国传统文化",category:"传统文学"},{id:"word-"+this.nextWordId++,word:"学问",pinyin:"xué wèn",meaning:"系统的知识",culturalTheme:"中国传统文化",category:"文化常识"},{id:"word-"+this.nextWordId++,word:"问题",pinyin:"wèn tí",meaning:"要求回答或解释的题目",culturalTheme:"中国传统文化",category:"文化常识"},{id:"word-"+this.nextWordId++,word:"题材",pinyin:"tí cái",meaning:"构成文学和艺术作品的材料",culturalTheme:"中国传统文化",category:"传统文学"},{id:"word-"+this.nextWordId++,word:"才子",pinyin:"cái zǐ",meaning:"指有才华的男子",culturalTheme:"中国传统文化",category:"历史人物"},{id:"word-"+this.nextWordId++,word:"子孙",pinyin:"zǐ sūn",meaning:"儿子和孙子，泛指后代",culturalTheme:"中国传统文化",category:"文化常识"},{id:"word-"+this.nextWordId++,word:"孙女",pinyin:"sūn nǚ",meaning:"儿子的女儿",culturalTheme:"中国传统文化",category:"文化常识"},{id:"word-"+this.nextWordId++,word:"女儿",pinyin:"nǚ ér",meaning:"女孩子",culturalTheme:"中国传统文化",category:"文化常识"},{id:"word-"+this.nextWordId++,word:"儿歌",pinyin:"ér gē",meaning:"为儿童创作的歌曲",culturalTheme:"中国传统文化",category:"传统艺术"},{id:"word-"+this.nextWordId++,word:"歌唱",pinyin:"gē chàng",meaning:"用唱歌、朗诵等形式颂扬",culturalTheme:"中国传统文化",category:"传统艺术"},{id:"word-"+this.nextWordId++,word:"唱戏",pinyin:"chàng xì",meaning:"表演戏曲",culturalTheme:"中国传统文化",category:"传统艺术"}]}initLevels(){this.levels=[{id:"level-"+this.nextLevelId++,name:"文化入门接龙",description:"了解基本的文化词汇，进行简单的接龙游戏",words:this.words.slice(0,10),difficulty:"easy",reward:"解锁文化词汇素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20cultural%20word%20chain%20game"},{id:"level-"+this.nextLevelId++,name:"天津文化接龙",description:"学习天津文化相关词汇，进行接龙游戏",words:this.words.slice(0,5).concat(this.words.slice(15,20)),difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁天津文化词汇素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20cultural%20word%20chain%20game"},{id:"level-"+this.nextLevelId++,name:"文化词汇挑战",description:"挑战更复杂的文化词汇接龙",words:this.words,difficulty:"hard",unlockCondition:{type:"level",value:2},timeLimit:300,reward:"解锁高级文化词汇素材包",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20cultural%20word%20chain%20challenge"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getWords(){return[...this.words]}getWordById(e){return this.words.find(t=>t.id===e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},bestTimes:{},unlockedHints:3,lastPlayed:new Date};this.gameProgress.set(e,t)}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),s}checkWordChain(e,t){return!(!e||!t)&&e.slice(-1)===t.slice(0,1)}isWordInLevel(e,t){return t.words.some(t=>t.word===e)}calculateLevelScore(e,t,s){const i=10*e,a={easy:.3,medium:.5,hard:.8}[s]||.5,l=20*e,r=Math.max(0,l-t)*a,n={easy:1,medium:1.2,hard:1.5}[s]||1;return Math.round((i+r)*n)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1})}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},D=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,x]=e.useState("menu"),[h,u]=e.useState([]),[p,y]=e.useState(null),[b,f]=e.useState([]),[v,j]=e.useState(""),[N,w]=e.useState(""),[k,C]=e.useState(!1),[S,I]=e.useState(""),[T,_]=e.useState(null),[L,P]=e.useState(null),[$,U]=e.useState(null),[D,H]=e.useState(!0),[M,G]=e.useState(0);e.useEffect(()=>{if(d){H(!0);try{const e=z.getLevels();if(u(e),m){const e=z.getGameProgress(m.id);_(e)}}catch(e){}finally{H(!1)}}},[d,m]),e.useEffect(()=>{if(p){const e=p.words[Math.floor(Math.random()*p.words.length)].word;f([e]),w(e),j(""),C(!1),I(""),x("playing"),P(new Date),U(null),G(0)}},[p]),e.useEffect(()=>{let e;return L&&"playing"===g&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-L.getTime())/1e3);G(t)},1e3)),()=>clearInterval(e)},[L,g]);const E=e.useCallback(e=>{m?z.isLevelUnlocked(m.id,e.id)?y(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m]),q=e.useCallback(e=>{j(e.target.value)},[]),O=e.useCallback(()=>{if(!p||!v.trim()||!N)return;const e=v.trim();if(!z.isWordInLevel(e,p))return void t.error("该词汇不在关卡词汇列表中！");if(!z.checkWordChain(N,e))return void t.error("词汇接龙无效，请确保前一个词的最后一个字作为下一个词的第一个字！");if(b.includes(e))return void t.error("该词汇已经使用过，请换一个！");const s=[...b,e];f(s),w(e),j(""),C(!1),I(""),s.length>=p.words.length/2&&A(),t.success("词汇接龙成功！")},[p,v,N,b]),B=e.useCallback(e=>{"Enter"===e.key&&O()},[O]),W=e.useCallback(()=>{if(m&&T&&p&&N)if(z.useHint(m.id)){const e=p.words.filter(e=>!b.includes(e.word)).filter(e=>e.word.startsWith(N.slice(-1)));if(e.length>0){const t=e[Math.floor(Math.random()*e.length)].word;I(t),C(!0)}const s=z.getGameProgress(m.id);_(s),t.success("已显示提示")}else t.error("提示已用完")},[m,T,p,N,b]),A=e.useCallback(()=>{if(!m||!p)return;const e=new Date,s=L?Math.round((e.getTime()-L.getTime())/1e3):0;U(s);const i=z.calculateLevelScore(b.length,s,p.difficulty),a=z.completeLevel(m.id,p.id,i,s);_(a),x("completed"),t.success(`关卡完成！得分：${i}`)},[m,p,b,L]),R=e.useCallback(()=>{x("menu"),y(null),f([]),w(""),j(""),C(!1),I(""),P(null),U(null),G(0)},[]),Q=e.useCallback(()=>{if(!p)return;const e=p.words[Math.floor(Math.random()*p.words.length)].word;f([e]),w(e),j(""),C(!1),I(""),x("playing"),P(new Date),U(null),G(0)},[p]),V=e.useCallback(e=>{if(!e)return"00:00";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-2xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化词汇接龙"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[D&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!D&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化词汇接龙"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"根据文化主题进行词汇接龙，前一个词的最后一个字作为下一个词的第一个字"})]}),T&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:T.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:T.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:T.unlockedHints})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:h.length})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(e=>{const t=T?.completedLevels.includes(e.id)||!1,a=!m||z.isLevelUnlocked(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&E(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.words.length," 词汇"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",V(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&p&&!D&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium",children:p.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:R,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:W,disabled:!T||T.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",T?.unlockedHints||0,")"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"接龙长度"}),s.jsx("span",{className:"font-medium",children:b.length})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已用时间"}),s.jsx("span",{className:"font-medium",children:V(M)})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"剩余词汇"}),s.jsx("span",{className:"font-medium",children:p.words.length-b.length})]})]})]}),s.jsxs("div",{className:"p-4 rounded-lg mb-4 "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h4",{className:"text-lg font-medium mb-3",children:"词汇链"}),s.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:b.map((e,t)=>s.jsx(i.span,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{duration:.3,delay:.1*t},className:`px-3 py-2 rounded-full ${c?"bg-blue-600":"bg-blue-500"} text-white text-sm font-medium`,children:e},t))}),k&&S&&s.jsx("div",{className:`p-3 rounded-lg mb-4 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:s.jsxs("div",{className:"flex items-start",children:[s.jsx("i",{className:"fas fa-lightbulb text-yellow-500 mt-1 mr-2"}),s.jsxs("p",{className:"text-sm "+(c?"text-yellow-200":"text-yellow-800"),children:["提示：可以接「",S,"」"]})]})}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{type:"text",value:v,onChange:q,onKeyPress:B,placeholder:`请输入以「${N.slice(-1)}」开头的词汇`,className:`flex-grow p-3 rounded-lg ${c?"bg-gray-800 border-gray-700 text-white":"bg-white border-gray-300 text-gray-900"} border focus:outline-none focus:ring-2 focus:ring-blue-500`,disabled:!N}),s.jsx("button",{onClick:O,disabled:!v.trim(),className:`px-4 py-3 rounded-lg transition-colors ${c?"bg-green-600 hover:bg-green-700":"bg-green-500 hover:bg-green-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:"提交"})]})]})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&p&&T&&!D&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",p.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:T.levelScores[p.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:V($||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"接龙长度"}),s.jsx("p",{className:"text-xl font-bold",children:b.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsx("p",{className:"text-xl font-bold",children:"100%"})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:p.reward})]}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx("button",{onClick:Q,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:R,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},H=new class{levels=[];gameProgress=new Map;nextLevelId=1;nextDifferenceId=1;constructor(){this.initLevels()}initLevels(){this.levels=[{id:"level-"+this.nextLevelId++,name:"天津古文化街",description:"找出两张天津古文化街图片的不同之处",originalImageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20ancient%20culture%20street%20with%20traditional%20Chinese%20architecture",modifiedImageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20ancient%20culture%20street%20with%20traditional%20Chinese%20architecture%20and%20a%20red%20lantern%20missing",differences:[{id:"diff-"+this.nextDifferenceId++,position:{x:25,y:30,width:10,height:15},description:"缺少了一个红色灯笼",hint:"在左侧建筑的屋檐下"},{id:"diff-"+this.nextDifferenceId++,position:{x:75,y:45,width:8,height:12},description:"人物穿着不同",hint:"在右侧街道上"},{id:"diff-"+this.nextDifferenceId++,position:{x:45,y:60,width:12,height:10},description:"店铺招牌文字不同",hint:"在中间店铺的招牌上"}],difficulty:"easy",reward:"解锁天津古文化街素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20ancient%20culture%20street%20spot%20the%20difference%20game"},{id:"level-"+this.nextLevelId++,name:"中国传统建筑",description:"找出两张中国传统建筑图片的不同之处",originalImageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Traditional%20Chinese%20architecture%20with%20a%20temple",modifiedImageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Traditional%20Chinese%20architecture%20with%20a%20temple%20and%20different%20roof%20design",differences:[{id:"diff-"+this.nextDifferenceId++,position:{x:45,y:20,width:15,height:15},description:"屋顶设计不同",hint:"在寺庙的屋顶上"},{id:"diff-"+this.nextDifferenceId++,position:{x:30,y:50,width:10,height:12},description:"缺少了一个石狮子",hint:"在寺庙的入口处"},{id:"diff-"+this.nextDifferenceId++,position:{x:65,y:35,width:8,height:10},description:"窗户设计不同",hint:"在右侧建筑的墙上"},{id:"diff-"+this.nextDifferenceId++,position:{x:75,y:60,width:12,height:15},description:"树木数量不同",hint:"在右侧背景中"}],difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁中国传统建筑素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20traditional%20architecture%20spot%20the%20difference%20game"},{id:"level-"+this.nextLevelId++,name:"天津民俗文化",description:"找出两张天津民俗文化图片的不同之处",originalImageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20folk%20culture%20performance",modifiedImageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20folk%20culture%20performance%20with%20different%20costumes%20and%20props",differences:[{id:"diff-"+this.nextDifferenceId++,position:{x:20,y:40,width:12,height:18},description:"表演者服装不同",hint:"在左侧表演者身上"},{id:"diff-"+this.nextDifferenceId++,position:{x:50,y:55,width:10,height:15},description:"道具不同",hint:"在中间表演者手中"},{id:"diff-"+this.nextDifferenceId++,position:{x:70,y:30,width:15,height:12},description:"背景装饰不同",hint:"在右侧背景中"},{id:"diff-"+this.nextDifferenceId++,position:{x:35,y:25,width:8,height:10},description:"头饰不同",hint:"在左侧表演者头上"},{id:"diff-"+this.nextDifferenceId++,position:{x:60,y:65,width:12,height:10},description:"地面图案不同",hint:"在右侧地面上"}],difficulty:"hard",unlockCondition:{type:"level",value:2},timeLimit:300,reward:"解锁天津民俗文化素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20folk%20culture%20spot%20the%20difference%20game"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},bestTimes:{},unlockedHints:3,lastPlayed:new Date};this.gameProgress.set(e,t)}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),s}isDifferenceFound(e,t,s=5){const{x:i,y:a}=t.position,{x:l,y:r}=e;return Math.sqrt(Math.pow(l-i,2)+Math.pow(r-a,2))<=s}calculateLevelScore(e,t,s,i){const a=e/t,l=Math.round(100*a),r={easy:.3,medium:.5,hard:.8}[i]||.5,n=30*t,d=Math.max(0,n-s)*r,o={easy:1,medium:1.2,hard:1.5}[i]||1;return Math.round((l+d)*o)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1})}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},M=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,x]=e.useState("menu"),[h,u]=e.useState([]),[p,y]=e.useState(null),[b,f]=e.useState(new Set),[v,j]=e.useState(null),[N,w]=e.useState(null),[k,C]=e.useState(null),[S,I]=e.useState(!0),[T,_]=e.useState(0),[L,P]=e.useState(!1),[$,U]=e.useState(null),z=e.useRef(null);e.useEffect(()=>{if(d){I(!0);try{const e=H.getLevels();if(u(e),m){const e=H.getGameProgress(m.id);j(e)}}catch(e){}finally{I(!1)}}},[d,m]),e.useEffect(()=>{p&&(f(new Set),P(!1),U(null),x("playing"),w(new Date),C(null),_(0))},[p]),e.useEffect(()=>{let e;return N&&"playing"===g&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-N.getTime())/1e3);_(t)},1e3)),()=>clearInterval(e)},[N,g]);const D=e.useCallback(e=>{m?H.isLevelUnlocked(m.id,e.id)?y(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m]),M=e.useCallback(e=>{if(!p||"playing"!==g)return;const s=e.currentTarget.getBoundingClientRect(),i=z.current?.getBoundingClientRect();if(!i)return;const a=(e.clientX-s.left)/s.width*100,l=(e.clientY-s.top)/s.height*100;for(const r of p.differences)if(!b.has(r.id)&&H.isDifferenceFound({x:a,y:l},r)){f(e=>{const t=new Set(e);return t.add(r.id),t}),t.success(`找到差异点：${r.description}`),b.size+1===p.differences.length&&E();break}},[p,g,b]),G=e.useCallback(()=>{if(m&&v&&p)if(H.useHint(m.id)){const e=p.differences.filter(e=>!b.has(e.id));e.length>0&&(U(e[0]),P(!0),setTimeout(()=>{P(!1),U(null)},3e3));const s=H.getGameProgress(m.id);j(s),t.success("已显示提示，请注意观察提示区域")}else t.error("提示已用完")},[m,v,p,b]),E=e.useCallback(()=>{if(!m||!p)return;const e=new Date,s=N?Math.round((e.getTime()-N.getTime())/1e3):0;C(s);const i=H.calculateLevelScore(b.size,p.differences.length,s,p.difficulty),a=H.completeLevel(m.id,p.id,i,s);j(a),x("completed"),t.success(`关卡完成！得分：${i}`)},[m,p,b,N]),q=e.useCallback(()=>{x("menu"),y(null),f(new Set),w(null),C(null),_(0),P(!1),U(null)},[]),O=e.useCallback(()=>{p&&(f(new Set),P(!1),U(null),x("playing"),w(new Date),C(null),_(0))},[p]),B=e.useCallback(e=>{if(!e)return"00:00";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-4xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化图片找茬"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[S&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!S&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化图片找茬"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"找出两张文化图片的不同之处，了解更多天津地方文化和中国传统文化"})]}),v&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:v.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:v.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:v.unlockedHints})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:h.length})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(e=>{const t=v?.completedLevels.includes(e.id)||!1,a=!m||H.isLevelUnlocked(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&D(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.differences.length," 处差异"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",B(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&p&&!S&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium",children:p.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:q,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:G,disabled:!v||v.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",v?.unlockedHints||0,")"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已找到差异"}),s.jsxs("span",{className:"font-medium",children:[b.size," / ",p.differences.length]})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已用时间"}),s.jsx("span",{className:"font-medium",children:B(T)})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"剩余差异"}),s.jsx("span",{className:"font-medium",children:p.differences.length-b.size})]})]})]}),s.jsxs("div",{ref:z,className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[s.jsxs("div",{className:"relative",children:[s.jsx("h4",{className:"text-center font-medium mb-2",children:"原始图片"}),s.jsxs("div",{className:"relative overflow-hidden rounded-lg border "+(c?"border-gray-700":"border-gray-200"),children:[s.jsx(n,{src:p.originalImageUrl,alt:"原始图片",className:"w-full h-auto cursor-pointer transition-transform hover:scale-105",onClick:M,priority:!0,fit:"contain"}),p.differences.map(e=>b.has(e.id)?s.jsx(i.div,{initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},transition:{type:"spring",stiffness:300,damping:30},className:"absolute border-2 border-green-500 bg-green-500 bg-opacity-20 rounded-lg",style:{left:e.position.x-e.position.width/2+"%",top:e.position.y-e.position.height/2+"%",width:`${e.position.width}%`,height:`${e.position.height}%`},children:s.jsx("div",{className:"absolute -top-2 -right-2 bg-green-500 text-white text-xs px-2 py-0.5 rounded-full",children:s.jsx("i",{className:"fas fa-check"})})},e.id):null)]})]}),s.jsxs("div",{className:"relative",children:[s.jsx("h4",{className:"text-center font-medium mb-2",children:"修改后的图片"}),s.jsxs("div",{className:"relative overflow-hidden rounded-lg border "+(c?"border-gray-700":"border-gray-200"),children:[s.jsx(n,{src:p.modifiedImageUrl,alt:"修改后的图片",className:"w-full h-auto cursor-pointer transition-transform hover:scale-105",onClick:M,priority:!0,fit:"contain"}),p.differences.map(e=>b.has(e.id)?s.jsx(i.div,{initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},transition:{type:"spring",stiffness:300,damping:30},className:"absolute border-2 border-green-500 bg-green-500 bg-opacity-20 rounded-lg",style:{left:e.position.x-e.position.width/2+"%",top:e.position.y-e.position.height/2+"%",width:`${e.position.width}%`,height:`${e.position.height}%`},children:s.jsx("div",{className:"absolute -top-2 -right-2 bg-green-500 text-white text-xs px-2 py-0.5 rounded-full",children:s.jsx("i",{className:"fas fa-check"})})},e.id):L&&$&&e.id===$.id?s.jsx(i.div,{initial:{opacity:0,scale:0},animate:{opacity:1,scale:1},transition:{type:"spring",stiffness:300,damping:30},className:"absolute border-2 border-yellow-500 bg-yellow-500 bg-opacity-20 rounded-lg animate-pulse",style:{left:e.position.x-e.position.width/2+"%",top:e.position.y-e.position.height/2+"%",width:`${e.position.width}%`,height:`${e.position.height}%`},children:s.jsx("div",{className:"absolute -top-2 -right-2 bg-yellow-500 text-white text-xs px-2 py-0.5 rounded-full",children:s.jsx("i",{className:"fas fa-lightbulb"})})},e.id):null)]})]})]})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&p&&v&&!S&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",p.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:v.levelScores[p.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:B(k||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsx("p",{className:"text-xl font-bold",children:"100%"})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"找到差异"}),s.jsxs("p",{className:"text-xl font-bold",children:[p.differences.length," / ",p.differences.length]})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:p.reward})]}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx("button",{onClick:O,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:q,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},G=new class{events=[];levels=[];gameProgress=new Map;nextEventId=1;nextLevelId=1;constructor(){this.initEvents(),this.initLevels()}initEvents(){this.events=[{id:"event-"+this.nextEventId++,title:"天津开埠",year:1860,description:"天津成为中国北方最早开放的通商口岸之一，设立了英、法、美等九国租界，对天津的经济、文化产生了深远影响。",category:"天津历史",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20treaty%20port%20in%201860"},{id:"event-"+this.nextEventId++,title:"天津卫设立",year:1404,description:'明成祖朱棣下令设立天津卫，意为"天子经过的渡口"，天津正式建城。',category:"天津历史",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20wei%20establishment%20in%201404"},{id:"event-"+this.nextEventId++,title:"天津大学成立",year:1895,description:"天津大学前身北洋大学成立，是中国第一所现代大学。",category:"天津教育",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20University%20founded%20in%201895"},{id:"event-"+this.nextEventId++,title:"杨柳青年画兴起",year:1726,description:"杨柳青年画在天津杨柳青镇兴起，成为中国著名的民间木版年画之一。",category:"天津民间艺术",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Yangliuqing%20New%20Year%20paintings"},{id:"event-"+this.nextEventId++,title:"泥人张彩塑诞生",year:1844,description:"天津泥人张彩塑艺术由张明山创立，成为中国著名的民间泥塑艺术。",category:"天津民间艺术",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Niren%20Zhang%20clay%20sculptures"},{id:"event-"+this.nextEventId++,title:"四大发明完成",year:1300,description:"中国古代四大发明（造纸术、印刷术、火药、指南针）在宋元时期基本完成，对世界文明发展产生了深远影响。",category:"中国科技",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Four%20Great%20Inventions%20of%20ancient%20China"},{id:"event-"+this.nextEventId++,title:"孔子诞生",year:-551,description:"儒家学派创始人孔子诞生，其思想对中国乃至东亚文化产生了深远影响。",category:"中国哲学",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Confucius%20birth"},{id:"event-"+this.nextEventId++,title:"京剧形成",year:1790,description:"京剧在乾隆年间形成，融合了徽剧、汉剧等多种戏曲元素，成为中国的国粹。",category:"中国传统艺术",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Beijing%20Opera%20formation"},{id:"event-"+this.nextEventId++,title:"敦煌莫高窟开凿",year:366,description:"敦煌莫高窟开始开凿，历经多个朝代的修建，成为世界上现存规模最大、内容最丰富的佛教艺术地。",category:"中国佛教艺术",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Dunhuang%20Mogao%20Caves"},{id:"event-"+this.nextEventId++,title:"《红楼梦》成书",year:1791,description:"中国古典四大名著之一《红楼梦》正式出版，成为中国文学史上的巅峰之作。",category:"中国文学",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Dream%20of%20the%20Red%20Chamber"},{id:"event-"+this.nextEventId++,title:"兵马俑发现",year:1974,description:'秦始皇兵马俑在陕西西安被发现，被誉为"世界第八大奇迹"。',category:"中国考古",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Terracotta%20Army%20discovery"},{id:"event-"+this.nextEventId++,title:"指南针应用于航海",year:1100,description:"指南针开始广泛应用于航海，促进了中国古代航海事业的发展和海上丝绸之路的繁荣。",category:"中国科技",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Compass%20used%20in%20navigation"}]}initLevels(){this.levels=[{id:"level-"+this.nextLevelId++,name:"天津文化时间轴",description:"了解天津历史上的重要文化事件，按照时间顺序排列",events:this.events.slice(0,5),difficulty:"easy",reward:"解锁天津文化时间轴素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20cultural%20timeline%20game"},{id:"level-"+this.nextLevelId++,name:"中国传统文化时间轴",description:"了解中国历史上的重要文化事件，按照时间顺序排列",events:this.events.slice(5,10),difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁中国传统文化时间轴素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20cultural%20timeline%20game"},{id:"level-"+this.nextLevelId++,name:"文化事件大挑战",description:"挑战更复杂的文化事件时间排序，涵盖天津和中国传统文化",events:this.events,difficulty:"hard",unlockCondition:{type:"level",value:2},timeLimit:300,reward:"解锁高级文化时间轴素材包",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Cultural%20events%20timeline%20challenge"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getEvents(){return[...this.events]}getEventById(e){return this.events.find(t=>t.id===e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},bestTimes:{},unlockedHints:3,lastPlayed:new Date};this.gameProgress.set(e,t)}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),s}checkTimelineOrder(e,t){for(let s=0;s<e.length;s++)if(e[s].id!==t[s].id)return!1;return!0}calculateLevelScore(e,t,s){if(!e)return 0;const i={easy:.3,medium:.5,hard:.8}[s]||.5,a=Math.max(0,30-t)*i,l={easy:1,medium:1.2,hard:1.5}[s]||1;return Math.round((100+a)*l)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1})}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},E=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,x]=e.useState("menu"),[h,u]=e.useState([]),[p,y]=e.useState(null),[b,f]=e.useState([]),[v,j]=e.useState([]),[N,w]=e.useState(null),[k,C]=e.useState(null),[S,I]=e.useState(null),[T,_]=e.useState(!0),[L,P]=e.useState(0),[$,U]=e.useState(!1),[z,D]=e.useState(null);e.useEffect(()=>{if(d){_(!0);try{const e=G.getLevels();if(u(e),m){const e=G.getGameProgress(m.id);w(e)}}catch(e){}finally{_(!1)}}},[d,m]),e.useEffect(()=>{if(p){const e=[...p.events].sort(()=>Math.random()-.5);f(e),j([]),x("playing"),C(new Date),I(null),P(0),U(!1),D(null)}},[p]),e.useEffect(()=>{let e;return k&&"playing"===g&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-k.getTime())/1e3);P(t)},1e3)),()=>clearInterval(e)},[k,g]);const H=e.useCallback(e=>{m?G.isLevelUnlocked(m.id,e.id)?y(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m]),M=e.useCallback((e,t)=>{D(t),"dataTransfer"in e&&(e.dataTransfer.effectAllowed="move")},[]),E=e.useCallback(()=>{D(null)},[]),q=e.useCallback(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]),O=e.useCallback((e,t)=>{if(e.preventDefault(),!z)return;const s=b.filter(e=>e.id!==z.id),i=[...v];i.splice(t,0,z),f(s),j(i),D(null),0===s.length&&A()},[z,b,v]),B=e.useCallback(e=>{if(e.preventDefault(),!z)return;const t=b.filter(e=>e.id!==z.id),s=[...v,z];f(t),j(s),D(null),0===t.length&&A()},[z,b,v]),W=e.useCallback(e=>{const t=v.filter(t=>t.id!==e.id),s=[...b,e];j(t),f(s)},[v,b]),A=e.useCallback(()=>{if(!p)return;const e=[...p.events].sort((e,t)=>e.year-t.year);G.checkTimelineOrder(v,e)?Q():t.error("时间顺序不正确，请重新排列！")},[p,v]),R=e.useCallback(()=>{if(m&&N&&p)if(G.useHint(m.id)){const e=[...p.events].sort((e,t)=>e.year-t.year)[v.length];if(e){const s=b.filter(t=>t.id!==e.id),i=[...v,e];f(s),j(i),t.success(`提示：下一个事件是「${e.title}」`)}const s=G.getGameProgress(m.id);w(s)}else t.error("提示已用完")},[m,N,p,b,v]),Q=e.useCallback(()=>{if(!m||!p)return;const e=new Date,s=k?Math.round((e.getTime()-k.getTime())/1e3):0;I(s);const i=G.calculateLevelScore(!0,s,p.difficulty),a=G.completeLevel(m.id,p.id,i,s);w(a),x("completed"),t.success(`关卡完成！得分：${i}`)},[m,p,k]),V=e.useCallback(()=>{x("menu"),y(null),f([]),j([]),C(null),I(null),P(0),U(!1),D(null)},[]),F=e.useCallback(()=>{if(!p)return;const e=[...p.events].sort(()=>Math.random()-.5);f(e),j([]),x("playing"),C(new Date),I(null),P(0),U(!1),D(null)},[p]),Y=e.useCallback(e=>{if(!e)return"00:00";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-4xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化时间轴"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[T&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!T&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化时间轴"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"将文化事件按照时间顺序排列，了解天津地方文化和中国传统文化的发展脉络"})]}),N&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:N.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:N.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:N.unlockedHints})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:h.length})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(e=>{const t=N?.completedLevels.includes(e.id)||!1,a=!m||G.isLevelUnlocked(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&H(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.events.length," 个事件"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",Y(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&p&&!T&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium",children:p.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:V,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:R,disabled:!N||N.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",N?.unlockedHints||0,")"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已排序事件"}),s.jsxs("span",{className:"font-medium",children:[v.length," / ",p.events.length]})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已用时间"}),s.jsx("span",{className:"font-medium",children:Y(L)})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"剩余事件"}),s.jsx("span",{className:"font-medium",children:p.events.length-v.length})]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s.jsxs("div",{children:[s.jsx("h4",{className:"text-lg font-medium mb-3",children:"待排序事件"}),s.jsx("div",{className:`p-4 rounded-lg border ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} min-h-[300px]`,children:0===b.length?s.jsx("p",{className:"text-center py-8 "+(c?"text-gray-400":"text-gray-500"),children:"所有事件已排序完成！"}):s.jsx("div",{className:"space-y-3",children:b.map(e=>s.jsxs(i.div,{draggable:!0,onDragStart:t=>M(t,e),onDragEnd:E,className:`p-3 rounded-lg cursor-move ${c?"bg-gray-700 hover:bg-gray-600":"bg-gray-50 hover:bg-gray-100"} border ${c?"border-gray-600":"border-gray-200"} transition-all shadow-sm hover:shadow-md`,whileHover:{scale:1.02},whileDrag:{opacity:.7},children:[s.jsx("h5",{className:"font-medium",children:e.title}),s.jsx("p",{className:"text-sm mt-1 "+(c?"text-gray-400":"text-gray-600"),children:e.description})]},e.id))})})]}),s.jsxs("div",{children:[s.jsx("h4",{className:"text-lg font-medium mb-3",children:"已排序事件"}),s.jsx("div",{className:`p-4 rounded-lg border ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} min-h-[300px]`,onDragOver:q,onDrop:B,children:0===v.length?s.jsx("p",{className:"text-center py-8 "+(c?"text-gray-400":"text-gray-500"),children:"将事件从左侧拖拽到这里进行排序"}):s.jsx("div",{className:"space-y-3",children:v.map((e,t)=>s.jsxs("div",{className:`p-3 rounded-lg ${c?"bg-blue-900 bg-opacity-50":"bg-blue-50"} border ${c?"border-blue-700":"border-blue-200"} relative`,onDragOver:q,onDrop:e=>O(e,t),children:[s.jsx("button",{onClick:()=>W(e),className:`absolute top-2 right-2 p-1 rounded-full ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white text-xs transition-colors`,"aria-label":"移除",children:s.jsx("i",{className:"fas fa-times"})}),s.jsx("div",{className:`absolute left-0 top-0 bottom-0 w-1 ${c?"bg-blue-600":"bg-blue-500"} rounded-l-lg`}),s.jsxs("div",{className:"ml-4",children:[s.jsx("div",{className:"inline-block px-2 py-0.5 rounded-full text-xs font-medium mb-1 "+(c?"bg-blue-700 text-blue-200":"bg-blue-100 text-blue-800"),children:e.year>0?`${e.year}年`:`${Math.abs(e.year)} BCE`}),s.jsx("h5",{className:"font-medium",children:e.title}),s.jsx("p",{className:"text-sm mt-1 "+(c?"text-gray-400":"text-gray-600"),children:e.description})]})]},e.id))})})]})]}),0===b.length&&s.jsx("div",{className:"mt-6 flex justify-center",children:s.jsx("button",{onClick:A,className:`px-6 py-3 rounded-lg text-lg font-medium transition-all ${c?"bg-green-600 hover:bg-green-700":"bg-green-500 hover:bg-green-600"} text-white shadow-md hover:shadow-lg`,children:"检查排序顺序"})})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&p&&N&&!T&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",p.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:N.levelScores[p.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:Y(S||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"事件数量"}),s.jsx("p",{className:"text-xl font-bold",children:p.events.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsx("p",{className:"text-xl font-bold",children:"100%"})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:p.reward})]}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx("button",{onClick:F,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:V,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null},q=new class{pairs=[];levels=[];gameProgress=new Map;nextItemId=1;nextPairId=1;nextLevelId=1;constructor(){this.initPairs(),this.initLevels()}initPairs(){const e=[{id:"item-"+this.nextItemId++,text:"狗不理包子",category:"天津美食",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Goubuli%20baozi%20Tianjin%20food"},{id:"item-"+this.nextItemId++,text:"天津传统名吃，以皮薄馅大、味道鲜美著称",category:"天津美食",culturalTheme:"天津地方文化"},{id:"item-"+this.nextItemId++,text:"杨柳青年画",category:"天津民间艺术",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Yangliuqing%20New%20Year%20paintings"},{id:"item-"+this.nextItemId++,text:"天津传统木版年画，以色彩鲜艳、内容丰富著称",category:"天津民间艺术",culturalTheme:"天津地方文化"},{id:"item-"+this.nextItemId++,text:"泥人张彩塑",category:"天津民间艺术",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Niren%20Zhang%20clay%20sculptures"},{id:"item-"+this.nextItemId++,text:"天津传统泥塑艺术，以造型生动、工艺精湛著称",category:"天津民间艺术",culturalTheme:"天津地方文化"},{id:"item-"+this.nextItemId++,text:"天津之眼",category:"天津地标",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Tianjin%20Eye%20ferris%20wheel"},{id:"item-"+this.nextItemId++,text:"天津标志性建筑，世界上唯一建在桥上的摩天轮",category:"天津地标",culturalTheme:"天津地方文化"},{id:"item-"+this.nextItemId++,text:"春节",category:"传统节日",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Chinese%20Spring%20Festival%20celebration"},{id:"item-"+this.nextItemId++,text:'中国最重要的传统节日，俗称"过年"',category:"传统节日",culturalTheme:"中国传统文化"},{id:"item-"+this.nextItemId++,text:"孔子",category:"历史人物",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Confucius%20ancient%20Chinese%20philosopher"},{id:"item-"+this.nextItemId++,text:"儒家学派创始人，中国古代伟大的思想家和教育家",category:"历史人物",culturalTheme:"中国传统文化"},{id:"item-"+this.nextItemId++,text:"造纸术",category:"中国科技",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Papermaking%20ancient%20Chinese%20invention"},{id:"item-"+this.nextItemId++,text:"中国古代四大发明之一，促进了文化传播",category:"中国科技",culturalTheme:"中国传统文化"},{id:"item-"+this.nextItemId++,text:"京剧",category:"传统艺术",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Beijing%20Opera%20performance"},{id:"item-"+this.nextItemId++,text:"中国国粹，融合了唱、念、做、打等多种艺术形式",category:"传统艺术",culturalTheme:"中国传统文化"},{id:"item-"+this.nextItemId++,text:"中秋节",category:"传统节日",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x768&prompt=Mid-Autumn%20Festival%20with%20mooncakes"},{id:"item-"+this.nextItemId++,text:"中国传统节日，赏月、吃月饼是主要习俗",category:"传统节日",culturalTheme:"中国传统文化"}];this.pairs=[{id:"pair-"+this.nextPairId++,item1:e[0],item2:e[1],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[2],item2:e[3],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[4],item2:e[5],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[6],item2:e[7],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[8],item2:e[9],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[10],item2:e[11],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[12],item2:e[13],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[14],item2:e[15],relationship:"是"},{id:"pair-"+this.nextPairId++,item1:e[16],item2:e[17],relationship:"是"}]}initLevels(){this.levels=[{id:"level-"+this.nextLevelId++,name:"天津文化配对",description:"了解天津文化元素及其特点，将相关元素进行配对",pairs:this.pairs.slice(0,4),difficulty:"easy",reward:"解锁天津文化配对素材包",culturalTheme:"天津地方文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Tianjin%20cultural%20pair%20matching%20game"},{id:"level-"+this.nextLevelId++,name:"中国传统文化配对",description:"了解中国传统文化元素及其特点，将相关元素进行配对",pairs:this.pairs.slice(4,9),difficulty:"medium",unlockCondition:{type:"level",value:1},reward:"解锁中国传统文化配对素材包",culturalTheme:"中国传统文化",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Chinese%20cultural%20pair%20matching%20game"},{id:"level-"+this.nextLevelId++,name:"文化配对大挑战",description:"挑战更复杂的文化元素配对，涵盖天津和中国传统文化",pairs:this.pairs,difficulty:"hard",unlockCondition:{type:"level",value:2},timeLimit:300,reward:"解锁高级文化配对素材包",culturalTheme:"综合文化知识",imageUrl:"https://trae-api-sg.mchost.guru/api/ide/v1/text_to_image?image_size=1024x1024&prompt=Cultural%20pair%20matching%20challenge"}]}getLevels(){return[...this.levels]}getLevelById(e){return this.levels.find(t=>t.id===e)}getPairs(){return[...this.pairs]}getPairById(e){return this.pairs.find(t=>t.id===e)}getGameProgress(e){if(!this.gameProgress.has(e)){const t={userId:e,completedLevels:[],totalScore:0,levelScores:{},bestTimes:{},unlockedHints:3,lastPlayed:new Date};this.gameProgress.set(e,t)}return this.gameProgress.get(e)}updateGameProgress(e,t){const s={...this.getGameProgress(e),...t,lastPlayed:new Date};return this.gameProgress.set(e,s),s}checkPairMatch(e,t,s){return s.some(s=>s.item1.id===e&&s.item2.id===t||s.item1.id===t&&s.item2.id===e)}calculateLevelScore(e,t,s,i){const a=e/t,l=Math.round(100*a),r={easy:.3,medium:.5,hard:.8}[i]||.5,n=30*t,d=Math.max(0,n-s)*r,o={easy:1,medium:1.2,hard:1.5}[i]||1;return Math.round((l+d)*o)}completeLevel(e,t,s,i){const a=this.getGameProgress(e),l={...a.bestTimes};(!l[t]||i<l[t])&&(l[t]=i);const r={...a,completedLevels:[...new Set([...a.completedLevels,t])],totalScore:a.totalScore+s,levelScores:{...a.levelScores,[t]:s},bestTimes:l,lastPlayed:new Date};return this.gameProgress.set(e,r),r}useHint(e){const t=this.getGameProgress(e);return t.unlockedHints>0&&(this.updateGameProgress(e,{unlockedHints:t.unlockedHints-1}),!0)}unlockHint(e){const t=this.getGameProgress(e);this.updateGameProgress(e,{unlockedHints:t.unlockedHints+1})}isLevelUnlocked(e,t){const s=this.getLevelById(t);if(!s||!s.unlockCondition)return!0;const i=this.getGameProgress(e),{unlockCondition:a}=s;return"level"===a.type?i.completedLevels.length>=a.value:"score"===a.type&&i.totalScore>=a.value}},O=({isOpen:d,onClose:o})=>{const{isDark:c}=l(),{user:m}=e.useContext(r),[g,x]=e.useState("menu"),[h,u]=e.useState([]),[p,y]=e.useState(null),[b,f]=e.useState([]),[v,j]=e.useState([]),[N,w]=e.useState(new Set),[k,C]=e.useState(null),[S,I]=e.useState(null),[T,_]=e.useState(null),[L,P]=e.useState(!0),[$,U]=e.useState(0),[z,D]=e.useState(!1);e.useEffect(()=>{if(d){P(!0);try{const e=q.getLevels();if(u(e),m){const e=q.getGameProgress(m.id);C(e)}}catch(e){}finally{P(!1)}}},[d,m]),e.useEffect(()=>{if(p){const e=p.pairs.flatMap(e=>[e.item1,e.item2]).sort(()=>Math.random()-.5);f(e),j([]),w(new Set),x("playing"),I(new Date),_(null),U(0),D(!1)}},[p]),e.useEffect(()=>{let e;return S&&"playing"===g&&(e=setInterval(()=>{const e=new Date,t=Math.round((e.getTime()-S.getTime())/1e3);U(t)},1e3)),()=>clearInterval(e)},[S,g]);const H=e.useCallback(e=>{m?q.isLevelUnlocked(m.id,e.id)?y(e):t.error("该关卡尚未解锁！"):t.error("请先登录！")},[m]),M=e.useCallback(e=>{if("playing"===g&&p&&!N.has(e))if(2===v.length)j([e]);else if(v.includes(e))j([]);else{const s=[...v,e];if(j(s),2===s.length){const[e,i]=s;q.checkPairMatch(e,i,p.pairs)?(w(t=>{const s=new Set(t);return s.add(e),s.add(i),s}),j([]),t.success("配对成功！"),N.size+2===b.length&&E()):setTimeout(()=>{j([]),t.error("配对错误，请重新尝试！")},500)}}},[g,p,v,N,b.length]),G=e.useCallback(()=>{if(m&&k&&p)if(q.useHint(m.id)){const e=p.pairs.filter(e=>!N.has(e.item1.id)&&!N.has(e.item2.id));if(e.length>0){const s=e[0];D(!0),setTimeout(()=>{D(!1)},2e3),t.success(`提示：「${s.item1.text}」和「${s.item2.text}」是一对`)}const s=q.getGameProgress(m.id);C(s)}else t.error("提示已用完")},[m,k,p,N]),E=e.useCallback(()=>{if(!m||!p)return;const e=new Date,s=S?Math.round((e.getTime()-S.getTime())/1e3):0;_(s);const i=q.calculateLevelScore(N.size/2,p.pairs.length,s,p.difficulty),a=q.completeLevel(m.id,p.id,i,s);C(a),x("completed"),t.success(`关卡完成！得分：${i}`)},[m,p,N.size,S]),O=e.useCallback(()=>{x("menu"),y(null),f([]),j([]),w(new Set),I(null),_(null),U(0),D(!1)},[]),B=e.useCallback(()=>{if(!p)return;const e=p.pairs.flatMap(e=>[e.item1,e.item2]).sort(()=>Math.random()-.5);f(e),j([]),w(new Set),x("playing"),I(new Date),_(null),U(0),D(!1)},[p]),W=e.useCallback(e=>{if(!e)return"00:00";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},[]);return d?s.jsx(i.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.3},className:"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 overflow-y-auto",onClick:e=>e.target===e.currentTarget&&o(),children:s.jsxs(i.div,{initial:{x:100,opacity:0},animate:{x:0,opacity:1},exit:{x:100,opacity:0},transition:{type:"spring",stiffness:300,damping:30},className:`w-full max-w-4xl max-h-[90vh] rounded-xl overflow-hidden shadow-2xl ${c?"bg-gray-800":"bg-white"} text-${c?"white":"gray-900"} flex flex-col`,onClick:e=>e.stopPropagation(),children:[s.jsxs("div",{className:`sticky top-0 z-10 p-4 border-b ${c?"border-gray-700 bg-gray-800":"border-gray-200 bg-white"} flex justify-between items-center`,children:[s.jsx("h3",{className:"text-xl font-bold",children:"文化配对游戏"}),s.jsx("button",{onClick:o,className:`p-3 rounded-full text-xl ${c?"bg-red-600 hover:bg-red-700":"bg-red-500 hover:bg-red-600"} text-white transition-all shadow-md hover:shadow-lg`,"aria-label":"关闭",children:s.jsx("i",{className:"fas fa-times"})})]}),s.jsxs("div",{className:"p-6 overflow-y-auto flex-grow max-h-[calc(90vh-80px)]",children:[L&&s.jsxs("div",{className:"flex flex-col items-center justify-center py-12",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-red-600 mb-4"}),s.jsx("p",{className:"text-lg",children:"加载游戏数据..."})]}),s.jsx(a,{mode:"wait",children:"menu"===g&&!L&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"text-center mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"欢迎来到文化配对游戏"}),s.jsx("p",{className:c?"text-gray-400":"text-gray-600",children:"将相关的文化元素进行配对，了解天津地方文化和中国传统文化的丰富内涵"})]}),k&&s.jsxs("div",{className:"mb-6 p-4 rounded-lg "+(c?"bg-gray-700":"bg-gray-50"),children:[s.jsx("h3",{className:"text-lg font-medium mb-2",children:"游戏进度"}),s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"已完成关卡"}),s.jsx("p",{className:"text-xl font-bold",children:k.completedLevels.length})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"总得分"}),s.jsx("p",{className:"text-xl font-bold",children:k.totalScore})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"可用提示"}),s.jsx("p",{className:"text-xl font-bold",children:k.unlockedHints})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"关卡总数"}),s.jsx("p",{className:"text-xl font-bold",children:h.length})]})]})]}),s.jsx("h3",{className:"text-lg font-medium mb-4",children:"选择关卡"}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:h.map(e=>{const t=k?.completedLevels.includes(e.id)||!1,a=!m||q.isLevelUnlocked(m.id,e.id);return s.jsxs(i.div,{className:`p-4 rounded-lg border cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${a?"hover:shadow-md":"opacity-50 cursor-not-allowed"}`,whileHover:a?{y:-4}:{},onClick:()=>a&&H(e),children:[e.imageUrl&&s.jsxs("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:[s.jsx(n,{src:e.imageUrl,alt:e.name,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"}),t&&s.jsx("div",{className:"absolute top-2 right-2 bg-green-600 text-white text-xs px-2 py-1 rounded-full",children:"已完成"}),!a&&s.jsx("div",{className:"absolute top-2 right-2 bg-gray-600 text-white text-xs px-2 py-1 rounded-full",children:"未解锁"})]}),s.jsx("h4",{className:"font-medium mb-1",children:e.name}),s.jsx("p",{className:"text-sm mb-2 "+(c?"text-gray-400":"text-gray-600"),children:e.description}),s.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.difficulty.toUpperCase()}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:[e.pairs.length," 对配对"]}),s.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-gray-700":"bg-gray-100"),children:e.culturalTheme})]}),s.jsxs("div",{className:"flex justify-between items-center",children:[e.timeLimit&&s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["限时: ",W(e.timeLimit)]}),s.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full "+(c?"bg-yellow-900 bg-opacity-30 text-yellow-200":"bg-yellow-100 text-yellow-800"),children:["奖励: ",e.reward]})]})]},e.id)})})]},"menu")}),s.jsx(a,{mode:"wait",children:"playing"===g&&p&&!L&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:[s.jsxs("div",{className:"mb-4",children:[s.jsxs("div",{className:"flex justify-between items-center mb-2",children:[s.jsx("h3",{className:"text-lg font-medium",children:p.name}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("button",{onClick:O,className:"px-3 py-1 rounded-lg text-sm transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"返回菜单"}),s.jsxs("button",{onClick:G,disabled:!k||k.unlockedHints<=0,className:`px-3 py-1 rounded-lg text-sm transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white disabled:opacity-50 disabled:cursor-not-allowed`,children:[s.jsx("i",{className:"fas fa-lightbulb mr-1"}),"提示 (",k?.unlockedHints||0,")"]})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已匹配对数"}),s.jsxs("span",{className:"font-medium",children:[N.size/2," / ",p.pairs.length]})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"已用时间"}),s.jsx("span",{className:"font-medium",children:W($)})]}),s.jsxs("div",{className:"p-2 rounded-lg "+(c?"bg-gray-700":"bg-gray-100"),children:[s.jsx("span",{className:"text-xs block mb-1",children:"剩余配对"}),s.jsx("span",{className:"font-medium",children:p.pairs.length-N.size/2})]})]})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:b.map(e=>{const t=v.includes(e.id),a=N.has(e.id),l=z&&p.pairs.some(t=>(t.item1.id===e.id||t.item2.id===e.id)&&!N.has(e.id));return s.jsxs(i.div,{className:`p-4 rounded-lg cursor-pointer transition-all ${c?"border-gray-700":"border-gray-200"} ${t?c?"border-blue-500 bg-blue-900 bg-opacity-30":"border-blue-500 bg-blue-50":a?c?"border-green-500 bg-green-900 bg-opacity-30":"border-green-500 bg-green-50":l?c?"border-yellow-500 bg-yellow-900 bg-opacity-30":"border-yellow-500 bg-yellow-50":c?"bg-gray-700 hover:bg-gray-600":"bg-white hover:bg-gray-50"} shadow-sm hover:shadow-md`,whileHover:{scale:1.02},whileTap:{scale:.98},onClick:()=>M(e.id),children:[e.imageUrl&&s.jsx("div",{className:"relative aspect-video overflow-hidden rounded-lg mb-3",children:s.jsx(n,{src:e.imageUrl,alt:e.text,className:"w-full h-full object-cover transition-transform hover:scale-105",ratio:"landscape",fit:"cover"})}),s.jsx("h5",{className:"font-medium",children:e.text}),s.jsx("p",{className:"text-xs mt-1 "+(c?"text-gray-400":"text-gray-600"),children:e.category})]},e.id)})})]},"playing")}),s.jsx(a,{mode:"wait",children:"completed"===g&&p&&k&&!L&&s.jsxs(i.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},className:"text-center",children:[s.jsx(i.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:260,damping:20},className:"mb-6",children:s.jsx("i",{className:"fas fa-trophy text-6xl text-yellow-500"})}),s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"恭喜完成关卡！"}),s.jsxs("p",{className:"mb-6 "+(c?"text-gray-400":"text-gray-600"),children:["你成功完成了「",p.name,"」关卡"]}),s.jsx("div",{className:"p-4 rounded-lg mb-6 "+(c?"bg-gray-700":"bg-gray-50"),children:s.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"最终得分"}),s.jsx("p",{className:"text-xl font-bold",children:k.levelScores[p.id]||0})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"完成时间"}),s.jsx("p",{className:"text-xl font-bold",children:W(T||0)})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"配对对数"}),s.jsxs("p",{className:"text-xl font-bold",children:[p.pairs.length," / ",p.pairs.length]})]}),s.jsxs("div",{children:[s.jsx("p",{className:"text-sm "+(c?"text-gray-400":"text-gray-600"),children:"正确率"}),s.jsx("p",{className:"text-xl font-bold",children:"100%"})]})]})}),s.jsxs("div",{className:`p-4 rounded-lg mb-6 ${c?"bg-yellow-900 bg-opacity-30":"bg-yellow-100"} border ${c?"border-yellow-700":"border-yellow-200"}`,children:[s.jsx("h3",{className:"font-medium mb-2",children:"获得奖励"}),s.jsx("p",{className:c?"text-yellow-200":"text-yellow-800",children:p.reward})]}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx("button",{onClick:B,className:"px-4 py-2 rounded-lg transition-colors "+(c?"bg-gray-700 hover:bg-gray-600":"bg-gray-100 hover:bg-gray-200"),children:"重新挑战"}),s.jsx("button",{onClick:O,className:`px-4 py-2 rounded-lg transition-colors ${c?"bg-blue-600 hover:bg-blue-700":"bg-blue-500 hover:bg-blue-600"} text-white`,children:"返回关卡选择"})]})]},"completed")})]})]})}):null};export{c as C,g as a,h as b,_ as c,P as d,U as e,D as f,M as g,E as h,O as i,u as j};
