import{g as e,r as t,j as r}from"./vendor-react-7rlDZYVK.js";function a(e,t={}){if(!e)return"";try{if(e.startsWith("data:"))return e;if(e.startsWith("/"))return e;if(e.includes("trae-api"))return e;const t=["unsplash.com","picsum.photos","images.pexels.com","pixabay.com","cdn.pixabay.com","i.imgur.com","imgur.com"];for(const r of t)if(e.includes(r))return e;if(e.includes("jinmalab.tech/proxy?url="))try{return new URL(e).searchParams.get("url")||e}catch(r){return e}return e}catch(r){return e}}const i=new class{cache=new Map;preloadQueue=[];isPreloading=!1;maxCacheSize=52428800;currentCacheSize=0;cacheTTL=18e5;constructor(){"undefined"!=typeof window&&(this.cleanupExpiredCache(),setInterval(()=>this.cleanupExpiredCache(),3e5))}cleanupExpiredCache(){const e=Date.now(),t=[];for(const[r,a]of this.cache)e-a.timestamp>this.cacheTTL&&t.push(r);t.forEach(e=>{const t=this.cache.get(e);t&&(this.currentCacheSize-=t.size),this.cache.delete(e)}),t.length>0&&performance.mark("image_cache_cleanup",{detail:{removedCount:t.length}})}evictLRU(){if(this.currentCacheSize<=this.maxCacheSize)return;const e=Array.from(this.cache.entries()).sort((e,t)=>e[1].timestamp-t[1].timestamp);let t=0;for(const[r,a]of e){if(this.currentCacheSize<=.8*this.maxCacheSize)break;this.currentCacheSize-=a.size,this.cache.delete(r),t++}t>0&&performance.mark("image_cache_evict",{detail:{evictedCount:t}})}async loadImage(e){const t=performance.now();try{const r=await fetch(e,{cache:"force-cache",mode:"no-cors"}),a=await r.blob(),i=performance.now()-t,s={src:e,blob:a,timestamp:Date.now(),size:a.size,loadTime:i,error:!1};return this.evictLRU(),this.currentCacheSize+a.size<=this.maxCacheSize&&(this.cache.set(e,s),this.currentCacheSize+=a.size),performance.mark("image_load",{detail:{src:e,loadTime:i,size:a.size,cached:!1}}),a}catch(r){const a=performance.now()-t;return this.cache.set(e,{src:e,blob:null,timestamp:Date.now(),size:0,loadTime:a,error:!0}),performance.mark("image_load_error",{detail:{src:e,loadTime:a,error:r}}),null}}getCachedImage(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.cacheTTL?(this.cache.delete(e),this.currentCacheSize-=t.size,null):(performance.mark("image_cache_hit",{detail:{src:e,loadTime:t.loadTime}}),t.blob):null}async getOrLoadImage(e){const t=this.getCachedImage(e);return null!==t?t:this.loadImage(e)}preloadImage(e,t="medium",r){const a={src:e,priority:t,callback:r};"critical"===t?this.preloadQueue.unshift(a):this.preloadQueue.push(a),this.isPreloading||this.processPreloadQueue()}async processPreloadQueue(){if(0===this.preloadQueue.length)return void(this.isPreloading=!1);this.isPreloading=!0;const e=this.preloadQueue.shift();if(this.getCachedImage(e.src))return e.callback?.(!0),void this.processPreloadQueue();try{await this.loadImage(e.src),e.callback?.(!0)}catch(t){e.callback?.(!1)}this.processPreloadQueue()}preloadImages(e,t="medium"){e.forEach(e=>this.preloadImage(e,t))}clearCache(){this.cache.clear(),this.currentCacheSize=0,performance.mark("image_cache_clear")}getCacheStats(){return{size:this.currentCacheSize,count:this.cache.size,maxSize:this.maxCacheSize,usage:this.currentCacheSize/this.maxCacheSize*100}}isCached(e){const t=this.cache.get(e);return!(!t||Date.now()-t.timestamp>this.cacheTTL&&(this.cache.delete(e),this.currentCacheSize-=t.size,1))}};let s=null,c=new Map;const n=e.memo(({src:e,alt:n,placeholder:o,placeholderColor:l="#f0f0f0",blurPlaceholder:u,className:d,onLoad:m,onError:h,ratio:p="auto",fit:g="cover",position:f,priority:w=!1,quality:b="medium",fallbackSrc:y,disableFallback:I=!1,progressive:x=!0,blurSize:v=10,loadingAnimation:j="fade",responsive:C=!0,responsiveWidths:z=[320,640,1024,1280,1600],format:S,autoFormat:k=!0,formats:N=["webp","avif"],responsiveSizes:M=[320,640,1024,1600,2048],processingOptions:L={},...P})=>{const[T,Z]=t.useState(!1),[H,E]=t.useState(!1),[D,R]=t.useState(!1),[$,G]=t.useState(0),A=t.useRef(null),B=t.useRef(null);t.useRef(null);const W="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iMTAwIiBmaWxsPSIjZmZmZmZmIi8+CjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNzAiIGZpbGw9IiM2NjY2NjYiLz4KPHN2ZyB4PSI3MCIgeT0iNzAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgZmlsbD0ibm9uZSI+CjxyZWN0IHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgZmlsbD0id2hpdGUiLz4KPHJlY3QgeD0iODAiIHk9IjgwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNkY2RjZGMiLz4KPHJlY3QgeD0iOTAuNSIgeT0iOTEiIHdpZHRoPSIxOSIgaGVpZ2h0PSIxOCIgc3Ryb2tlPSIjNzc3Nzc3IiBzdHJva2Utb3BhY2l0eT0iMC41IiBzdHJva2Utd2lkdGg9IjIiLz4KPC9zdmc+Cjwvc3ZnPg==",_=t.useMemo(()=>{if(!e||""===e.trim())return y||W;if(e.includes("/api/proxy/trae-api/api/ide/v1/text_to_image")||e.includes("trae-api-sg.mchost.guru"))return e;if(I)return e;try{const t=a(e,{});return t&&"string"==typeof t&&""!==t.trim()?t:e}catch(t){return e||y||W}},[e,y,I,b,C,k,S,L]),Q=t.useMemo(()=>H?y||W:_&&""!==_.trim()?_:y||W,[H,_,y,W]),O=t.useMemo(()=>{var t,r;if(C&&!I)return r=z,((t=e)&&r&&0!==r.length?(function(){if("undefined"==typeof window)return!0;try{const e=new Image;return void 0!==e.srcset?.includes?.("webp")||window.createImageBitmap}catch{return!1}}(),r.map(e=>{try{return`${a(t,{})||t} ${e}w`}catch(r){return`${t} ${e}w`}}).join(", ")):"")||void 0},[e,C,I,z,b]),Y=t.useMemo(()=>{if(C)return"(max-width: 640px) calc(100vw - 2rem), (max-width: 1024px) calc(50vw - 2rem), (max-width: 1280px) calc(33vw - 2rem), calc(25vw - 2rem)"},[C]),U=t.useMemo(()=>e.startsWith("data:image/svg+xml"),[e]),J=t.useRef(null),K=e=>{"undefined"!=typeof window&&window.performance&&performance.now()},V=e=>{if(K(),h&&h(),!I&&(E(!0),Z(!1),$<5)){const e=1e3*Math.pow(2,$),t=500*Math.random();setTimeout(()=>{G(e=>e+1),E(!1),Z(!1);const e=A.current;e&&(e.src="",setTimeout(()=>{e.src=_,J.current=performance.now()},0))},e+t)}};return t.useEffect(()=>{D&&(J.current=performance.now(),K())},[D]),t.useEffect(()=>{Z(U),E(!1),G(0)},[e,U]),t.useEffect(()=>{if("undefined"==typeof window)return;const e=()=>{if(H&&(Z(!1),E(!1),G(0),D)){const e=A.current;e&&(e.src="",setTimeout(()=>{e.src=_,J.current=performance.now()},0))}};return window.addEventListener("online",e),navigator.onLine&&H&&e(),()=>{window.removeEventListener("online",e)}},[H,D,_]),t.useEffect(()=>{if(!w){if(!s&&"IntersectionObserver"in window&&(s=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=c.get(e.target);t&&(t(),c.delete(e.target),s?.unobserve(e.target))}})},{rootMargin:"500px",threshold:.01})),!B.current){const e=setTimeout(()=>{if(B.current){const e=B.current.getBoundingClientRect();e.top<window.innerHeight+500&&e.bottom>-500||!s?R(!0):(c.set(B.current,()=>R(!0)),s.observe(B.current))}else R(!0)},100);return()=>clearTimeout(e)}{const e=B.current.getBoundingClientRect();e.top<window.innerHeight+500&&e.bottom>-500?R(!0):s?(c.set(B.current,()=>R(!0)),s.observe(B.current)):R(!0)}return()=>{B.current&&(c.delete(B.current),s?.unobserve(B.current))}}R(!0)},[w]),t.useEffect(()=>{"undefined"!=typeof window&&w&&(i.preloadImage(_,"critical",e=>{}),(()=>{const e=new Image;e.src=_,O&&(e.srcset=O)})(),"undefined"!=typeof fetch&&fetch(_,{mode:"no-cors",cache:"force-cache"}).catch(()=>{}))},[w,_,O,n]),r.jsx("div",{className:`relative ${d}`,ref:B,children:r.jsxs("div",{className:"relative overflow-hidden",style:{width:"100%",height:"100%",...!P.width&&!P.height&&{aspectRatio:"square"===p?"1 / 1":"landscape"===p?"16 / 9":"portrait"===p?"4 / 5":void 0}},children:[!T&&!H&&!I&&(()=>{if("string"==typeof o)switch(o){case"blur":return u?r.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:r.jsx("img",{src:u,alt:n,className:"w-full h-full object-cover filter blur-md transition-filter duration-300","aria-hidden":"true",loading:"eager"})}):null;case"color":return r.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{backgroundColor:l}});case"skeleton":return r.jsx("div",{className:"absolute inset-0 pointer-events-none bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 dark:from-gray-800 dark:via-gray-700 dark:to-gray-800 animate-pulse"});default:return null}return null})(),D&&r.jsx("img",{ref:A,src:Q,alt:n,className:(()=>{const e=`w-full h-full object-${g} ${f?`object-${f}`:""} ${"fade"===j?"transition-opacity duration-500 ease-in-out":"scale"===j?"transition-all duration-500 ease-in-out transform":"blur"===j?"transition-all duration-700 ease-in-out":"transition-opacity duration-500 ease-in-out"}`;return I?`${e} opacity-100`:T?"fade"===j?`${e} opacity-100`:"scale"===j?`${e} opacity-100 scale-100`:"blur"===j?`${e} opacity-100 blur-0`:`${e} opacity-100`:H||"fade"===j?`${e} opacity-0`:"scale"===j?`${e} opacity-0 scale-95`:"blur"===j?`${e} opacity-100 blur-sm`:`${e} opacity-0`})(),onLoad:()=>{A.current&&0===A.current.naturalWidth?V():(Z(!0),E(!1),K(),m&&m())},onError:V,loading:w?"eager":"lazy",srcSet:O,sizes:Y,...P}),D&&!T&&!H&&!I&&r.jsx("div",{className:"absolute inset-0 z-10 flex items-center justify-center bg-gradient-to-br from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-800",children:r.jsx("div",{className:"w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"})}),H&&!I&&r.jsx("div",{className:"absolute inset-0 z-20 w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900",children:r.jsxs("div",{className:"text-center p-4",children:[r.jsx("div",{className:"mb-3",children:r.jsx("svg",{className:"w-16 h-16 mx-auto text-gray-400 dark:text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1,d:"M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"})})}),r.jsx("p",{className:"mb-4 text-sm text-gray-600 dark:text-gray-300",children:"图片加载失败"}),r.jsxs("button",{onClick:()=>{Z(!1),E(!1),G(0);const e=A.current;e&&(e.src="",setTimeout(()=>{e.src=_},0))},className:"px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white transition-colors flex items-center justify-center gap-2 mx-auto","aria-label":"重新加载图片",children:[r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),r.jsx("span",{children:"重新加载"})]}),$>=3&&r.jsx("p",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400",children:"已自动重试3次，请检查网络连接"})]})})]})})});n.displayName="LazyImage";export{n as L,a as p};
